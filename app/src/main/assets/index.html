<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0d0d0d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ">
<title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–æ–ª–ª–µ–¥–∂–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0d0d;--surface:#161616;--surface2:#1f1f1f;--surface3:#2a2a2a;
  --accent:#e87722;--accent2:#c45f0a;--text:#f0ede8;--muted:#6b6762;
  --success:#4a9e5c;--danger:#c94f4f;--r:16px;--rb:10px;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Geologica',sans-serif;overflow:hidden}

.screen{
  position:absolute;inset:0;display:flex;flex-direction:column;
  padding-top:var(--safe-top);padding-bottom:var(--safe-bot);overflow:hidden;
  opacity:0;pointer-events:none;transform:translateY(18px) translateZ(0);
  transition:opacity .2s cubic-bezier(.4,0,.2,1),transform .2s cubic-bezier(.4,0,.2,1);
  will-change:opacity,transform;backface-visibility:hidden;-webkit-backface-visibility:hidden
}
.screen.active{opacity:1;pointer-events:all;transform:none}
.screen.exit-left{opacity:0;transform:translateX(-28px) translateZ(0);transition:opacity .15s ease-in,transform .15s ease-in}
.screen.exit-right{opacity:0;transform:translateX(28px) translateZ(0);transition:opacity .15s ease-in,transform .15s ease-in}

.body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 18px}
.body::-webkit-scrollbar{display:none}
*::-webkit-scrollbar{display:none!important;width:0!important;height:0!important}
*{scrollbar-width:none!important}

.hdr{
  padding:14px 18px 12px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;
  background:var(--surface)
}
.hdr-back{
  background:var(--surface2);border:none;color:var(--accent);
  width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;
  display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;flex-shrink:0
}
.hdr-title{font-size:16px;font-weight:700;flex:1;letter-spacing:-.01em}
.hdr-sub{font-size:11px;color:var(--muted);margin-top:2px;font-weight:400}

.home-hero{
  padding:44px 20px 28px;text-align:center;position:relative
}
.home-hero::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:240px;height:240px;border-radius:50%;
  background:radial-gradient(circle,color-mix(in srgb,var(--accent) 12%,transparent) 0%,transparent 70%);
  pointer-events:none
}
.hero-title{font-size:38px;font-weight:800;color:var(--accent);letter-spacing:-.03em;line-height:1.1;
  text-shadow:0 0 20px color-mix(in srgb,var(--accent) 55%,transparent),
              0 0 60px color-mix(in srgb,var(--accent) 22%,transparent),
              0 0 120px color-mix(in srgb,var(--accent) 10%,transparent)}

.section-label{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:8px;margin-top:2px}

.inp{
  width:100%;background:var(--surface2);border:1.5px solid var(--surface3);
  border-radius:var(--rb);color:var(--text);font-family:inherit;
  font-size:14px;padding:13px 14px;outline:none;
  transition:border-color .18s,box-shadow .18s
}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 18%,transparent)}
.inp::placeholder{color:var(--muted)}

.btn{
  width:100%;border:none;border-radius:var(--rb);font-family:inherit;
  font-size:14px;font-weight:700;padding:15px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  position:relative;overflow:hidden;letter-spacing:.01em;
  transition:transform .12s,box-shadow .12s
}
.btn:active{transform:scale(.97)}
.btn-accent{background:var(--accent);color:#fff;box-shadow:0 4px 20px color-mix(in srgb,var(--accent) 35%,transparent)}
.btn-accent:active{box-shadow:0 2px 8px color-mix(in srgb,var(--accent) 22%,transparent)}
.btn-accent2{background:var(--accent2);color:#fff;box-shadow:0 4px 20px color-mix(in srgb,var(--accent2) 30%,transparent)}
.btn-surface{background:var(--surface2);color:var(--text)}
.btn-surface3{background:var(--surface3);color:var(--accent)}
.btn-success{background:var(--success);color:#fff;box-shadow:0 4px 16px rgba(74,158,92,.25)}
.btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 16px rgba(201,79,79,.25)}

.ripple{
  position:absolute;border-radius:50%;
  background:rgba(255,255,255,.2);
  transform:scale(0);animation:ripple-anim .55s ease-out forwards;
  pointer-events:none
}
@keyframes ripple-anim{to{transform:scale(4);opacity:0}}
[data-theme="bw"] .btn-accent,[data-theme="bw"] .btn-accent2,
[data-theme="win11"] .btn-accent,[data-theme="win11"] .btn-accent2,
[data-theme="amoled"] .btn-accent,[data-theme="amoled"] .btn-accent2,
[data-theme="pixel"] .btn-accent,[data-theme="pixel"] .btn-accent2,
[data-theme="aero"] .btn-accent,[data-theme="aero"] .btn-accent2{color:#000}

.status{font-size:12px;color:var(--muted);text-align:center;min-height:18px;line-height:18px}
.progress{height:2px;background:var(--surface3);border-radius:1px;overflow:hidden;margin:6px 0}
.progress-bar{height:100%;background:var(--accent);width:0;border-radius:1px;transition:width .35s cubic-bezier(.4,0,.2,1)}
.sep{height:1px;background:rgba(255,255,255,.06);margin:14px 0}

.list{display:flex;flex-direction:column;gap:7px}
.list-item{
  background:var(--surface2);border-radius:var(--rb);padding:14px 16px;
  cursor:pointer;display:flex;align-items:center;justify-content:space-between;
  font-size:14px;position:relative;overflow:hidden;
  border:1.5px solid transparent;
  transition:border-color .15s,background .15s
}
.list-item:active{background:var(--surface3)}
.list-item.selected{
  background:color-mix(in srgb,var(--accent) 15%,transparent);
  border-color:color-mix(in srgb,var(--accent) 70%,transparent);
  box-shadow:0 0 0 1px color-mix(in srgb,var(--accent) 40%,transparent),
             0 0 18px color-mix(in srgb,var(--accent) 45%,transparent),
             0 0 50px color-mix(in srgb,var(--accent) 20%,transparent)
}
.list-item.selected .item-name{
  color:var(--accent);
  text-shadow:0 0 8px color-mix(in srgb,var(--accent) 90%,transparent),
              0 0 20px color-mix(in srgb,var(--accent) 60%,transparent),
              0 0 50px color-mix(in srgb,var(--accent) 30%,transparent)
}
.list-item .item-name{font-weight:600;flex:1;line-height:1.3}
.list-item .item-sub{font-size:11px;color:var(--muted);margin-top:2px;font-weight:400}
.list-item .item-arrow{color:var(--muted);font-size:18px;margin-left:8px;flex-shrink:0}

.search-wrap{position:relative}
.search-wrap .inp{padding-left:40px}
.search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:15px;pointer-events:none}

.sched-header{
  padding:16px 18px 14px;background:var(--surface);
  border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0
}
.sched-group{font-size:24px;font-weight:800;color:var(--accent);letter-spacing:-.02em}
.sched-date{font-size:11px;color:var(--muted);margin-top:3px}

.pair-card{
  background:var(--surface2);border-radius:var(--r);
  margin-bottom:9px;overflow:hidden;
  border:1.5px solid var(--surface3);
  border-left:3px solid var(--surface3)
}
.pair-card.has-subject{border-left-color:var(--accent2)}
.pair-card.is-now{border-left-color:var(--accent);background:color-mix(in srgb,var(--accent) 10%,transparent);border-color:color-mix(in srgb,var(--accent) 30%,transparent)}
.pair-card.is-next{border-left-color:var(--success)}

.pair-top{display:flex;align-items:flex-start;padding:13px 14px 8px;gap:10px}
.pair-num{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--muted);min-width:26px;text-transform:uppercase;padding-top:2px;flex-shrink:0}
.pair-subject-wrap{flex:1;min-width:0;display:flex;flex-direction:column;gap:5px}
.pair-subject{font-size:14px;font-weight:700;line-height:1.35;word-break:break-word;letter-spacing:-.01em}
.pair-subject.empty{color:var(--muted);font-weight:400;font-style:italic}
.pair-remain{font-size:11px;color:var(--muted);flex-shrink:0;padding-top:3px;font-family:'JetBrains Mono',monospace;white-space:nowrap}

.now-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:var(--accent);color:#fff;
  font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;
  letter-spacing:.04em;text-transform:uppercase;align-self:flex-start
}
.next-badge{background:var(--success)}

.pair-times{padding:0 14px 12px 50px;display:flex;flex-direction:column;gap:5px}
.pair-time-row{display:flex;align-items:center;gap:8px}
.pair-time-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text)}
.pair-time-tag{font-size:9px;font-weight:700;color:var(--muted);background:var(--surface3);padding:2px 6px;border-radius:4px;letter-spacing:.08em;text-transform:uppercase}
.pair-details{padding:0 14px 12px 50px;font-size:12.5px;color:var(--muted);line-height:1.55}

.last-group-btn{
  background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--rb);
  color:var(--accent);font-family:inherit;font-size:14px;font-weight:700;
  padding:15px;width:100%;cursor:pointer;text-align:center;
  position:relative;overflow:hidden;
  transition:transform .12s,border-color .15s
}
.last-group-btn:active{transform:scale(.97)}

/* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
@keyframes spin{to{transform:rotate(360deg)}}
.loading-spinner{
  display:inline-block;width:16px;height:16px;
  border:2.5px solid rgba(255,255,255,.25);
  border-top-color:currentColor;border-radius:50%;
  animation:spin .7s linear infinite;vertical-align:middle;
  margin-right:8px;flex-shrink:0
}
.last-group-btn.loading{opacity:.75;pointer-events:none}
.last-group-btn .btn-label{display:inline}
/* –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ sched-body */
.sched-loading{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;padding:64px 20px;gap:18px
}
.sched-loading-circle{
  width:48px;height:48px;
  border:3.5px solid var(--surface3);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin .8s linear infinite
}
.sched-loading-dots{display:flex;gap:6px;align-items:center}
.sched-loading-dot{
  width:6px;height:6px;border-radius:50%;background:var(--accent);
  animation:dotPulse 1.2s ease-in-out infinite;
}
.sched-loading-dot:nth-child(2){animation-delay:.2s}
.sched-loading-dot:nth-child(3){animation-delay:.4s}
@keyframes dotPulse{0%,80%,100%{opacity:.25;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

.toast{
  position:fixed;bottom:calc(24px + var(--safe-bot));
  left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface3);color:var(--text);font-size:13px;font-weight:500;
  padding:10px 20px;border-radius:100px;white-space:nowrap;
  border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 32px rgba(0,0,0,.4);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  opacity:0;z-index:999;max-width:88vw;overflow:hidden;text-overflow:ellipsis
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

.bell-day{font-size:10px;font-weight:700;color:var(--accent);letter-spacing:.15em;text-transform:uppercase;margin:18px 0 8px}
.bell-card{background:var(--surface2);border-radius:var(--rb);padding:13px;margin-bottom:7px;display:flex;align-items:flex-start;gap:14px;border:1.5px solid var(--surface3)}
.bell-num{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);min-width:26px;padding-top:2px}
.bell-slots{display:flex;flex-direction:column;gap:7px;flex:1}
.bell-slot{display:flex;align-items:center;gap:10px}
.bell-slot-time{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text)}
.bell-slot-tag{font-size:9px;font-weight:700;color:var(--muted);background:var(--surface3);padding:2px 6px;border-radius:4px;letter-spacing:.08em;text-transform:uppercase}

.bottom-nav{display:flex;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;padding-bottom:var(--safe-bot);background:var(--surface)}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;
  padding:10px 0;cursor:pointer;color:var(--muted);
  transition:color .18s;font-size:10px;font-weight:600;gap:3px;
  background:none;border:none;font-family:inherit;
  position:relative;overflow:hidden;letter-spacing:.02em
}
.nav-item .nav-icon{font-size:20px;transition:transform .2s cubic-bezier(.34,1.56,.64,1)}
.nav-item.active{color:var(--accent)}
.nav-item.active .nav-icon{transform:scale(1.15)}

.toggle-switch{width:44px;height:26px;border-radius:100px;background:var(--surface3);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle-switch.on{background:var(--accent)}
.toggle-switch::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.toggle-switch.on::after{left:21px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface2);border-radius:var(--rb);margin-bottom:8px;font-size:14px;font-weight:500;border:1.5px solid var(--surface3)}
.settings-row-sub{font-size:11px;color:var(--muted);margin-top:2px}

.theme-grid{display:flex;flex-direction:column;gap:7px;margin-top:8px}
.theme-card{background:var(--surface2);border-radius:var(--rb);padding:13px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;border:1.5px solid var(--surface3);position:relative;overflow:hidden;transition:border-color .15s,background .15s}
.theme-card:active{background:var(--surface3)}
.theme-card.selected{background:color-mix(in srgb,var(--accent) 12%,transparent);border-color:color-mix(in srgb,var(--accent) 70%,transparent)}
.theme-card.selected .theme-name{color:var(--accent)}
.theme-swatch{display:flex;gap:5px;flex-shrink:0}
.swatch{width:14px;height:14px;border-radius:50%}
.theme-check{font-size:16px;flex-shrink:0;opacity:0;transition:opacity .15s;color:var(--accent)}
.theme-card.selected .theme-check{opacity:1}
.icon-picker{display:flex;gap:12px;padding:4px 0}
.icon-btn{background:none;border:none;padding:0;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;outline:none}
.icon-preview{display:block;width:56px;height:56px;border-radius:14px;overflow:hidden;box-sizing:border-box;transition:transform .15s,box-shadow .15s}
.icon-btn.selected .icon-preview{box-shadow:0 0 0 2.5px var(--accent);transform:scale(1.08)}
.icon-btn:active .icon-preview{transform:scale(0.95)}
.icon-label{font-size:10px;color:var(--muted);font-weight:600;letter-spacing:.03em}
.icon-btn.selected .icon-label{color:var(--accent)}
.icon-check{position:absolute;top:-4px;right:-4px;background:var(--accent);color:#fff;font-size:9px;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;font-weight:700}
.icon-btn.selected .icon-check{opacity:1}
.hidden{display:none!important}
.mt8{margin-top:8px}.mt16{margin-top:16px}

/* ‚îÄ‚îÄ Difficulty Picker ‚îÄ‚îÄ */
.diff-picker{display:flex;gap:7px;margin:6px 0 10px}
.diff-btn{flex:1;border:1.5px solid var(--surface3);border-radius:var(--rb);background:var(--surface2);color:var(--muted);font-family:inherit;font-size:12px;font-weight:700;padding:8px 4px;cursor:pointer;text-align:center;transition:all .15s;letter-spacing:.02em}
.diff-btn.active{background:color-mix(in srgb,var(--accent) 20%,transparent);border-color:var(--accent);color:var(--accent)}
.diff-btn:active{transform:scale(.95)}

/* ‚îÄ‚îÄ Liquid Glass Mode (works with any theme) ‚îÄ‚îÄ */
body.glass-mode {
  --glass-blur: blur(18px) saturate(180%);
  --glass-blur-opt: blur(8px) saturate(140%);
  --glass-border: rgba(255,255,255,0.18);
  --glass-shadow: 0 8px 32px rgba(80,120,255,0.15);
  --transition-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
}
body.glass-mode::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: -1;
  background:
    radial-gradient(ellipse 60% 50% at 20% 20%, color-mix(in srgb, var(--accent) 35%, transparent) 0%, transparent 60%),
    radial-gradient(ellipse 50% 60% at 80% 70%, color-mix(in srgb, var(--accent2) 28%, transparent) 0%, transparent 60%),
    radial-gradient(ellipse 40% 40% at 60% 10%, color-mix(in srgb, var(--accent) 18%, transparent) 0%, transparent 60%),
    var(--bg);
  animation: glassBlobs 14s ease-in-out infinite alternate;
}
body.glass-mode.glass-optimized::before {
  animation: none;
}
@keyframes glassBlobs {
  0%   { filter: hue-rotate(0deg); }
  50%  { filter: hue-rotate(30deg); }
  100% { filter: hue-rotate(-20deg); }
}
body.glass-mode .screen {
  background: transparent !important;
}
body.glass-mode .hdr,
body.glass-mode .bottom-nav,
body.glass-mode .sched-header {
  background: rgba(10,15,30,0.5) !important;
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
}
body.glass-mode.glass-optimized .hdr,
body.glass-mode.glass-optimized .bottom-nav,
body.glass-mode.glass-optimized .sched-header {
  backdrop-filter: var(--glass-blur-opt) !important;
  -webkit-backdrop-filter: var(--glass-blur-opt) !important;
}
body.glass-mode .list-item,
body.glass-mode .pair-card,
body.glass-mode .bell-card,
body.glass-mode .settings-row,
body.glass-mode .last-group-btn,
body.glass-mode .theme-card {
  background: rgba(255,255,255,0.08) !important;
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border-color: rgba(255,255,255,0.16) !important;
  box-shadow: 0 4px 24px color-mix(in srgb, var(--accent) 12%, transparent), inset 0 1px 0 rgba(255,255,255,0.12) !important;
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1),
              background 0.3s ease,
              box-shadow 0.3s ease !important;
}
body.glass-mode.glass-optimized .list-item,
body.glass-mode.glass-optimized .pair-card,
body.glass-mode.glass-optimized .bell-card,
body.glass-mode.glass-optimized .settings-row,
body.glass-mode.glass-optimized .last-group-btn,
body.glass-mode.glass-optimized .theme-card {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  transition: none !important;
}
body.glass-mode .list-item:active,
body.glass-mode .pair-card:active,
body.glass-mode .theme-card:active,
body.glass-mode .last-group-btn:active {
  transform: scale(0.96) !important;
  background: rgba(255,255,255,0.13) !important;
}
body.glass-mode .btn {
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1),
              box-shadow 0.3s ease !important;
}
body.glass-mode.glass-optimized .btn {
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}
body.glass-mode .btn:active { transform: scale(0.95) !important; }
body.glass-mode .btn-accent {
  background: color-mix(in srgb, var(--accent) 22%, transparent) !important;
  border: 1.5px solid color-mix(in srgb, var(--accent) 40%, transparent);
  color: #fff !important;
  box-shadow: 0 4px 24px color-mix(in srgb, var(--accent) 30%, transparent), inset 0 1px 0 rgba(255,255,255,0.2) !important;
}
body.glass-mode .btn-accent2 {
  background: color-mix(in srgb, var(--accent2) 22%, transparent) !important;
  border: 1.5px solid color-mix(in srgb, var(--accent2) 35%, transparent);
  color: #fff !important;
}
body.glass-mode .btn-surface {
  background: rgba(255,255,255,0.09) !important;
  border: 1.5px solid rgba(255,255,255,0.18);
  color: var(--text) !important;
}
body.glass-mode .btn-surface3 {
  background: color-mix(in srgb, var(--accent) 14%, transparent) !important;
  border: 1.5px solid color-mix(in srgb, var(--accent) 30%, transparent);
  color: var(--accent) !important;
}
body.glass-mode .nav-item .nav-icon {
  transition: transform 0.5s cubic-bezier(0.34,1.56,0.64,1) !important;
}
body.glass-mode .nav-item.active .nav-icon {
  filter: drop-shadow(0 0 8px color-mix(in srgb, var(--accent) 70%, transparent));
}
body.glass-mode .screen {
  transition: opacity 0.28s cubic-bezier(0.4,0,0.2,1),
              transform 0.38s cubic-bezier(0.34,1.2,0.64,1) !important;
}
body.glass-mode.glass-optimized .screen { transition: opacity 0.15s ease !important; }
body.glass-mode .inp {
  background: rgba(255,255,255,0.07) !important;
  border-color: rgba(255,255,255,0.15) !important;
}
body.glass-mode .inp:focus {
  border-color: color-mix(in srgb, var(--accent) 60%, transparent) !important;
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 14%, transparent) !important;
}
body.glass-mode .pair-card.is-now {
  background: color-mix(in srgb, var(--accent) 13%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 45%, transparent) !important;
  box-shadow: 0 0 28px color-mix(in srgb, var(--accent) 22%, transparent), inset 0 1px 0 rgba(255,255,255,0.15) !important;
}
body.glass-mode .now-badge {
  background: color-mix(in srgb, var(--accent) 35%, transparent) !important;
  backdrop-filter: blur(8px);
}
body.glass-mode .toast {
  background: rgba(20,30,60,0.82) !important;
  backdrop-filter: blur(20px) !important;
  border-color: rgba(255,255,255,0.15) !important;
}
body.glass-mode .ripple { background: color-mix(in srgb, var(--accent) 28%, transparent) !important; }
body.glass-mode .egg-overlay,
body.glass-mode .ota-overlay .ota-sheet {
  backdrop-filter: blur(24px) saturate(200%);
  -webkit-backdrop-filter: blur(24px) saturate(200%);
}
body.glass-mode .list-item.selected {
  background: color-mix(in srgb, var(--accent) 18%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 55%, transparent) !important;
  box-shadow: 0 0 20px color-mix(in srgb, var(--accent) 25%, transparent), inset 0 1px 0 rgba(255,255,255,0.15) !important;
}

/* ‚îÄ‚îÄ Custom background ‚îÄ‚îÄ */
body.custom-bg-active {
  background-size: cover !important;
  background-position: center !important;
  background-attachment: fixed !important;
  background-repeat: no-repeat !important;
}
body.custom-bg-active .hdr,
body.custom-bg-active .bottom-nav {
  background: rgba(0,0,0,0.45) !important;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}
body.custom-bg-active.glass-mode .hdr,
body.custom-bg-active.glass-mode .bottom-nav {
  background: rgba(0,0,0,0.3) !important;
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
}

/* Legacy: keep data-theme=glass working */
[data-theme="glass"] body::before { animation: glassBlobs 14s ease-in-out infinite alternate; }

/* ‚îÄ‚îÄ Easter Egg (overlay) ‚îÄ‚îÄ */
.egg-overlay{
  position:fixed;inset:0;z-index:2000;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .3s ease;
  padding:calc(60px + var(--safe-top)) 24px calc(24px + var(--safe-bot));
  overflow-y:auto
}
.egg-overlay.show{opacity:1;pointer-events:all}
.egg-close{
  position:fixed;top:calc(16px + var(--safe-top));right:16px;
  background:var(--surface2);border:none;color:var(--muted);
  width:36px;height:36px;border-radius:50%;font-size:20px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10
}
.egg-back{
  position:fixed;top:calc(16px + var(--safe-top));left:16px;
  background:var(--surface2);border:none;color:var(--accent);
  width:36px;height:36px;border-radius:50%;font-size:22px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;
  opacity:0;pointer-events:none;transition:opacity .2s
}
.egg-back.show{opacity:1;pointer-events:all}
.egg-title{
  font-size:26px;font-weight:800;text-align:center;
  letter-spacing:-.03em;margin-bottom:6px;
  background:linear-gradient(135deg,var(--accent),#ff4e00);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.egg-sub{font-size:13px;color:var(--muted);text-align:center;margin-bottom:20px;line-height:1.6}
.egg-score{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--accent);margin-top:10px;letter-spacing:.05em;text-align:center}
/* ‚îÄ‚îÄ Picker ‚îÄ‚îÄ */
.egg-picker{width:100%;max-width:340px}
.egg-picker-title{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:10px}
.egg-cards{display:flex;flex-direction:column;gap:8px}
.egg-card{
  background:var(--surface2);border:1.5px solid var(--surface3);
  border-radius:14px;padding:14px 16px;cursor:pointer;
  display:flex;align-items:center;gap:14px;
  position:relative;overflow:hidden;
  transition:border-color .15s,box-shadow .15s,transform .12s
}
.egg-card:active{transform:scale(.97);background:var(--surface3)}
.egg-card:hover{border-color:color-mix(in srgb,var(--accent) 55%,transparent);box-shadow:0 0 16px color-mix(in srgb,var(--accent) 20%,transparent)}
.egg-card-icon{font-size:30px;flex-shrink:0;line-height:1}
.egg-card-body{flex:1;min-width:0}
.egg-card-name{font-size:15px;font-weight:700}
.egg-card-desc{font-size:11px;color:var(--muted);margin-top:2px}
.egg-card-badge{
  display:inline-block;font-size:9px;font-weight:700;
  font-family:'JetBrains Mono',monospace;
  color:var(--accent);background:color-mix(in srgb,var(--accent) 15%,transparent);
  border:1px solid color-mix(in srgb,var(--accent) 40%,transparent);
  padding:2px 7px;border-radius:20px;margin-top:5px;letter-spacing:.05em
}
.egg-card-new{color:#4caf7d;background:rgba(76,175,125,.15);border-color:rgba(76,175,125,.4)}
.egg-card-arrow{color:var(--muted);font-size:20px;flex-shrink:0}
/* ‚îÄ‚îÄ Game view ‚îÄ‚îÄ */
.egg-game{width:100%;display:flex;flex-direction:column;align-items:center}
.egg-game-title{font-size:18px;font-weight:800;color:var(--text);letter-spacing:-.02em;margin-bottom:4px}
/* ‚îÄ‚îÄ Snake d-pad ‚îÄ‚îÄ */
.snake-dpad{display:grid;grid-template-columns:repeat(3,48px);grid-template-rows:repeat(3,48px);gap:5px;margin-top:14px}
.dpad-btn{background:var(--surface2);border:1.5px solid var(--surface3);border-radius:10px;color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;transition:background .1s,transform .1s}
.dpad-btn:active{background:var(--surface3);transform:scale(.92)}
/* ‚îÄ‚îÄ Tic-tac-toe ‚îÄ‚îÄ */
.ttt-board{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:min(280px,80vw);margin:0 auto}
.ttt-cell{
  aspect-ratio:1;background:var(--surface2);border:1.5px solid var(--surface3);
  border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:36px;cursor:pointer;user-select:none;
  transition:background .12s,transform .12s,border-color .12s,box-shadow .15s
}
.ttt-cell:active{transform:scale(.91)}
.ttt-cell.x-cell{color:var(--accent);text-shadow:0 0 12px color-mix(in srgb,var(--accent) 80%,transparent)}
.ttt-cell.o-cell{color:#60cdff;text-shadow:0 0 12px rgba(96,205,255,.7)}
.ttt-cell.win{background:color-mix(in srgb,var(--accent) 18%,transparent);border-color:color-mix(in srgb,var(--accent) 60%,transparent);box-shadow:0 0 16px color-mix(in srgb,var(--accent) 35%,transparent)}
.ttt-scores{display:flex;gap:20px;margin-bottom:14px}
.ttt-score-item{display:flex;flex-direction:column;align-items:center;gap:3px;font-size:11px;color:var(--muted)}
.ttt-score-val{font-size:22px;font-weight:800;color:var(--text);font-family:'JetBrains Mono',monospace}
.ttt-status{font-size:13px;font-weight:600;color:var(--muted);margin-top:14px;min-height:20px;text-align:center}
/* ‚îÄ‚îÄ Tetris controls ‚îÄ‚îÄ */
.tet-controls{display:flex;gap:8px;margin-top:12px;align-items:center}
.tet-btn{background:var(--surface2);border:1.5px solid var(--surface3);border-radius:10px;color:var(--text);font-size:16px;width:50px;height:46px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;flex-shrink:0;transition:background .1s,transform .1s}
.tet-btn:active{background:var(--surface3);transform:scale(.92)}
.tet-btn-wide{width:70px}

/* ‚îÄ‚îÄ OTA Update Modal ‚îÄ‚îÄ */
.ota-overlay{
  position:fixed;inset:0;z-index:1000;
  background:rgba(0,0,0,.65);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .25s ease;
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)
}
.ota-overlay.show{opacity:1;pointer-events:all}
.ota-sheet{
  width:100%;max-width:480px;
  background:var(--surface);
  border-radius:24px 24px 0 0;
  padding:12px 22px calc(22px + var(--safe-bot));
  transform:translateY(100%);
  transition:transform .32s cubic-bezier(.34,1.1,.64,1);
  border-top:1px solid rgba(255,255,255,.08)
}
.ota-overlay.show .ota-sheet{transform:translateY(0)}
.ota-handle{
  width:40px;height:4px;border-radius:2px;
  background:var(--surface3);margin:0 auto 20px
}
.ota-icon{font-size:38px;text-align:center;margin-bottom:10px;line-height:1}
.ota-title{
  font-size:20px;font-weight:800;text-align:center;
  letter-spacing:-.02em;margin-bottom:6px;color:var(--text)
}
.ota-version{
  font-size:13px;font-weight:600;text-align:center;
  color:var(--accent);margin-bottom:14px;
  font-family:'JetBrains Mono',monospace
}
.ota-notes{
  font-size:13px;color:var(--muted);line-height:1.6;
  background:var(--surface2);border-radius:var(--rb);
  padding:12px 14px;margin-bottom:18px;
  border:1px solid var(--surface3);
  max-height:120px;overflow-y:auto;white-space:pre-wrap;
  display:none
}
.ota-notes.has-text{display:block}
.ota-progress-wrap{margin-bottom:16px}
.ota-progress-track{
  height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin-bottom:7px
}
.ota-progress-bar{
  height:100%;width:0%;background:var(--accent);border-radius:3px;
  transition:width .15s ease
}
.ota-progress-label{
  font-size:12px;color:var(--muted);text-align:center;font-family:'JetBrains Mono',monospace
}
/* ‚îÄ‚îÄ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (Sber-style) ‚îÄ‚îÄ */
.greeting-overlay{
  position:fixed;inset:0;z-index:9999;
  display:flex; /* –≤–∏–¥–µ–Ω —Å—Ä–∞–∑—É ‚Äî –Ω–µ –∂–¥—ë—Ç JS */
  flex-direction:column;align-items:center;justify-content:center;
  background:var(--bg);
  will-change:opacity;
  transition:opacity .5s cubic-bezier(.4,0,.2,1);
}
.greeting-overlay.greet-hidden{
  opacity:0;pointer-events:none;
}
.greet-logo{
  width:80px;height:80px;border-radius:26px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:36px;
  box-shadow:0 6px 24px color-mix(in srgb,var(--accent) 38%,transparent);
  margin-bottom:28px;
  animation:greet-logo-float 2.6s ease-in-out infinite;
}
@keyframes greet-logo-float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}
.greet-main{
  font-size:28px;font-weight:800;color:var(--text);
  letter-spacing:-.02em;text-align:center;
  min-height:36px;
}
.greet-main .greet-char{
  display:inline-block;
  opacity:0;transform:translateY(10px);
  animation:greet-char-in .35s cubic-bezier(.34,1.56,.64,1) forwards;
}
@keyframes greet-char-in{
  to{opacity:1;transform:translateY(0)}
}
.greet-sub{
  font-size:13px;color:var(--muted);margin-top:10px;
  letter-spacing:.04em;text-align:center;
  opacity:0;animation:greet-sub-in .5s .55s ease forwards;
}
@keyframes greet-sub-in{to{opacity:1}}
.greet-divider{
  width:40px;height:2px;border-radius:1px;
  background:color-mix(in srgb,var(--accent) 50%,transparent);
  margin:14px 0;
  opacity:0;animation:greet-sub-in .4s .45s ease forwards;
}
.greet-time{
  position:absolute;bottom:calc(var(--safe-bot) + 44px);
  font-family:'JetBrains Mono',monospace;font-size:13px;
  color:var(--muted);letter-spacing:.1em;
  opacity:0;animation:greet-sub-in .4s .7s ease forwards;
}
.greet-particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.greet-particle{
  position:absolute;border-radius:50%;
  background:var(--accent);opacity:0;
  animation:greet-particle-anim var(--dur,3s) var(--del,0s) ease-in-out infinite;
}
@keyframes greet-particle-anim{
  0%{opacity:0;transform:translateY(0) scale(1)}
  20%{opacity:.18}
  80%{opacity:.06}
  100%{opacity:0;transform:translateY(-120px) scale(.4)}
}

/* ‚îÄ‚îÄ –°–µ–∫—Ä–µ—Ç–Ω–∞—è CMD-–∫–æ–Ω—Å–æ–ª—å ‚îÄ‚îÄ */
.cmd-overlay{
  position:fixed;inset:0;z-index:600;display:flex;flex-direction:column;
  background:#0c0c0c;font-family:'JetBrains Mono',monospace;
  padding-top:var(--safe-top);padding-bottom:var(--safe-bot);
}
.cmd-titlebar{
  background:#1a1a1a;padding:10px 14px;display:flex;align-items:center;gap:10px;
  border-bottom:1px solid #333;flex-shrink:0;
}
.cmd-titlebar-dots{display:flex;gap:6px;}
.cmd-dot{width:12px;height:12px;border-radius:50%;}
.cmd-title{font-size:12px;color:#888;flex:1;text-align:center;letter-spacing:.06em;}
.cmd-close{background:none;border:none;color:#888;font-size:18px;cursor:pointer;padding:0 4px;line-height:1;}
.cmd-body{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:2px;}
.cmd-body::-webkit-scrollbar{display:none;}
.cmd-line{font-size:12.5px;line-height:1.65;white-space:pre-wrap;word-break:break-word;}
.cmd-line.out{color:#cccccc;}
.cmd-line.ok{color:#4ec94e;}
.cmd-line.err{color:#ff6b6b;}
.cmd-line.info{color:#5bb8f5;}
.cmd-line.warn{color:#f5c842;}
.cmd-line.prompt{color:#888;}
.cmd-input-row{
  display:flex;align-items:center;gap:0;padding:10px 16px;
  border-top:1px solid #222;flex-shrink:0;background:#0c0c0c;
}
.cmd-prompt-sym{color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:13px;margin-right:8px;flex-shrink:0;}
.cmd-input{
  flex:1;background:transparent;border:none;outline:none;
  font-family:'JetBrains Mono',monospace;font-size:13px;color:#eee;caret-color:var(--accent);
}
.cmd-cursor-blink{display:inline-block;width:8px;height:14px;background:var(--accent);margin-left:1px;vertical-align:text-bottom;animation:blink 1s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
/* ‚îÄ‚îÄ –°–µ–∫—Ä–µ—Ç–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ‚îÄ‚îÄ */
#matrix-canvas{position:fixed;inset:0;z-index:9998;pointer-events:none;opacity:0;transition:opacity .5s;}
#matrix-canvas.active{opacity:.85;}
#snow-canvas{position:fixed;inset:0;z-index:8;pointer-events:none;}
@keyframes app-shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-9px)}40%{transform:translateX(9px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
body.shaking{animation:app-shake .45s ease;}
/* ‚îÄ‚îÄ –î–∏—Å–∫–æ: RGB overlay –ø–æ–≤–µ—Ä—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –±–µ–∑ —Å–º–µ–Ω—ã —Ç–µ–º ‚îÄ‚îÄ */
#disco-overlay{
  position:fixed;inset:0;z-index:900;pointer-events:none;
  display:none;mix-blend-mode:color;opacity:0;
}
body.disco-mode #disco-overlay{display:block;}
@keyframes disco-rgb{
  0%   {background:hsl(0,90%,50%);   opacity:.22}
  16%  {background:hsl(60,90%,50%);  opacity:.18}
  33%  {background:hsl(120,90%,50%); opacity:.22}
  50%  {background:hsl(180,90%,50%); opacity:.18}
  66%  {background:hsl(240,90%,50%); opacity:.22}
  83%  {background:hsl(300,90%,50%); opacity:.18}
  100% {background:hsl(360,90%,50%); opacity:.22}
}
body.disco-mode #disco-overlay{animation:disco-rgb 2s linear infinite;}
@keyframes disco-pulse{
  0%,100%{filter:brightness(1)}
  50%{filter:brightness(1.08)}
}
body.disco-mode{animation:disco-pulse 1s ease-in-out infinite;}
</style>
<body>

<!-- –ì–õ–ê–í–ù–ê–Ø -->
<div class="screen active" id="s-home">
  <div class="body">
    <div class="home-hero">
      <div class="hero-title">–∫–æ–ª–ª–µ–¥–∂<br>—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
    </div>
    <div id="last-group-wrap" class="hidden">
      <div class="section-label">–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫</div>
      <button class="last-group-btn" id="last-group-btn" onclick="jumpToLastGroup()"></button>
      <div style="height:14px"></div>
    </div>
    <div class="status" id="home-status"></div>
    <div class="progress"><div class="progress-bar" id="home-bar"></div></div>
    <div id="file-section" class="hidden">
      <div class="section-label">–§–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</div>
      <div class="list" id="file-list"></div>
      <div style="height:14px"></div>
      <button class="btn btn-accent" onclick="goToGroups()">–í—ã–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—É ‚Üí</button>
    </div>
    <div id="no-url-hint" class="hidden" style="text-align:center;padding:48px 20px">
      <div style="font-size:38px;margin-bottom:12px">‚öôÔ∏è</div>
      <div style="color:var(--muted);font-size:14px;line-height:1.6;margin-bottom:20px">–£–∫–∞–∂–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫<br>–≤ <b style="color:var(--accent)">–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö</b></div>
      <button class="btn btn-accent" onclick="navTo('s-settings','nav-settings')">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí</button>
    </div>
    <div id="home-error-hint" class="hidden" style="text-align:center;padding:36px 20px">
      <div style="font-size:36px;margin-bottom:10px">üîå</div>
      <div style="color:var(--text);font-size:15px;font-weight:700;margin-bottom:6px">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</div>
      <div class="error-msg" style="color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:6px;word-break:break-word"></div>
      <div style="color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:20px">
        –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É.
      </div>
      <button class="btn btn-surface" onclick="loadFiles()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item active" id="nav-home" onclick="SFX.play('navHome');goHome()">
      <span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="nav-item" id="nav-bells" onclick="SFX.play('navBells');navTo('s-bells','nav-bells')">
      <span class="nav-icon">üîî</span><span>–ó–≤–æ–Ω–∫–∏</span></button>
    <button class="nav-item" id="nav-settings" onclick="SFX.play('navSettings');navTo('s-settings','nav-settings')">
      <span class="nav-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  </div>
</div>

<!-- –ì–†–£–ü–ü–´ -->
<div class="screen" id="s-groups">
  <div class="hdr">
    <button class="hdr-back" onclick="SFX.play('screenBack');goHome()">‚Äπ</button>
    <div><div class="hdr-title" id="groups-title">–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã</div>
    <div class="hdr-sub" id="groups-sub"></div></div>
  </div>
  <div style="padding:12px 18px 0;flex-shrink:0">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="inp" id="group-search" placeholder="–ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É..." oninput="filterGroups(this.value)">
    </div>
    <div class="status mt8" id="groups-status"></div>
    <div class="progress"><div class="progress-bar" id="groups-bar"></div></div>
  </div>
  <div class="body" style="padding-top:10px"><div class="list" id="group-list"></div></div>
</div>

<!-- –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
<div class="screen" id="s-schedule">
  <div class="sched-header" id="sched-header-tap">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="hdr-back" onclick="SFX.play('screenBack');showScreen('s-groups','back')">‚Äπ</button>
      <div><div class="sched-group" id="sched-group-name"></div>
      <div class="sched-date" id="sched-date"></div></div>
    </div>
  </div>
  <div class="body" id="sched-body"></div>
</div>

<!-- –ó–í–û–ù–ö–ò -->
<div class="screen" id="s-bells">
  <div class="hdr">
    <button class="hdr-back" onclick="SFX.play('screenBack');goHome()">‚Äπ</button>
    <div class="hdr-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</div>
  </div>
  <div class="body" id="bells-body"></div>
</div>

<!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
<div class="screen" id="s-settings">
  <div class="hdr">
    <button class="hdr-back" onclick="SFX.play('screenBack');goHome()">‚Äπ</button>
    <div class="hdr-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="body">

    <!-- –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫ -->
    <div class="section-label">–Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫</div>
    <input class="inp" id="url-input" type="url"
           placeholder="https://disk.yandex.ru/d/..."
           autocomplete="off" autocorrect="off" autocapitalize="off">
    <div style="height:8px"></div>
    <button class="btn btn-accent2" onclick="SFX.play('btnAccent');saveUrlAndLoad()">‚¨á –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã</button>
    <div style="height:6px"></div>
    <div class="status" id="proxy-status" style="text-align:left;font-size:11px"></div>
    <div class="sep"></div>

    <!-- –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
    <div class="section-label">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
    <div id="theme-current-row" class="list-item" onclick="showScreen('s-themes')" style="margin-bottom:8px">
      <div>
        <div class="item-name" id="theme-current-name">–ö–æ–ª–ª–µ–¥–∂</div>
        <div class="item-sub" id="theme-current-sub">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
      </div>
      <span class="item-arrow">‚Ä∫</span>
    </div>

    <!-- Liquid Glass —Ä–µ–∂–∏–º -->
    <div class="settings-row" style="flex-direction:column;align-items:stretch;gap:0;padding:0;overflow:hidden;margin-bottom:8px">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;">
        <div>
          <div style="font-size:14px;font-weight:600;display:flex;align-items:center;gap:7px">
            ü´ß Liquid Glass
            <span style="font-size:9px;font-weight:800;background:var(--accent);color:#000;padding:2px 6px;border-radius:4px;letter-spacing:.06em;opacity:.85">–ë–ï–¢–ê</span>
          </div>
          <div class="settings-row-sub" style="color:var(--accent);font-weight:600;margin-top:3px">‚ö†Ô∏è –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ ¬∑ –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
        </div>
        <div id="glass-toggle" class="toggle-switch" onclick="toggleGlassMode()" style="flex-shrink:0"></div>
      </div>
      <div id="glass-opt-row" style="border-top:1px solid rgba(255,255,255,.07);padding:12px 16px;display:none;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-size:13px;font-weight:600">‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</div>
          <div class="settings-row-sub">–°–Ω–∏–∂–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–∑–º—ã—Ç–∏—è –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏. –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç FPS</div>
        </div>
        <div id="glass-opt-toggle" class="toggle-switch" onclick="toggleGlassOpt()" style="flex-shrink:0"></div>
      </div>
    </div>

    <!-- –§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div class="section-label">–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
    <div id="custom-bg-preview" style="display:none;border-radius:var(--rb);overflow:hidden;margin-bottom:8px;position:relative">
      <img id="custom-bg-img-thumb" style="width:100%;height:80px;object-fit:cover;display:block" src="" alt="">
      <div style="position:absolute;inset:0;background:linear-gradient(transparent,rgba(0,0,0,.5));display:flex;align-items:flex-end;padding:8px 12px">
        <span style="font-size:11px;color:#fff;font-weight:600">–°–≤–æ–π —Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω</span>
      </div>
    </div>
    <button class="btn btn-surface" onclick="pickBgImage()" style="margin-bottom:6px">üñº –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω (PNG / JPG)</button>
    <button id="remove-bg-btn" class="btn btn-danger" onclick="removeBgImage()" style="display:none;margin-bottom:6px">üóë –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
    <input type="file" id="bg-file-input" accept="image/png,image/jpeg,image/jpg" style="display:none" onchange="onBgFileChosen(event)">
    <div class="sep"></div>

    <!-- –ó–≤—É–∫ -->
    <div class="section-label">–ó–≤—É–∫</div>
    <div class="list-item" onclick="toggleMute()" style="margin-bottom:8px">
      <div>
        <div class="item-name" id="mute-label">üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω</div>
        <div class="item-sub">–ó–≤—É–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
      </div>
      <span class="item-arrow">‚Ä∫</span>
    </div>
    <div class="sep"></div>

    <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
    <div class="section-label">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.6">
      –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ª–æ–≥–∏ –ø–æ–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É.<br>
      –§–∞–π–ª: <span style="color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:11px">Download/ScheduleApp_logs.txt</span>
    </div>
    <button class="btn btn-surface" onclick="if(window.Android&&window.Android.showLogPath){window.Android.showLogPath();}else{alert('–õ–æ–≥: Download/ScheduleApp_logs.txt');}">
      üìã –ì–¥–µ –ª–æ–≥-—Ñ–∞–π–ª?
    </button>
    <div style="height:8px"></div>
    <button class="btn btn-surface" onclick="var ok=window.Android&&window.Android.logMsg;if(ok){window.Android.logMsg('INFO','–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ '+new Date().toISOString());toast('–°—Ç—Ä–æ–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –ª–æ–≥');}else{toast('Android bridge –Ω–µ –Ω–∞–π–¥–µ–Ω');}">
      üî¨ –ó–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –≤ –ª–æ–≥
    </button>
    <div class="sep"></div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ / OTA -->
    <div class="section-label">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
    <div class="list-item" style="cursor:default;margin-bottom:8px">
      <div id="egg-tap-zone"
        onclick="eggTap()"
        ontouchstart="eggTap()"
        style="cursor:pointer;-webkit-tap-highlight-color:transparent;padding:10px 0;flex:1;min-width:0;user-select:none">
        <div class="item-name">–í–µ—Ä—Å–∏—è</div>
        <div class="item-sub" id="app-version-str">3.0 ‚Äî Android</div>
      </div>
      <button class="btn btn-surface3" style="width:auto;padding:8px 14px;font-size:12px;flex-shrink:0" onclick="checkOtaUpdate()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>
    <button class="btn btn-surface" onclick="clearCacheAndReload()" style="margin-bottom:4px">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <div style="height:24px"></div>
  </div>
</div>


<!-- –í–´–ë–û–† –¢–ï–ú–´ -->
<div class="screen" id="s-themes">
  <div class="hdr">
    <button class="hdr-back" onclick="SFX.play('screenBack');showScreen('s-settings','back')">‚Äπ</button>
    <div>
      <div class="hdr-title">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
      <div class="hdr-sub" id="theme-screen-sub">–í—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É</div>
    </div>
  </div>
  <div class="body">
    <div class="theme-grid" id="theme-grid-screen"></div>

    <!-- –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="icon-picker-section">
      <div class="section-label" style="margin-top:16px;margin-bottom:8px">–ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
      <div class="theme-grid" id="icon-grid-screen"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê –°–µ–∫—Ä–µ—Ç–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ‚ïê‚ïê -->
<canvas id="matrix-canvas"></canvas>
<canvas id="snow-canvas" style="display:none"></canvas>
<div id="disco-overlay"></div>

<!-- ‚ïê‚ïê –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É) ‚ïê‚ïê -->
<div id="greeting-overlay" class="greeting-overlay">
  <div class="greet-particles" id="greet-particles"></div>
  <div class="greet-logo" id="greet-logo">üìÖ</div>
  <div class="greet-main" id="greet-main"></div>
  <div class="greet-divider"></div>
  <div class="greet-sub" id="greet-sub">–∫–æ–ª–ª–µ–¥–∂–∞</div>
  <div class="greet-time" id="greet-time"></div>
</div>

<!-- ‚ïê‚ïê –°–µ–∫—Ä–µ—Ç–Ω–∞—è CMD-–∫–æ–Ω—Å–æ–ª—å ‚ïê‚ïê -->
<div class="cmd-overlay" id="cmd-overlay" style="display:none">
  <div class="cmd-titlebar">
    <div class="cmd-titlebar-dots">
      <div class="cmd-dot" style="background:#ff5f57"></div>
      <div class="cmd-dot" style="background:#febc2e"></div>
      <div class="cmd-dot" style="background:#28c840"></div>
    </div>
    <div class="cmd-title">Schedule App ‚Äî Developer Console</div>
    <button class="cmd-close" onclick="cmdClose()">√ó</button>
  </div>
  <div class="cmd-body" id="cmd-body"></div>
  <div class="cmd-input-row">
    <span class="cmd-prompt-sym">C:\&gt;</span>
    <input class="cmd-input" id="cmd-input" autocomplete="off" autocorrect="off" spellcheck="false"
      placeholder="–≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É..." onkeydown="cmdKey(event)">
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê –°–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ ‚Äî –≤—ã–±–æ—Ä –∏–≥—Ä—ã (5 —Ç–∞–ø–æ–≤ –ø–æ —Å—Ç—Ä–æ–∫–µ ¬´–í–µ—Ä—Å–∏—è¬ª) ‚ïê‚ïê -->
<div class="egg-overlay" id="egg-overlay">
  <button class="egg-close" onclick="eggClose()">√ó</button>
  <button class="egg-back" id="egg-back" onclick="eggShowPicker()">‚Äπ</button>

  <!-- –ü–∏–∫–µ—Ä –∏–≥—Ä -->
  <div id="egg-picker" class="egg-picker">
    <div class="egg-title">üéÆ –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º</div>
    <div class="egg-sub">–¢—ã –Ω–∞—à—ë–ª –ø–∞—Å—Ö–∞–ª–∫—É!<br>–£–±–µ–π –≤—Ä–µ–º—è –¥–æ –ø–∞—Ä—ã üé≤</div>
    <div class="egg-picker-title">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É</div>
    <div class="egg-cards">
      <div class="egg-card" onclick="eggStartGame('snake')">
        <div class="egg-card-icon">üêç</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–ó–º–µ–π–∫–∞</div>
          <div class="egg-card-desc">–ï—à—å, —Ä–∞—Å—Ç–∏, –Ω–µ –≤—Ä–µ–∑–∞–π—Å—è –≤ —Å–µ–±—è</div>
          <div class="egg-card-badge">v1.6.0 ‚Ä¢ —Å–≤–∞–π–ø / d-pad</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('ttt')">
        <div class="egg-card-icon">‚ùå</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</div>
          <div class="egg-card-desc">–ü—Ä–æ—Ç–∏–≤ –ò–ò –Ω–∞ minimax ‚Äî –ø–æ–ø—Ä–æ–±—É–π –≤—ã–∏–≥—Ä–∞—Ç—å</div>
          <div class="egg-card-badge">v1.7.0 ‚Ä¢ tap</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('pong')">
        <div class="egg-card-icon">üèì</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–ü–∏–Ω–≥-–ø–æ–Ω–≥</div>
          <div class="egg-card-desc">–û—Ç–±–∏–≤–∞–π –º—è—á –∏ –Ω–µ –¥–∞–≤–∞–π –µ–º—É —É–ø–∞—Å—Ç—å</div>
          <div class="egg-card-badge">v1.8.0 ‚Ä¢ —Å–≤–∞–π–ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('tetris')">
        <div class="egg-card-icon">üß±</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–¢–µ—Ç—Ä–∏—Å</div>
          <div class="egg-card-desc">–£–∫–ª–∞–¥—ã–≤–∞–π —Ñ–∏–≥—É—Ä—ã, –Ω–µ –∑–∞–ø–æ–ª–Ω—è–π —ç–∫—Ä–∞–Ω</div>
          <div class="egg-card-badge">v1.9.0 ‚Ä¢ –∫–Ω–æ–ø–∫–∏ / —Å–≤–∞–π–ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('dino')">
        <div class="egg-card-icon">ü¶ï</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–î–∏–Ω–æ–∑–∞–≤—Ä–∏–∫</div>
          <div class="egg-card-desc">–ü—Ä—ã–≥–∞–π —á–µ—Ä–µ–∑ –∫–∞–∫—Ç—É—Å—ã, –Ω–µ —É–º—Ä–∏</div>
          <div class="egg-card-badge egg-card-new">v2.0.0 ‚ú¶ –ù–û–í–ê–Ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('blockblast')">
        <div class="egg-card-icon">üü¶</div>
        <div class="egg-card-body">
          <div class="egg-card-name">Block Blast</div>
          <div class="egg-card-desc">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –±–ª–æ–∫–∏, –∑–∞–ø–æ–ª–Ω—è–π –ª–∏–Ω–∏–∏</div>
          <div class="egg-card-badge egg-card-new">v2.0.0 ‚ú¶ –ù–û–í–ê–Ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('breakout')">
        <div class="egg-card-icon">üß±</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–ê—Ä–∫–∞–Ω–æ–∏–¥</div>
          <div class="egg-card-desc">–†–∞–∑–±–∏–≤–∞–π –∫–∏—Ä–ø–∏—á–∏ –º—è—á–æ–º, –Ω–µ —É—Ä–æ–Ω–∏!</div>
          <div class="egg-card-badge egg-card-new">v2.1.0 ‚ú¶</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('bubbles')">
        <div class="egg-card-icon">ü´ß</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–ü—É–∑—ã—Ä–∏</div>
          <div class="egg-card-desc">–õ–æ–ø–∞–π –ø—É–∑—ã—Ä–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç!</div>
          <div class="egg-card-badge egg-card-new">v2.2.0 ‚ú¶ –ù–û–í–ê–Ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('flappy')">
        <div class="egg-card-icon">üê¶</div>
        <div class="egg-card-body">
          <div class="egg-card-name">–§–ª–∞–ø–ø–∏ –ø—Ç–∏—Ü–∞</div>
          <div class="egg-card-desc">–õ–µ—Ç–∏ –º–µ–∂–¥—É —Ç—Ä—É–±–∞–º–∏, –Ω–µ –∫–∞—Å–∞–π—Å—è!</div>
          <div class="egg-card-badge egg-card-new">v2.6.0 ‚ú¶ –ù–û–í–ê–Ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
      <div class="egg-card" onclick="eggStartGame('2048')">
        <div class="egg-card-icon">üî¢</div>
        <div class="egg-card-body">
          <div class="egg-card-name">2048</div>
          <div class="egg-card-desc">–°–∫–ª–∞–¥—ã–≤–∞–π –ø–ª–∏—Ç–∫–∏, –¥–æ–±–µ—Ä–∏—Å—å –¥–æ 2048!</div>
          <div class="egg-card-badge egg-card-new">v2.6.0 ‚ú¶ –ù–û–í–ê–Ø</div>
        </div>
        <div class="egg-card-arrow">‚Ä∫</div>
      </div>
    </div>
  </div>

  <!-- –ó–º–µ–π–∫–∞ -->
  <div id="egg-snake" class="egg-game" style="display:none">
    <div class="egg-game-title">üêç –ó–º–µ–π–∫–∞</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="snakeDifficulty='easy';updateDiffBtns('snake');snakeRestart()">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="snakeDifficulty='normal';updateDiffBtns('snake');snakeRestart()">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="snakeDifficulty='hard';updateDiffBtns('snake');snakeRestart()">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="snake-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <canvas id="snake-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:10px;display:block;touch-action:none"></canvas>
    <div class="snake-dpad">
      <div></div>
      <div class="dpad-btn" ontouchstart="snakeDir(0,-1)" onclick="snakeDir(0,-1)">‚ñ≤</div>
      <div></div>
      <div class="dpad-btn" ontouchstart="snakeDir(-1,0)" onclick="snakeDir(-1,0)">‚óÄ</div>
      <div class="dpad-btn" style="background:var(--surface3);font-size:12px;color:var(--muted)" ontouchstart="snakeTogglePause()" onclick="snakeTogglePause()">‚è∏</div>
      <div class="dpad-btn" ontouchstart="snakeDir(1,0)" onclick="snakeDir(1,0)">‚ñ∂</div>
      <div></div>
      <div class="dpad-btn" ontouchstart="snakeDir(0,1)" onclick="snakeDir(0,1)">‚ñº</div>
      <div></div>
    </div>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="snakeRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ -->
  <div id="egg-ttt" class="egg-game" style="display:none">
    <div class="egg-game-title">‚ùå –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</div>
    <div class="ttt-scores">
      <div class="ttt-score-item"><div class="ttt-score-val" id="ttt-score-x">0</div><div>–¢—ã (‚úï)</div></div>
      <div class="ttt-score-item"><div class="ttt-score-val" id="ttt-score-d">0</div><div>–ù–∏—á—å—è</div></div>
      <div class="ttt-score-item"><div class="ttt-score-val" id="ttt-score-o">0</div><div>–ò–ò (‚óØ)</div></div>
    </div>
    <div class="ttt-board" id="ttt-board"></div>
    <div class="ttt-status" id="ttt-status">–¢–≤–æ–π —Ö–æ–¥ ‚Äî —Å—Ç–∞–≤—å ‚úï</div>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:14px;font-size:13px" onclick="tttRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –ü–∏–Ω–≥-–ø–æ–Ω–≥ -->
  <div id="egg-pong" class="egg-game" style="display:none">
    <div class="egg-game-title">üèì –ü–∏–Ω–≥-–ø–æ–Ω–≥</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="pongDifficulty='easy';updateDiffBtns('pong');pongRestart()">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="pongDifficulty='normal';updateDiffBtns('pong');pongRestart()">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="pongDifficulty='hard';updateDiffBtns('pong');pongRestart()">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="pong-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <canvas id="pong-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:10px;display:block;touch-action:none"></canvas>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="pongRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –¢–µ—Ç—Ä–∏—Å -->
  <div id="egg-tetris" class="egg-game" style="display:none">
    <div class="egg-game-title">üß± –¢–µ—Ç—Ä–∏—Å</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="tetDifficulty='easy';updateDiffBtns('tetris');tetRestart()">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="tetDifficulty='normal';updateDiffBtns('tetris');tetRestart()">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="tetDifficulty='hard';updateDiffBtns('tetris');tetRestart()">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="tet-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0 ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: 1</div>
    <canvas id="tet-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:10px;display:block;touch-action:none"></canvas>
    <div class="tet-controls">
      <button class="tet-btn" ontouchstart="tetMove(-1)" onclick="tetMove(-1)">‚óÄ</button>
      <button class="tet-btn tet-btn-wide" ontouchstart="tetRotate()" onclick="tetRotate()">‚Üª</button>
      <button class="tet-btn" ontouchstart="tetMove(1)" onclick="tetMove(1)">‚ñ∂</button>
      <button class="tet-btn tet-btn-wide" ontouchstart="tetDrop()" onclick="tetDrop()">‚¨á</button>
    </div>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="tetRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –î–∏–Ω–æ -->
  <div id="egg-dino" class="egg-game" style="display:none">
    <div class="egg-game-title">ü¶ï –î–∏–Ω–æ–∑–∞–≤—Ä–∏–∫</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="dinoDifficulty='easy';updateDiffBtns('dino');dinoRestart()">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="dinoDifficulty='normal';updateDiffBtns('dino');dinoRestart()">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="dinoDifficulty='hard';updateDiffBtns('dino');dinoRestart()">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="dino-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <canvas id="dino-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:10px;display:block;touch-action:none"></canvas>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="dinoRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- BlockBlast -->
  <div id="egg-blockblast" class="egg-game" style="display:none">
    <div class="egg-game-title">üü¶ Block Blast</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="bbDifficulty='easy';updateDiffBtns('blockblast')">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="bbDifficulty='normal';updateDiffBtns('blockblast')">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="bbDifficulty='hard';updateDiffBtns('blockblast')">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="bb-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <div id="bb-board-wrap" style="margin-top:10px;display:flex;justify-content:center"></div>
    <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:6px">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —Ñ–∏–≥—É—Ä—ã –Ω–∞ –ø–æ–ª–µ</div>
    <div id="bb-pieces-wrap" style="display:flex;gap:10px;justify-content:center;align-items:flex-end;margin-top:8px;min-height:80px"></div>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="bbRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –ê—Ä–∫–∞–Ω–æ–∏–¥ -->
  <div id="egg-breakout" class="egg-game" style="display:none">
    <div class="egg-game-title">üß± –ê—Ä–∫–∞–Ω–æ–∏–¥</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="brDifficulty='easy';updateDiffBtns('breakout')">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="brDifficulty='normal';updateDiffBtns('breakout')">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="brDifficulty='hard';updateDiffBtns('breakout')">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="br-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0 ‚Ä¢ –ñ–∏–∑–Ω–∏: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <canvas id="br-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:10px;display:block;touch-action:none"></canvas>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="brRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –ü—É–∑—ã—Ä–∏ -->
  <div id="egg-bubbles" class="egg-game" style="display:none">
    <div class="egg-game-title">ü´ß –ü—É–∑—ã—Ä–∏</div>
    <div class="diff-picker">
      <button class="diff-btn" onclick="bubDifficulty='easy';updateDiffBtns('bubbles')">üê¢ –õ–µ–≥–∫–æ</button>
      <button class="diff-btn active" onclick="bubDifficulty='normal';updateDiffBtns('bubbles')">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
      <button class="diff-btn" onclick="bubDifficulty='hard';updateDiffBtns('bubbles')">üíÄ –•–∞—Ä–¥–∫–æ—Ä</button>
    </div>
    <div class="egg-score" id="bub-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0 ‚Ä¢ –ñ–∏–∑–Ω–∏: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <canvas id="bub-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:8px;display:block;touch-action:none"></canvas>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="bubRestart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <!-- –§–ª–∞–ø–ø–∏ –ø—Ç–∏—Ü–∞ -->
  <div id="egg-flappy" class="egg-game" style="display:none">
    <div class="egg-game-title">üê¶ –§–ª–∞–ø–ø–∏ –ø—Ç–∏—Ü–∞</div>
    <div class="egg-score" id="flappy-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <canvas id="flappy-canvas" style="border-radius:14px;border:1.5px solid var(--surface3);margin-top:8px;display:block;touch-action:none"></canvas>
    <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:8px">—Ç–∞–ø / –ø—Ä–æ–±–µ–ª ‚Äî –≤–∑–º–∞—Ö</div>
  </div>

  <!-- 2048 -->
  <div id="egg-2048" class="egg-game" style="display:none">
    <div class="egg-game-title">üî¢ 2048</div>
    <div class="egg-score" id="g2048-score-label">–°—á—ë—Ç: 0 ‚Ä¢ –†–µ–∫–æ—Ä–¥: 0</div>
    <div id="g2048-board" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:min(300px,85vw);margin:12px auto 0;touch-action:none"></div>
    <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:10px">—Å–≤–∞–π–ø –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ ‚Äî –¥–≤–∏–≥–∞—Ç—å –ø–ª–∏—Ç–∫–∏</div>
    <button class="btn btn-surface3" style="width:auto;padding:9px 22px;margin-top:10px;font-size:13px" onclick="g2048Restart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

</div>

<!-- ‚ïê‚ïê –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–≤ —Å—Ç–∏–ª–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è) ‚ïê‚ïê -->
<div class="ota-overlay" id="ota-overlay" onclick="otaOverlayClose(event)">
  <div class="ota-sheet" id="ota-sheet">
    <div class="ota-handle"></div>
    <div class="ota-icon">‚¨ÜÔ∏è</div>
    <div class="ota-title">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
    <div class="ota-version" id="ota-version-label"></div>
    <div class="ota-notes" id="ota-notes-text"></div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (—Å–∫—Ä—ã—Ç –¥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è) -->
    <div class="ota-progress-wrap hidden" id="ota-progress-wrap">
      <div class="ota-progress-track">
        <div class="ota-progress-bar" id="ota-progress-bar"></div>
      </div>
      <div class="ota-progress-label" id="ota-progress-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...</div>
    </div>

    <button class="btn btn-accent" id="ota-dl-btn" onclick="otaStartDownload()">‚¨á –°–∫–∞—á–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button class="btn btn-surface" id="ota-cancel-btn" onclick="otaClose()" style="margin-top:8px">–ü–æ–∑–∂–µ</button>
  </div>
</div>

<script>
// ‚ïê‚ïê –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî –æ–±—ä—è–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ TDZ ‚ïê‚ïê
var _otaApkUrl = '', _otaVersion = '';
var _eggTaps = 0, _eggTimer = null, _eggLastTouch = 0;
var _discoActive = false;
// ‚ïê‚ïê –ü–û–õ–ò–§–ò–õ AbortSignal.timeout ‚ïê‚ïê
// AbortSignal.timeout –ø–æ—è–≤–∏–ª—Å—è –≤ Chrome 103 (2022).
// –ù–∞ Android —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º WebView –µ–≥–æ –Ω–µ—Ç ‚Äî –±–µ–∑ –ø–æ–ª–∏—Ñ–∏–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫—Ä–∞—à–∏—Ç.
if (typeof AbortSignal !== 'undefined' && !AbortSignal.timeout) {
  AbortSignal.timeout = function(ms) {
    var ctrl = new AbortController();
    setTimeout(function() {
      ctrl.abort(new DOMException('TimeoutError', 'TimeoutError'));
    }, ms);
    return ctrl.signal;
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–∞—Ä—Ç–∞ –ø–∞–¥–µ–∂–Ω—ã—Ö —Ñ–æ—Ä–º –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ ‚Üí –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
const DAY_NOMINATIVE={
  '–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö':'–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö','–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö–ê':'–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö','–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö–£':'–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö',
  '–í–¢–û–†–ù–ò–ö':'–í–¢–û–†–ù–ò–ö','–í–¢–û–†–ù–ò–ö–ê':'–í–¢–û–†–ù–ò–ö','–í–¢–û–†–ù–ò–ö–£':'–í–¢–û–†–ù–ò–ö',
  '–°–†–ï–î–£':'–°–†–ï–î–ê','–°–†–ï–î–´':'–°–†–ï–î–ê','–°–†–ï–î–ï':'–°–†–ï–î–ê','–°–†–ï–î–ê':'–°–†–ï–î–ê',
  '–ß–ï–¢–í–ï–†–ì':'–ß–ï–¢–í–ï–†–ì','–ß–ï–¢–í–ï–†–ì–ê':'–ß–ï–¢–í–ï–†–ì','–ß–ï–¢–í–ï–†–ì–£':'–ß–ï–¢–í–ï–†–ì',
  '–ü–Ø–¢–ù–ò–¶–£':'–ü–Ø–¢–ù–ò–¶–ê','–ü–Ø–¢–ù–ò–¶–´':'–ü–Ø–¢–ù–ò–¶–ê','–ü–Ø–¢–ù–ò–¶–ï':'–ü–Ø–¢–ù–ò–¶–ê','–ü–Ø–¢–ù–ò–¶–ê':'–ü–Ø–¢–ù–ò–¶–ê',
  '–°–£–ë–ë–û–¢–£':'–°–£–ë–ë–û–¢–ê','–°–£–ë–ë–û–¢–´':'–°–£–ë–ë–û–¢–ê','–°–£–ë–ë–û–¢–ï':'–°–£–ë–ë–û–¢–ê','–°–£–ë–ë–û–¢–ê':'–°–£–ë–ë–û–¢–ê',
  '–í–û–°–ö–†–ï–°–ï–ù–¨–ï':'–í–û–°–ö–†–ï–°–ï–ù–¨–ï','–í–û–°–ö–†–ï–°–ï–ù–¨–Ø':'–í–û–°–ö–†–ï–°–ï–ù–¨–ï','–í–û–°–ö–†–ï–°–ï–ù–¨–Æ':'–í–û–°–ö–†–ï–°–ï–ù–¨–ï',
};
function formatScheduleDate(hdr){
  // –ò—â–µ–º –≤ —Å—Ç—Ä–æ–∫–µ: –î–µ–Ω—å–ù–µ–¥–µ–ª–∏ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–µ–¥–µ–ª—è)
  const m=hdr.match(/([–ê-–Ø–Å–∞-—è—ë]+)\s+(\d{2}\.\d{2}\.\d{4})\s*(\([^)]*\))?/);
  if(m){
    const dayRaw=m[1].toUpperCase();
    const day=DAY_NOMINATIVE[dayRaw]||dayRaw;
    const date=m[2];
    const week=m[3]||'';
    return [day,date,week].filter(Boolean).join(' ');
  }
  // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: —É–±–∏—Ä–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –∏ –º—É—Å–æ—Ä
  return hdr.replace('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –Ω–∞ ','')
    .replace(/[^\u0401\u0410-\u044F\u0451\d\s.,()]/g,'')
    .replace(/\s{2,}/g,' ').trim();
}
// ‚îÄ‚îÄ üîä –ó–í–£–ö–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê (Web Audio API, —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∞—è) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SFX = (() => {
  let ctx = null;
  let muted = true; // –ø–æ –¥–µ—Ñ–æ–ª—Ç—É –≤—ã–∫–ª—é—á–µ–Ω–æ

  function ac() {
    if (!ctx) { try { ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
    if (ctx && ctx.state === 'suspended') ctx.resume();
    return ctx;
  }
  const V = 0.5;
  function tone(freq, type, attack, sustain, release, vol=0.18) {
    const c = ac(); if (!c || muted) return;
    const g = c.createGain(), o = c.createOscillator();
    o.type = type; o.frequency.value = freq;
    const v = vol * V;
    g.gain.setValueAtTime(0, c.currentTime);
    g.gain.linearRampToValueAtTime(v, c.currentTime + attack);
    g.gain.setValueAtTime(v, c.currentTime + attack + sustain);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + attack + sustain + release);
    o.connect(g); g.connect(c.destination);
    o.start(c.currentTime); o.stop(c.currentTime + attack + sustain + release + 0.05);
  }
  function sweep(f0, f1, type, dur, vol=0.15) {
    const c = ac(); if (!c || muted) return;
    const g = c.createGain(), o = c.createOscillator();
    o.type = type;
    o.frequency.setValueAtTime(f0, c.currentTime);
    o.frequency.exponentialRampToValueAtTime(f1, c.currentTime + dur * 0.85);
    const v = vol * V;
    g.gain.setValueAtTime(v, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);
    o.connect(g); g.connect(c.destination);
    o.start(c.currentTime); o.stop(c.currentTime + dur + 0.05);
  }
  function noise(dur, vol=0.08, lpFreq=800) {
    const c = ac(); if (!c || muted) return;
    const bufSize = Math.floor(c.sampleRate * dur);
    const buf = c.createBuffer(1, bufSize, c.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);
    const src = c.createBufferSource(); src.buffer = buf;
    const filt = c.createBiquadFilter();
    filt.type = 'lowpass'; filt.frequency.value = lpFreq;
    const g = c.createGain();
    const v = vol * V;
    g.gain.setValueAtTime(v, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);
    src.connect(filt); filt.connect(g); g.connect(c.destination);
    src.start(); src.stop(c.currentTime + dur + 0.05);
  }
  const after = (fn, ms) => setTimeout(fn, ms);

  const sounds = {
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Äî –º—è–≥–∫–∏–µ, –Ω–∏–∑–∫–∏–µ, —Ç—ë–ø–ª—ã–µ
    navHome()     { tone(220,'sine',.03,.06,.28,.10); after(()=>tone(330,'sine',.03,.04,.22,.06),80); },
    navBells()    { tone(440,'sine',.02,.06,.38,.09); after(()=>tone(660,'sine',.02,.03,.28,.05),70); },
    navSettings() { tone(180,'triangle',.03,.05,.22,.08); after(()=>tone(240,'triangle',.03,.03,.18,.05),90); },
    screenPush()  { sweep(200,300,'sine',.14,.08); },
    screenBack()  { sweep(300,180,'sine',.12,.08); },
    themeSelect() { [330,415,494].forEach((f,i)=>after(()=>tone(f,'sine',.02,.06,.26,.07),i*70)); },
    // –ö–Ω–æ–ø–∫–∏ ‚Äî –ø–æ—á—Ç–∏ –Ω–µ—Å–ª—ã—à–Ω—ã–µ —Ç–∏—Ö–∏–µ –∫–∞—Å–∞–Ω–∏—è
    btnClick()    { noise(.025,.018,500); tone(280,'sine',.008,.01,.10,.03); },
    btnAccent()   { sweep(220,360,'sine',.15,.08); },
    keyTap()      { noise(.015,.012,400); },
    // –¢–æ—Å—Ç / —Å—Ç–∞—Ç—É—Å
    toastShow()   { tone(440,'sine',.015,.04,.24,.07); after(()=>tone(550,'sine',.015,.02,.18,.04),90); },
    success()     { [330,415,494,660].forEach((f,i)=>after(()=>tone(f,'sine',.02,.06,.28,.06),i*80)); },
    error()       { tone(160,'triangle',.02,.10,.22,.08); after(()=>tone(130,'triangle',.02,.08,.22,.07),140); },
    // –ü–∞—Å—Ö–∞–ª–∫–∞ / –∏–≥—Ä—ã
    eggOpen()     { [196,247,294,370,494].forEach((f,i)=>after(()=>tone(f,'sine',.02,.06,.30,.06),i*70)); },
    gameSelect()  { sweep(280,420,'sine',.12,.08); },
    // ‚îÄ‚îÄ –ó–º–µ–π–∫–∞ ‚îÄ‚îÄ
    snakeEat()    { tone(440,'sine',.01,.03,.14,.07); after(()=>tone(550,'sine',.01,.02,.10,.04),60); },
    snakeDie()    { sweep(300,80,'sine',.42,.09); after(()=>noise(.20,.04,350),120); },
    snakeTurn()   { noise(.018,.014,600); },
    // ‚îÄ‚îÄ –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ ‚îÄ‚îÄ
    tttPlace()    { tone(360,'sine',.01,.03,.18,.06); },
    tttWin()      { [330,415,494,660,830].forEach((f,i)=>after(()=>tone(f,'sine',.02,.06,.28,.07),i*90)); },
    tttLose()     { sweep(280,120,'sine',.52,.09); },
    tttDraw()     { tone(330,'sine',.02,.18,.28,.06); },
    // ‚îÄ‚îÄ –ü–∏–Ω–≥-–ø–æ–Ω–≥ ‚îÄ‚îÄ
    pongHit()     { noise(.018,.04,800); tone(440,'sine',.005,.01,.08,.04); },
    pongWall()    { noise(.014,.03,600); },
    pongScore()   { sweep(240,420,'sine',.18,.08); },
    pongLose()    { sweep(360,100,'sine',.36,.09); },
    // ‚îÄ‚îÄ –¢–µ—Ç—Ä–∏—Å ‚îÄ‚îÄ
    tetMove()     { noise(.014,.022,700); },
    tetRotate()   { tone(330,'sine',.01,.02,.12,.05); },
    tetLine()     { [294,370,440,587].forEach((f,i)=>after(()=>tone(f,'sine',.01,.05,.20,.07),i*55)); },
    tetDrop()     { noise(.040,.05,500); tone(120,'sine',.01,.04,.16,.07); },
    tetGameOver() { [330,277,233,196].forEach((f,i)=>after(()=>tone(f,'triangle',.02,.10,.28,.08),i*110)); },
    // ‚îÄ‚îÄ –î–∏–Ω–æ ‚îÄ‚îÄ
    dinoJump()    { sweep(220,380,'sine',.15,.07); },
    dinoCactus()  { noise(.050,.06,450); tone(140,'triangle',.01,.06,.18,.07); },
    dinoScore()   { tone(550,'sine',.008,.01,.12,.05); },
    // ‚îÄ‚îÄ Block Blast ‚îÄ‚îÄ
    bbPlace()     { tone(280,'sine',.01,.03,.14,.06); },
    bbLine()      { [330,415,494].forEach((f,i)=>after(()=>tone(f,'sine',.01,.06,.22,.07),i*60)); },
    bbGameOver()  { sweep(240,80,'sine',.50,.09); },
    // ‚îÄ‚îÄ –ê—Ä–∫–∞–Ω–æ–∏–¥ ‚îÄ‚îÄ
    brBrick()     { noise(.020,.05,1000); tone(440,'sine',.004,.01,.09,.04); },
    brWall()      { noise(.016,.035,700); },
    brPaddle()    { noise(.020,.04,800); tone(360,'sine',.005,.01,.08,.04); },
    brLive()      { sweep(420,160,'sine',.32,.09); },
    brLevelUp()   { [294,370,440,587].forEach((f,i)=>after(()=>tone(f,'sine',.02,.06,.26,.07),i*65)); },
    // ‚îÄ‚îÄ –ü—É–∑—ã—Ä–∏ ‚îÄ‚îÄ
    bubPop() {
      const c = ac(); if (!c || muted) return;
      // –°–ª–æ—ë–Ω—ã–π –ø–æ–ø: –æ—Å–Ω–æ–≤–Ω–æ–π ¬´–≤–ª–∞–∂–Ω—ã–π¬ª —â–µ–ª—á–æ–∫ + –ø—Ä–∏–∑–≤—É–∫
      const o = c.createOscillator(), g = c.createGain();
      o.type = 'sine';
      const bf = 180 + Math.random() * 120;
      o.frequency.setValueAtTime(bf * 2.2, c.currentTime);
      o.frequency.exponentialRampToValueAtTime(bf * 0.35, c.currentTime + 0.10);
      const v = 0.13 * V;
      g.gain.setValueAtTime(v, c.currentTime);
      g.gain.linearRampToValueAtTime(v * 1.1, c.currentTime + 0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + 0.22);
      o.connect(g); g.connect(c.destination);
      o.start(); o.stop(c.currentTime + 0.26);
      // –®–ª–µ–ø–æ–∫ –≤–æ–∑–¥—É—Ö–∞
      noise(0.035, 0.05, 320);
    },
    bubMiss()     { sweep(140, 80, 'sine', 0.28, 0.07); after(() => noise(0.04, 0.03, 250), 60); },
    bubCombo()    { [280, 350, 470].forEach((f,i) => after(() => tone(f, 'sine', 0.02, 0.05, 0.22, 0.07), i*55)); },
  };

  return {
    play(name) { try { if (sounds[name]) sounds[name](); } catch(e){} },
    toggle()   { muted = !muted; return muted; },
    isMuted()  { return muted; },
    init()     { ac(); }
  };
})();

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å AudioContext –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∂–µ—Å—Ç–µ
document.addEventListener('click',      () => SFX.init(), {once:true});
document.addEventListener('touchstart', () => SFX.init(), {once:true});

// ‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π btnClick –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —è–≤–Ω–æ–≥–æ SFX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('pointerdown', e => {
  const el = e.target.closest('button,a,[role=button],.btn,.nav-item,.hdr-back,.list-item,.theme-card,.egg-card,.diff-btn,.dpad-btn,.ttt-cell,.dino-ctrl-btn');
  if (!el) return;
  const hasExplicit = el.onclick && ('' + el.onclick).includes('SFX.play');
  if (!hasExplicit) SFX.play('btnClick');
  if (e.target.matches('input,textarea')) SFX.play('keyTap');
});

function toggleMute(){
  const m = SFX.toggle();
  const lbl = document.getElementById('mute-label');
  if (lbl) lbl.textContent = m ? 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω' : 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω';
  if (!m) SFX.play('btnClick');
}
function updateMuteLabel(){
  const el = document.getElementById('mute-label');
  if (el) el.textContent = SFX.isMuted() ? 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω' : 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω';
}

// ‚ïê‚ïê RIPPLE ‚ïê‚ïê
document.addEventListener('click',function(e){
  const el=e.target.closest('.btn,.hdr-back,.last-group-btn,.nav-item,.theme-card,.list-item,.dns-card,.dpi-item,.theme-card');
  if(!el)return;
  const r=document.createElement('span');
  r.className='ripple';
  const rect=el.getBoundingClientRect();
  const size=Math.max(rect.width,rect.height)*2;
  r.style.cssText=`width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px`;
  el.appendChild(r);
  setTimeout(()=>r.remove(),560);
});

// ‚ïê‚ïê –¢–ï–ú–´ ‚ïê‚ïê
const THEMES={
  'orange': {name:'–ö–æ–ª–ª–µ–¥–∂',  ico:'üü†', vars:{'--bg':'#0d0d0d','--surface':'#161616','--surface2':'#1f1f1f','--surface3':'#2a2a2a','--accent':'#e87722','--accent2':'#c45f0a','--text':'#f0ede8','--muted':'#6b6762'},sw:['#0d0d0d','#e87722','#c45f0a']},
  'amoled': {name:'AMOLED',   ico:'‚ö´', vars:{'--bg':'#000','--surface':'#080808','--surface2':'#111','--surface3':'#1a1a1a','--accent':'#00e5ff','--accent2':'#00acc1','--text':'#fff','--muted':'#505050'},sw:['#000','#00e5ff','#00acc1']},
  'win11':  {name:'Win 11',   ico:'üîµ', vars:{'--bg':'#1a1a1a','--surface':'#222','--surface2':'#2d2d2d','--surface3':'#383838','--accent':'#60cdff','--accent2':'#0067c0','--text':'#fff','--muted':'#888'},sw:['#1a1a1a','#60cdff','#0067c0']},
  'pixel':  {name:'Material', ico:'üü£', vars:{'--bg':'#191c1e','--surface':'#22272a','--surface2':'#2c3237','--surface3':'#373d44','--accent':'#7fcfff','--accent2':'#2f71d4','--text':'#e3e5e8','--muted':'#8e9099'},sw:['#191c1e','#7fcfff','#2f71d4']},
  'aero':   {name:'Aero',     ico:'üíé', vars:{'--bg':'#152030','--surface':'#1a2d44','--surface2':'#1f3755','--surface3':'#274466','--accent':'#7fd7ff','--accent2':'#00a8e8','--text':'#e8f4ff','--muted':'#7a9ab8'},sw:['#152030','#7fd7ff','#00a8e8']},
  'forest': {name:'–õ–µ—Å',      ico:'üåø', vars:{'--bg':'#0b1a10','--surface':'#111f15','--surface2':'#182a1d','--surface3':'#213627','--accent':'#4caf7d','--accent2':'#2d8653','--text':'#e0f0e8','--muted':'#6a9076'},sw:['#0b1a10','#4caf7d','#2d8653']},
  'rose':   {name:'–†–æ–∑–æ–≤—ã–π',  ico:'üå∏', vars:{'--bg':'#1a0d12','--surface':'#24111a','--surface2':'#2e1622','--surface3':'#3a1e2d','--accent':'#f472b6','--accent2':'#db2777','--text':'#fce7f3','--muted':'#9d6b80'},sw:['#1a0d12','#f472b6','#db2777']},
  'gold':   {name:'–ó–æ–ª–æ—Ç–æ',   ico:'‚ú®', vars:{'--bg':'#100e00','--surface':'#1a1700','--surface2':'#222000','--surface3':'#2e2a00','--accent':'#f5c518','--accent2':'#c9a000','--text':'#fff9e6','--muted':'#7a7050'},sw:['#100e00','#f5c518','#c9a000']},
  'purple': {name:'–§–∏–æ–ª–µ—Ç',   ico:'ü´ê', vars:{'--bg':'#0e0b1a','--surface':'#151025','--surface2':'#1c1630','--surface3':'#251e3d','--accent':'#a78bfa','--accent2':'#7c3aed','--text':'#ede9fe','--muted':'#7060a0'},sw:['#0e0b1a','#a78bfa','#7c3aed']},
  'sunset': {name:'–ó–∞–∫–∞—Ç',    ico:'üåÖ', vars:{'--bg':'#0f0a00','--surface':'#1a1000','--surface2':'#241800','--surface3':'#302200','--accent':'#ff6b35','--accent2':'#c94a10','--text':'#fff3ee','--muted':'#7a5040'},sw:['#0f0a00','#ff6b35','#c94a10']},
  'bw':     {name:'–ß/–ë',      ico:'‚¨ú', vars:{'--bg':'#000','--surface':'#111','--surface2':'#1c1c1c','--surface3':'#2a2a2a','--accent':'#ffffff','--accent2':'#cccccc','--text':'#ffffff','--muted':'#666666'},sw:['#000','#fff','#888']},
  'glass':  {name:'Liquid Glass', ico:'ü´ß', vars:{'--bg':'#0a0f1e','--surface':'rgba(255,255,255,0.07)','--surface2':'rgba(255,255,255,0.11)','--surface3':'rgba(255,255,255,0.18)','--accent':'#a0c4ff','--accent2':'#7b9fff','--text':'#f0f4ff','--muted':'rgba(180,190,220,0.7)'},sw:['#0a0f1e','#a0c4ff','#7b9fff']},
  'light':  {name:'–°–≤–µ—Ç–ª–∞—è',  ico:'‚òÄÔ∏è', vars:{'--bg':'#f4f4f4','--surface':'#fff','--surface2':'#ebebeb','--surface3':'#d8d8d8','--accent':'#e87722','--accent2':'#c45f0a','--text':'#111','--muted':'#888'},sw:['#f4f4f4','#e87722','#c45f0a']},
};

// ‚ïê‚ïê DNS –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã ‚ïê‚ïê
const DNS_PROVIDERS={
  'system': {name:'–°–∏—Å—Ç–µ–º–Ω—ã–π',  addr:'–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', ico:'üåê', doh:''},
  'cf':     {name:'Cloudflare', addr:'1.1.1.1',       ico:'üü†', doh:'https://1.1.1.1/dns-query'},
  'google': {name:'Google',     addr:'8.8.8.8',       ico:'üîµ', doh:'https://8.8.8.8/dns-query'},
  'adguard':{name:'AdGuard',    addr:'94.140.14.14',  ico:'üü¢', doh:'https://dns.adguard.com/dns-query'},
  'yandex': {name:'–Ø–Ω–¥–µ–∫—Å',     addr:'77.88.8.8',     ico:'üî¥', doh:'https://common.dot.dns.yandex.net/dns-query'},
  'custom': {name:'–°–≤–æ–π...',    addr:'DoH URL',       ico:'‚öôÔ∏è', doh:'custom'},
};

// ‚ïê‚ïê –ü–†–û–ö–°–ò –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã ‚ïê‚ïê
// format:
//   'append_encoded' ‚Üí proxy_url + encodeURIComponent(target)
//   'append_raw'     ‚Üí proxy_url + target (URL –Ω–µ –∫–æ–¥–∏—Ä—É–µ—Ç—Å—è)
//   'query_url'      ‚Üí proxy_url + encodeURIComponent(target) (—Ç–æ –∂–µ —á—Ç–æ append_encoded, –¥—Ä—É–≥–æ–π –∫–ª—é—á)
const PROXY_PROVIDERS = {
  'allorigins': {
    name: 'AllOrigins',
    addr: 'api.allorigins.win',
    ico: 'üîì',
    tag: 'tag-free',
    tagText: '–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
    desc: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ–∫—Å–∏. –ë–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ base64.',
    url: 'https://api.allorigins.win/raw?url=',
    format: 'query_url',
  },
  'corsproxy': {
    name: 'corsproxy.io',
    addr: 'corsproxy.io',
    ico: 'üåê',
    tag: 'tag-free',
    tagText: '–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
    desc: '–ë—ã—Å—Ç—Ä—ã–π. –ú–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–∏ –ª–∏–º–∏—Ç–µ.',
    url: 'https://corsproxy.io/?url=',
    format: 'query_url',
  },
  'codetabs': {
    name: 'CodeTabs',
    addr: 'api.codetabs.com',
    ico: 'üì¶',
    tag: 'tag-free',
    tagText: '–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
    desc: '–ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã.',
    url: 'https://api.codetabs.com/v1/proxy?quest=',
    format: 'append_raw',
  },
  'thingproxy': {
    name: 'ThingProxy',
    addr: 'thingproxy.freeboard.io',
    ico: 'üîÅ',
    tag: 'tag-free',
    tagText: '–±–µ—Å–ø–ª–∞—Ç–Ω–æ',
    desc: '–ü—Ä–æ—Å—Ç–æ–π CORS-–ø—Ä–æ–∫—Å–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ç–∏–ø—É.',
    url: 'https://thingproxy.freeboard.io/fetch/',
    format: 'append_raw',
  },
  'corsanywhere': {
    name: 'CORS Anywhere',
    addr: 'cors-anywhere.herokuapp.com',
    ico: 'üåç',
    tag: 'tag-limit',
    tagText: '–Ω—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å',
    desc: '–ù—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –∏ –Ω–∞–∂–∞—Ç—å Request Access.',
    url: 'https://cors-anywhere.herokuapp.com/',
    format: 'append_raw',
  },
  'cf_worker': {
    name: 'Cloudflare Worker',
    addr: 'your-proxy.workers.dev',
    ico: '‚òÅÔ∏è',
    tag: 'tag-own',
    tagText: '—Å–≤–æ–π',
    desc: '–°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π. –î–µ–ø–ª–æ–π –∑–∞ 5 –º–∏–Ω, 100k/–¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ.',
    url: '',
    format: 'append_encoded',
  },
  'custom': {
    name: '–°–≤–æ–π URL',
    addr: '–ª—é–±–æ–π –∞–¥—Ä–µ—Å',
    ico: '‚öôÔ∏è',
    tag: 'tag-own',
    tagText: '—Å–≤–æ–π',
    desc: '–í–≤–µ–¥–∏ –∞–¥—Ä–µ—Å —Å–≤–æ–µ–≥–æ –ø—Ä–æ–∫—Å–∏ –≤—Ä—É—á–Ω—É—é.',
    url: '',
    format: 'append_encoded',
  },
};

// ‚ïê‚ïê DPI —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–Ω–∞ –æ—Å–Ω–æ–≤–µ ByeByeDPI) ‚ïê‚ïê
// cmd ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è ciadpi, –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ DnsVpnService
// {sni} –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ www.iana.org
const DPI_STRATEGIES = [
  {id:'auto',       badge:'AUTO',   name:'–ê–≤—Ç–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)', cmd:'-Ku -a1 -An -o1 -At,r,s -d1',
    desc:'–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ByeByeDPI. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–≤—ã–º.'},
  {id:'preset1',    badge:'P-1',    name:'Preset 1 ‚Äî multisplit',
    cmd:'-f-200 -Qr -s3:5+sm -a1 -As -d1 -s4+sm -s8+sh -f-300 -d6+sh -a1 -At,r,s -o2 -f-30 -As -r5 -Mh -r6+sh -f-250 -s2:7+s -s3:6+sm -a1 -At,r,s -s3:5+sm -s6+s -s7:9+s -q30+sm -a1',
    desc:'–ú–Ω–æ–≥–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ. –•–æ—Ä–æ—à –¥–ª—è –º–Ω–æ–≥–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.'},
  {id:'preset2',    badge:'P-2',    name:'Preset 2 ‚Äî disorder split',
    cmd:'-d1 -d3+s -s6+s -d9+s -s12+s -d15+s -s20+s -d25+s -s30+s -d35+s -r1+s -S -a1 -As -d1 -d3+s -s6+s -d9+s -s12+s -d15+s -s20+s -d25+s -s30+s -d35+s -S -a1',
    desc:'–ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ disorder –∏ split –ø–æ –ø–æ–∑–∏—Ü–∏—è–º.'},
  {id:'preset3',    badge:'P-3',    name:'Preset 3 ‚Äî OOB + mixedcase',
    cmd:'-q2 -s2 -s3+s -r3 -s4 -r4 -s5+s -r5+s -s6 -s7+s -r8 -s9+s -Qr -Mh,d,r -a1 -At,r -s2+s -r2 -d2 -s3 -r3 -r4 -s4 -d5+s -r5 -d6 -s7+s -d7 -a1',
    desc:'OOB —Å –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º.'},
  {id:'preset4',    badge:'P-4',    name:'Preset 4 ‚Äî S+disorder combo',
    cmd:'-o1 -d1 -a1 -At,r,s -s1 -d1 -s5+s -s10+s -s15+s -s20+s -r1+s -S -a1 -As -s1 -d1 -s5+s -s10+s -s15+s -s20+s -S -a1',
    desc:'–ö–æ–º–±–∏–Ω–∞—Ü–∏—è OOB –∏ disorder —Å–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø–æ–∑–∏—Ü–∏–π.'},
  {id:'preset5',    badge:'P-5',    name:'Preset 5 ‚Äî Fake TLS + split',
    cmd:'-n www.iana.org -Qr -f-204 -s1:5+sm -a1 -As -d1 -s3+s -s5+s -q7 -a1 -As -o2 -f-43 -a1 -As -r5 -Mh -s1:5+s -s3:7+sm -a1',
    desc:'–ü–æ–¥–¥–µ–ª—å–Ω—ã–π TLS –ø–∞–∫–µ—Ç + –º–Ω–æ–≥–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ.'},
  {id:'preset6',    badge:'P-6',    name:'Preset 6 ‚Äî Fake TLS variant',
    cmd:'-n www.iana.org -Qr -f-205 -a1 -As -s1:3+sm -a1 -As -s5:8+sm -a1 -As -d3 -q7 -o2 -f-43 -f-85 -f-165 -r5 -Mh -a1',
    desc:'–î—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç fake TLS —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–º–µ—â–µ–Ω–∏—è–º–∏.'},
  {id:'preset7',    badge:'P-7',    name:'Preset 7 ‚Äî big split+fake',
    cmd:'-d1+s -s50+s -a1 -As -f20 -r2+s -a1 -At -d2 -s1+s -s5+s -s10+s -s15+s -s25+s -s35+s -s50+s -s60+s -a1',
    desc:'–ö—Ä—É–ø–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è + fake –ø–∞–∫–µ—Ç—ã.'},
  {id:'preset8',    badge:'P-8',    name:'Preset 8 ‚Äî SNI fake + S chain',
    cmd:'-o1 -a1 -At,r,s -f-1 -a1 -At,r,s -d1:11+sm -S -a1 -At,r,s -n www.iana.org -Qr -f1 -d1:11+sm -s1:11+sm -S -a1',
    desc:'–¶–µ–ø–æ—á–∫–∞ SNI-fake –∏ –º–Ω–æ–≥–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–æ–≥–æ S.'},
  {id:'preset9',    badge:'P-9',    name:'Preset 9 ‚Äî SACK drop',
    cmd:'-d1 -s1 -q1 -Y -a1 -Ar -s5 -o1+s -d3+s -s6+s -d9+s -s12+s -d15+s -s20+s -d25+s -s30+s -d35+s -a1',
    desc:'–û—Ç–∫–ª—é—á–µ–Ω–∏–µ SACK + disorder –ø–æ –≤—Å–µ–º –ø–æ–∑–∏—Ü–∏—è–º.'},
  {id:'preset10',   badge:'P-10',   name:'Preset 10 ‚Äî Fake+TLSrec+Mh',
    cmd:'-f1+nme -t6 -a1 -As -n www.iana.org -Qr -s1:6+sm -a1 -As -s5:12+sm -a1 -As -d3 -q7 -r6 -Mh -a1',
    desc:'Fake —Å TLS-record split –∏ —Å–º–µ—à–∞–Ω–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–º.'},
  {id:'preset11',   badge:'P-11',   name:'Preset 11 ‚Äî OOB SACK chain A',
    cmd:'-s1 -o1 -a1 -Y -Ar -s5 -o1+s -a1 -At -f-1 -r1+s -a1 -As -s1 -o1+s -s-1 -a1',
    desc:'–¶–µ–ø–æ—á–∫–∞ OOB —Å SACK drop.'},
  {id:'preset12',   badge:'P-12',   name:'Preset 12 ‚Äî OOB SACK chain B',
    cmd:'-s1 -d1 -a1 -Y -Ar -d5 -o1+s -a1 -At -f-1 -r1+s -a1 -As -d1 -o1+s -s-1 -a1',
    desc:'–í–∞—Ä–∏–∞–Ω—Ç —Ü–µ–ø–æ—á–∫–∏ OOB+SACK —Å disorder.'},
  {id:'preset13',   badge:'P-13',   name:'Preset 13 ‚Äî light disorder',
    cmd:'-d1 -s1+s -d3+s -s6+s -d9+s -s12+s -d15+s -s20+s -d25+s -s30+s -d35+s -a1',
    desc:'–õ—ë–≥–∫–∏–π disorder –ø–æ –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–º –ø–æ–∑–∏—Ü–∏—è–º.'},
  {id:'preset14',   badge:'P-14',   name:'Preset 14 ‚Äî minimal OOB',
    cmd:'-s1 -q1 -a1 -Y -Ar -a1 -s5 -o2 -At -f-1 -r1+s -a1 -As -s1 -o1+s -s-1 -a1',
    desc:'–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π OOB —Å SACK drop.'},
  {id:'preset19',   badge:'P-19',   name:'Preset 19 ‚Äî triple OOB',
    cmd:'-o1 -a1 -At,r,s -f-1 -a1 -Ar,s -o1 -a1 -At -r1+s -f-1 -t6 -a1',
    desc:'–¢—Ä–æ–π–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ OOB —Ä–∞–∑–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏.'},
  {id:'split_basic',badge:'SPLIT',  name:'Split ‚Äî –±–∞–∑–æ–≤—ã–π',
    cmd:'-s1 -a1 -An',
    desc:'–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –±–∞–π—Ç–∞ TLS ClientHello.'},
  {id:'disorder',   badge:'DIS',    name:'Disorder ‚Äî –±–∞–∑–æ–≤—ã–π',
    cmd:'-d1 -a1 -An',
    desc:'Disorder –ø–µ—Ä–≤–æ–≥–æ –±–∞–π—Ç–∞ TLS.'},
  {id:'fake',       badge:'FAKE',   name:'Fake ‚Äî –±–∞–∑–æ–≤—ã–π',
    cmd:'-f-1 -t5 -n www.iana.org -a1 -An',
    desc:'–ü–æ–¥–¥–µ–ª—å–Ω—ã–π TLS –ø–∞–∫–µ—Ç —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º SNI.'},
  {id:'oob',        badge:'OOB',    name:'OOB ‚Äî –±–∞–∑–æ–≤—ã–π',
    cmd:'-o1 -a1 -An',
    desc:'Out-of-band –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏.'},
  {id:'disoob',     badge:'DOOB',   name:'DisOOB ‚Äî –±–∞–∑–æ–≤—ã–π',
    cmd:'-q1 -a1 -An',
    desc:'–ö–æ–º–±–∏–Ω–∞—Ü–∏—è disorder+OOB.'},
];
// ‚ïê‚ïê –ó–í–û–ù–ö–ò ‚ïê‚ïê
const BELL_MON={'I':['09:00','09:45','09:50','10:35'],'II':['10:45','11:30','11:35','12:20'],'III':['12:50','13:35','13:40','14:25'],'IV':['14:35','15:35',null,null],'V':['15:45','16:45',null,null],'VI':['16:55','17:55',null,null]};
const BELL_TUE={'I':['08:30','09:15','09:20','10:05'],'II':['10:15','11:00','11:05','11:50'],'III':['12:20','13:05','13:10','13:55'],'IV':['14:05','15:05',null,null],'V':['15:15','16:15',null,null],'VI':['16:25','17:25',null,null]};

// ‚ïê‚ïê OLE2 –ü–ê–†–°–ï–† ‚ïê‚ïê
function u32(buf,off){return new DataView(buf instanceof Uint8Array?buf.buffer:buf,buf instanceof Uint8Array?buf.byteOffset:0).getUint32(off,true)}
function u16(buf,off){return new DataView(buf instanceof Uint8Array?buf.buffer:buf,buf instanceof Uint8Array?buf.byteOffset:0).getUint16(off,true)}
function ole2Text(ab){
  const sig=[0xD0,0xCF,0x11,0xE0,0xA1,0xB1,0x1A,0xE1];
  if(ab.byteLength<512)return'';
  const arr=new Uint8Array(ab);
  for(let i=0;i<8;i++)if(arr[i]!==sig[i])return'';
  const ss=Math.pow(2,u16(ab,30));
  const difat=[];
  for(let i=0;i<Math.min(109,u32(ab,44));i++){const v=u32(ab,76+i*4);if(v>=0xFFFFFFFC)break;difat.push(v);}
  const fat=[];
  for(const sn of difat){const off=512+sn*ss;for(let i=0;i<ss/4;i++){const p=off+i*4;if(p+4<=ab.byteLength)fat.push(u32(ab,p));}}
  function rd(sec,maxSz){
    const chunks=[];let total=0;const vis=new Set();
    while(sec!==0xFFFFFFFE&&sec!==0xFFFFFFFF&&!vis.has(sec)){
      vis.add(sec);const off=512+sec*ss;if(off>=ab.byteLength)break;
      const len=Math.min(ss,ab.byteLength-off);chunks.push(new Uint8Array(ab,off,len));total+=len;
      if(maxSz&&total>=maxSz)break;if(sec>=fat.length)break;sec=fat[sec];
    }
    const out=new Uint8Array(maxSz?Math.min(total,maxSz):total);let pos=0;
    for(const c of chunks){const take=Math.min(c.length,out.length-pos);out.set(c.slice(0,take),pos);pos+=take;if(pos>=out.length)break;}
    return out;
  }
  const dd=rd(u32(ab,48));
  let ws=0,wz=0;
  for(let i=0;i<Math.floor(dd.length/128);i++){
    const e=dd.slice(i*128,(i+1)*128);if(e.length<128)break;
    const nl=e[64]|e[65]<<8;
    const nm=nl>=2?new TextDecoder('utf-16le').decode(e.slice(0,nl-2)):'';
    if(nm==='WordDocument'){const dv=new DataView(dd.buffer,dd.byteOffset+i*128);ws=dv.getUint32(116,true);wz=dv.getUint32(120,true);break;}
  }
  if(!wz)return'';
  const wsd=rd(ws,wz);if(wsd.length<32)return'';
  const dv=new DataView(wsd.buffer,wsd.byteOffset);
  const fc=dv.getUint32(24,true),cc=dv.getUint32(28,true);
  if(fc>=wsd.length)return'';
  return new TextDecoder('utf-16le').decode(wsd.slice(fc,fc+cc*2));
}
function getCells(ab){
  const t=ole2Text(ab);
  if(!t)return[];
  return t.split('\x07').map(c=>{
    // –§–∏–ª—å—Ç—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω—ã–π –º—É—Å–æ—Ä: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    // –°—Ç—Ä–æ–≥–∏–π –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: ASCII-printable + —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä—É—Å—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç (–ê-–Ø –∞-—è –Å—ë)
    // –≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –º—É—Å–æ—Ä–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã (–Ç U+0402, –Ä U+0400 –∏ —Ç.–ø.)
    const clean = c
      .replace(/\r/g,'\n')
      .replace(/[^\x09\x0A\x20-\x7E\u0401\u0410-\u044F\u0451¬´¬ª‚Ññ]/g,'')
      // –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≥–¥–µ >60% —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî –Ω–µ—á–∏—Ç–∞–µ–º—ã–µ (–±–∏–Ω–∞—Ä–Ω—ã–π –º—É—Å–æ—Ä)
      .split('\n')
      .map(line => {
        if (!line.trim()) return line;
        const readable = (line.match(/[\u0401\u0410-\u044F\u0451A-Za-z\u0030-\u0039\s.,;:!?\-+=%()¬´¬ª"'‚Ññ]/g) || []).length;
        const ratio = readable / line.length;
        return ratio > 0.35 || line.length < 5 ? line : '';
      })
      .join('\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
    return clean;
  });
}
const GRP=/^[–ê-–Ø–ÅA-Z0-9]{1,5}[\-]?\d[\-]\d{2}$/u;
const GRP_SEARCH=/\b([–ê-–Ø–ÅA-Z0-9]{1,5}[\-]?\d[\-]\d{2})\b/gu;
const ROM=/^(I{1,3}V?|VI{0,3}|IV)$/;
const HDR=/–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π/i;
function norm(s){return s.trim().toUpperCase().replace(/[\s\-\.]/g,'')}
function detectGroups(ab){
  const seen={};
  for(const c of getCells(ab)){
    const t=c.trim();
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if(GRP.test(t)){const k=norm(t);if(!seen[k])seen[k]=t;continue;}
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —è—á–µ–π–∫–∏
    const singleLine=t.split('\n')[0].trim();
    if(GRP.test(singleLine)){const k=norm(singleLine);if(!seen[k])seen[k]=singleLine;continue;}
    // –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–∞ –≥—Ä—É–ø–ø—ã –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞ —è—á–µ–π–∫–∏
    GRP_SEARCH.lastIndex=0;
    let m;
    while((m=GRP_SEARCH.exec(t))!==null){const k=norm(m[1]);if(!seen[k])seen[k]=m[1];}
  }
  return Object.values(seen).sort();
}
function parseDoc(ab,group){
  const cells=getCells(ab),tn=norm(group),labels=[];
  cells.forEach((c,i)=>{if(HDR.test(c))labels.push(i);});
  if(!labels.length)return{sched:[],hdr:''};
  labels.push(cells.length);
  for(let bi=0;bi<labels.length-1;bi++){
    let li=labels[bi],nx=labels[bi+1],gs=li+1;
    while(gs<nx&&!GRP.test(cells[gs]))gs++;
    if(gs>=nx)continue;
    let ge=gs;while(ge<nx&&GRP.test(cells[ge]))ge++;
    const fi=[...Array(ge-gs).keys()].map(j=>gs+j).find(i=>norm(cells[i])===tn);
    if(fi===undefined)continue;
    const off=fi-li;
    const hdr=cells[li].split('\n').find(l=>HDR.test(l))?.trim()||'';
    const sched=[],seen=new Set();
    for(let ri=ge;ri<nx;ri++){
      const c=cells[ri];
      if(ROM.test(c)&&!seen.has(c)){seen.add(c);const li2=ri+off;sched.push([c,li2<cells.length?cells[li2].trim():''|'']);}
    }
    return{sched,hdr};
  }
  return{sched:[],hdr:''};
}

// ‚ïê‚ïê –°–û–°–¢–û–Ø–ù–ò–ï ‚ïê‚ïê
const DEFAULT_URL='https://disk.yandex.ru/d/mjhoc7kysmQEuQ';
const S={
  url:DEFAULT_URL,files:[],selectedFile:null,lastGroup:'',
  theme:'orange',dns:'system',customDns:'',dpi:'general',
  customProxy:'',proxyProvider:'allorigins',
  appIcon:'orange',liquidGlass:false,liquidGlassOpt:false,customBg:''
};
const FILE_CACHE={};
let allGroups=[];

const _mem={};
const stor={
  get(k){try{return localStorage.getItem(k);}catch(e){return _mem[k]||null;}},
  set(k,v){try{localStorage.setItem(k,v);}catch(e){_mem[k]=v;}}
};
function loadLocal(){
  try{
    const d=JSON.parse(stor.get('sched')||'{}');
    S.lastGroup=d.group||'';
    S.theme=d.theme||'orange';
    // Migrate: if old users had glass as theme, switch to orange + enable glass mode
    if(S.theme==='glass'){S.theme='orange';S.liquidGlass=true;}
    else S.liquidGlass=d.liquidGlass||false;
    S.liquidGlassOpt=d.liquidGlassOpt||false;
    S.customBg=d.customBg||'';
    S.url=d.url||DEFAULT_URL;
    S.dns=d.dns||'system';
    S.customDns=d.customDns||'';
    S.dpi=d.dpi||'general';
    S.customProxy=d.customProxy||'';
    S.proxyProvider=d.proxyProvider||'corsproxy';
    S.appIcon=d.appIcon||'orange';
    const inp=document.getElementById('url-input');
    if(inp)inp.value=S.url;
    const pi=document.getElementById('proxy-input');
    if(pi)pi.value=S.customProxy;
    const ci=document.getElementById('custom-dns-input');
    if(ci)ci.value=S.customDns;
  }catch(e){}
}
function saveLocal(){
  stor.set('sched',JSON.stringify({
    group:S.lastGroup,theme:S.theme,url:S.url,
    dns:S.dns,customDns:S.customDns,dpi:S.dpi,customProxy:S.customProxy,proxyProvider:S.proxyProvider,
    appIcon:S.appIcon,liquidGlass:S.liquidGlass,liquidGlassOpt:S.liquidGlassOpt,
    customBg:S.customBg
  }));
}

// ‚ïê‚ïê –ü–†–û–ö–°–ò ‚ïê‚ïê
function buildProxyUrl(proxyBaseUrl, format, targetUrl) {
  if (format === 'append_raw') return proxyBaseUrl + targetUrl;
  // query_url and append_encoded both encode
  return proxyBaseUrl + encodeURIComponent(targetUrl);
}

function getActiveProxy() {
  const key = S.proxyProvider || 'allorigins';
  const p = PROXY_PROVIDERS[key] || PROXY_PROVIDERS['allorigins'];
  let url = p.url;
  if (key === 'cf_worker' || key === 'custom') {
    url = S.customProxy ? (S.customProxy.endsWith('/') ? S.customProxy : S.customProxy + '/') : '';
  }
  return { url, format: p.format || 'query_url', provider: key };
}

function renderProxyList() {
  const list = document.getElementById('proxy-list-screen'); if (!list) return;
  list.innerHTML = '';
  Object.entries(PROXY_PROVIDERS).forEach(([key, p]) => {
    const sel = S.proxyProvider === key;
    const card = document.createElement('div');
    card.className = 'proxy-card' + (sel ? ' selected' : '');
    card.innerHTML =
      '<div class="proxy-ico">' + p.ico + '</div>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="display:flex;align-items:center">' +
          '<div class="proxy-name">' + p.name + '</div>' +
          '<span class="proxy-tag ' + p.tag + '">' + p.tagText + '</span>' +
        '</div>' +
        '<div class="proxy-addr">' + p.addr + '</div>' +
        '<div class="proxy-desc">' + p.desc + '</div>' +
      '</div>' +
      '<div class="proxy-check">‚úì</div>';
    card.onclick = () => selectProxy(key);
    list.appendChild(card);
  });
  // Show/hide custom input
  const needInput = (S.proxyProvider === 'cf_worker' || S.proxyProvider === 'custom');
  const wrap = document.getElementById('custom-proxy-screen-wrap');
  if (wrap) wrap.classList.toggle('hidden', !needInput);
  const inp = document.getElementById('proxy-input-screen');
  if (inp) inp.value = S.customProxy || '';
}

function updateProxyCurrentRow() {
  const p = PROXY_PROVIDERS[S.proxyProvider] || PROXY_PROVIDERS['allorigins'];
  const nameEl = document.getElementById('proxy-current-name');
  const subEl  = document.getElementById('proxy-current-sub');
  if (nameEl) nameEl.textContent = p.name;
  if (subEl)  subEl.textContent  = p.addr + ' ‚Ä¢ ' + p.tagText;
  const statusEl = document.getElementById('proxy-status');
  if (statusEl) statusEl.textContent = '';
}

function selectProxy(key) {
  S.proxyProvider = key; saveLocal();
  renderProxyList();
  updateProxyCurrentRow();
  toast('–ü—Ä–æ–∫—Å–∏: ' + (PROXY_PROVIDERS[key]?.name || key));
  // –ï—Å–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –±—ã–ª–∞ –æ—à–∏–±–∫–∞ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
  const err = document.getElementById('home-error-hint');
  if (err && !err.classList.contains('hidden') && key !== 'cf_worker' && key !== 'custom') {
    loadFiles();
  }
}

function saveCustomProxyFromScreen() {
  const v = (document.getElementById('proxy-input-screen')?.value || '').trim();
  S.customProxy = v; saveLocal();
  if (document.getElementById('proxy-input')) document.getElementById('proxy-input').value = v;
  toast(v ? '–ü—Ä–æ–∫—Å–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–ê–¥—Ä–µ—Å –ø—Ä–æ–∫—Å–∏ –æ—á–∏—â–µ–Ω');
  updateProxyCurrentRow();
  if (v) {
    const err = document.getElementById('home-error-hint');
    if (err && !err.classList.contains('hidden')) loadFiles();
  }
}

// legacy, keep for backward compat
function saveProxy() { saveCustomProxyFromScreen(); }
function saveCustomProxy() { saveCustomProxyFromScreen(); }
function renderProxyGrid() { renderProxyList(); }

async function testCurrentProxy() {
  const btn = document.getElementById('proxy-test-btn');
  const status = document.getElementById('proxy-test-status');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...'; }
  if (status) status.textContent = '';
  try {
    const {url: pBase, format, provider} = getActiveProxy();
    if (!pBase) throw new Error('–ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    const testUrl = 'https://cloud-api.yandex.net/v1/disk/public/resources?public_key=test&limit=1';
    const proxyUrl = buildProxyUrl(pBase, format, testUrl);
    const r = await fetch(proxyUrl, {signal: AbortSignal.timeout(10000)});
    // 404 from Yandex is fine ‚Äî means proxy works
    const ok = r.status < 500;
    if (status) status.textContent = ok
      ? '‚úÖ –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! HTTP ' + r.status
      : '‚ùå –û—à–∏–±–∫–∞: HTTP ' + r.status;
  } catch(e) {
    if (status) status.textContent = '‚ùå ' + e.message;
  }
  if (btn) { btn.disabled = false; btn.textContent = 'üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ'; }
}
// ‚ïê‚ïê –ù–ê–¢–ò–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê (Android Java, –±–µ–∑ CORS) ‚ïê‚ïê
// –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤ Android-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã.
// –ò–Ω–∞—á–µ (–±—Ä–∞—É–∑–µ—Ä/—Ç–µ—Å—Ç) ‚Äî fallback –Ω–∞ CORS-–ø—Ä–æ–∫—Å–∏.

async function nativeGet(url) {
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π @JavascriptInterface —á–µ—Ä–µ–∑ Promise + setTimeout
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      try {
        const resStr = window.Android.nativeFetch(url);
        const res = JSON.parse(resStr);
        if (!res.ok) reject(new Error('HTTP ' + (res.status || 0) + (res.error ? ' ‚Äî ' + res.error : '')));
        else resolve(JSON.parse(res.body));
      } catch(e) { reject(e); }
    }, 0);
  });
}

async function nativeDownloadBuf(url) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      try {
        const resStr = window.Android.nativeDownloadBase64(url);
        const res = JSON.parse(resStr);
        if (!res.ok) reject(new Error(res.error || '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'));
        else resolve(base64ToArrayBuffer(res.base64));
      } catch(e) { reject(e); }
    }, 0);
  });
}

async function yadGet(path, params) {
  const qs = new URLSearchParams(params).toString();
  const raw = `https://cloud-api.yandex.net${path}?${qs}`;

  if (window.Android && window.Android.nativeFetch) {
    // –ù–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å ‚Äî –±–µ–∑ CORS
    const data = await nativeGet(raw);
    const el = document.getElementById('proxy-status');
    if (el) el.textContent = '‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
    return data;
  }

  // Fallback: CORS-–ø—Ä–æ–∫—Å–∏ (–±—Ä–∞—É–∑–µ—Ä/–¥–µ–±–∞–≥)
  const {url: pBase, format} = getActiveProxy();
  if (!pBase) throw new Error('–ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –í—ã–±–µ—Ä–∏ –ø—Ä–æ–∫—Å–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
  const proxyUrl = buildProxyUrl(pBase, format, raw);
  const r = await fetch(proxyUrl, {signal: AbortSignal.timeout(15000)});
  if (!r.ok) throw new Error(`–ü—Ä–æ–∫—Å–∏ –≤–µ—Ä–Ω—É–ª HTTP ${r.status}`);
  const el = document.getElementById('proxy-status');
  if (el) el.textContent = '‚úÖ ' + (PROXY_PROVIDERS[S.proxyProvider]?.name || S.proxyProvider);
  return r.json();
}

async function yadDownload(rawUrl, filename) {
  if (window.Android && window.Android.nativeDownloadBase64) {
    // –ù–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å ‚Äî –±–µ–∑ CORS, –Ω–∞–¥—ë–∂–Ω–æ
    return await nativeDownloadBuf(rawUrl);
  }

  // Fallback: CORS-–ø—Ä–æ–∫—Å–∏
  const {url: pBase, format, provider} = getActiveProxy();
  if (!pBase) throw new Error('–ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û—Ç–∫—Ä–æ–π –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü—Ä–æ–∫—Å–∏');
  if (provider === 'allorigins') return await yadDownloadAllOrigins(rawUrl);
  const proxyUrl = buildProxyUrl(pBase, format, rawUrl);
  try {
    const r = await fetch(proxyUrl, {signal: AbortSignal.timeout(30000)});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('text/html') && !filename?.toLowerCase().endsWith('.html'))
      throw new Error('–ü—Ä–æ–∫—Å–∏ –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞');
    return r.arrayBuffer();
  } catch(e) {
    try { return await yadDownloadAllOrigins(rawUrl); }
    catch(e2) { throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: ' + e.message); }
  }
}

async function yadDownloadAllOrigins(rawUrl) {
  const aoUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(rawUrl);
  const r = await fetch(aoUrl, {signal: AbortSignal.timeout(45000)});
  if (!r.ok) throw new Error('AllOrigins HTTP ' + r.status);
  const data = await r.json();
  if (!data.contents) throw new Error('AllOrigins –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
  const contents = data.contents;
  if (typeof contents === 'string' && contents.startsWith('data:'))
    return base64ToArrayBuffer(contents.split(',')[1]);
  return new TextEncoder().encode(contents).buffer;
}

function base64ToArrayBuffer(b64) {
  const bin = atob(b64);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

// ‚ïê‚ïê –ò–ö–û–ù–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ‚ïê‚ïê
const ICON_VARIANTS = {
  orange:  {label:'–û—Ä–∞–Ω–∂–µ–≤–∞—è',  ico:'üü†', bg:'#0d0d0d', accent:'#e87722', accent2:'#c45f0a', style:'gradient-warm'},
  amoled:  {label:'AMOLED',     ico:'‚ö´', bg:'#000000', accent:'#00e5ff', accent2:'#0088aa', style:'glow-cyan'},
  samek:   {label:'–°–∞–ú–µ–ö',      ico:'üîµ', bg:'#10388A', accent:'#7FBBFF', accent2:'#4a7fd4', style:'gradient-blue'},
  purple:  {label:'–§–∏–æ–ª–µ—Ç',     ico:'ü´ê', bg:'#0e0b1a', accent:'#a78bfa', accent2:'#7c3aed', style:'glow-purple'},
  forest:  {label:'–õ–µ—Å',        ico:'üåø', bg:'#0b1a10', accent:'#4caf7d', accent2:'#2d8653', style:'glow-green'},
  gold:    {label:'–ó–æ–ª–æ—Ç–æ',     ico:'‚ú®', bg:'#100e00', accent:'#f5c518', accent2:'#c9a000', style:'glow-gold'},
  glass:   {label:'–°—Ç–µ–∫–ª–æ',     ico:'ü´ß', bg:'#0a0f1e', accent:'#a0c4ff', accent2:'#7b9fff', style:'glass'},
  win11:   {label:'Win 11',     ico:'üîµ', bg:'#1a1a1a', accent:'#60cdff', accent2:'#0067c0', style:'flat'},
  pixel:   {label:'Material',   ico:'üü£', bg:'#191c1e', accent:'#7fcfff', accent2:'#2f71d4', style:'flat'},
  aero:    {label:'Aero',       ico:'üíé', bg:'#152030', accent:'#7fd7ff', accent2:'#00a8e8', style:'flat'},
  rose:    {label:'–†–æ–∑–æ–≤—ã–π',    ico:'üå∏', bg:'#1a0d12', accent:'#f472b6', accent2:'#db2777', style:'flat'},
  sunset:  {label:'–ó–∞–∫–∞—Ç',      ico:'üåÖ', bg:'#0f0a00', accent:'#ff6b35', accent2:'#c94a10', style:'flat'},
  bw:      {label:'–ß/–ë',        ico:'‚¨ú', bg:'#000000', accent:'#ffffff', accent2:'#888888', style:'flat'},
  light:   {label:'–°–≤–µ—Ç–ª–∞—è',    ico:'‚òÄÔ∏è', bg:'#f4f4f4', accent:'#e87722', accent2:'#c45f0a', style:'flat'},
  candy:   {label:'–ö–æ–Ω—Ñ–µ—Ç–∫–∞',   ico:'üç≠', bg:'#1A0A12', accent:'#FF4DA6', accent2:'#d91a75', style:'flat'},
  ocean:   {label:'–û–∫–µ–∞–Ω',      ico:'üåä', bg:'#0A1520', accent:'#00B4D8', accent2:'#0077B6', style:'flat'},
};

// Draw CK icon preview on a canvas element
function drawIconPreview(canvas, variant) {
  const size = canvas.width;
  const ctx = canvas.getContext('2d');
  const t = variant;

  // Background
  if (t.style === 'gradient-warm') {
    const g = ctx.createRadialGradient(size*0.5,size*0.35,0, size*0.5,size*0.5,size*0.7);
    g.addColorStop(0, '#2a1800'); g.addColorStop(1, '#0d0d0d');
    ctx.fillStyle = g;
  } else if (t.style === 'gradient-blue') {
    const g = ctx.createLinearGradient(0, 0, size, size);
    g.addColorStop(0, '#0a1e4a'); g.addColorStop(1, '#10388A');
    ctx.fillStyle = g;
  } else if (t.style === 'glow-cyan') {
    const g = ctx.createRadialGradient(size*0.5,size*0.4,0, size*0.5,size*0.5,size*0.6);
    g.addColorStop(0, '#001a22'); g.addColorStop(1, '#000000');
    ctx.fillStyle = g;
  } else if (t.style === 'glow-purple') {
    const g = ctx.createRadialGradient(size*0.5,size*0.4,0, size*0.5,size*0.5,size*0.65);
    g.addColorStop(0, '#1a0f35'); g.addColorStop(1, '#0e0b1a');
    ctx.fillStyle = g;
  } else if (t.style === 'glow-green') {
    const g = ctx.createRadialGradient(size*0.5,size*0.4,0, size*0.5,size*0.5,size*0.65);
    g.addColorStop(0, '#0f2a18'); g.addColorStop(1, '#0b1a10');
    ctx.fillStyle = g;
  } else if (t.style === 'glow-gold') {
    const g = ctx.createRadialGradient(size*0.5,size*0.4,0, size*0.5,size*0.5,size*0.65);
    g.addColorStop(0, '#1f1a00'); g.addColorStop(1, '#100e00');
    ctx.fillStyle = g;
  } else if (t.style === 'glass') {
    const g = ctx.createLinearGradient(0,0,size,size);
    g.addColorStop(0,'#1a2040'); g.addColorStop(0.5,'#0f1535'); g.addColorStop(1,'#0a0f1e');
    ctx.fillStyle = g;
  } else if (t.style === 'flat') {
    ctx.fillStyle = t.bg;
  } else {
    ctx.fillStyle = t.bg;
  }

  // Rounded rect background
  ctx.beginPath();
  if (ctx.roundRect) ctx.roundRect(0,0,size,size, size*0.22);
  else ctx.rect(0,0,size,size);
  ctx.fill();

  // Outer border ring
  ctx.strokeStyle = t.accent + '55';
  ctx.lineWidth = size * 0.035;
  ctx.beginPath();
  if (ctx.roundRect) ctx.roundRect(size*0.04,size*0.04,size*0.92,size*0.92, size*0.18);
  else ctx.rect(size*0.04,size*0.04,size*0.92,size*0.92);
  ctx.stroke();

  // Glow under logo
  ctx.shadowColor = t.accent;
  ctx.shadowBlur = size * 0.22;
  ctx.fillStyle = 'transparent';
  ctx.fillRect(size*0.3, size*0.3, size*0.4, size*0.4);
  ctx.shadowBlur = 0;

  // Draw CK logo mark
  const cx = size * 0.5, cy = size * 0.5;
  const lw = size * 0.09; // stroke width

  ctx.strokeStyle = t.accent;
  ctx.lineWidth = lw;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.shadowColor = t.accent;
  ctx.shadowBlur = size * 0.12;

  // C shape (open on right)
  const cr = size * 0.22;
  ctx.beginPath();
  ctx.arc(cx - size*0.04, cy, cr, Math.PI * 0.28, Math.PI * 1.72);
  ctx.stroke();

  // K shape (right side)
  const kx = cx + size * 0.06, ky = cy;
  const kh = cr * 0.95;
  // Vertical bar of K
  ctx.beginPath();
  ctx.moveTo(kx, ky - kh);
  ctx.lineTo(kx, ky + kh);
  ctx.stroke();
  // Upper diagonal
  ctx.beginPath();
  ctx.moveTo(kx, ky - kh * 0.08);
  ctx.lineTo(kx + kh * 0.7, ky - kh);
  ctx.stroke();
  // Lower diagonal
  ctx.beginPath();
  ctx.moveTo(kx, ky - kh * 0.08);
  ctx.lineTo(kx + kh * 0.75, ky + kh);
  ctx.stroke();

  ctx.shadowBlur = 0;
}

function pickIcon(key) {
  if (!window.Android || !window.Android.setAppIcon) {
    toast('–°–º–µ–Ω–∞ –∏–∫–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');
    return;
  }
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –∏ –æ–±–Ω–æ–≤–ª—è–µ–º UI ‚Äî –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫–∞–∂–µ—Ç Java
  S.appIcon = key;
  saveLocal();
  renderIconGrid();
  window.Android.setAppIcon(key);
}

function renderIconGrid() {
  const g = document.getElementById('icon-grid-screen');
  if (!g) return;
  const cur = S.appIcon || 'orange';
  const sec = document.getElementById('icon-picker-section');
  if (sec) sec.style.display = window.Android ? '' : 'none';

  g.innerHTML = '';
  // Use a flex-wrap grid instead of theme-card list
  const grid = document.createElement('div');
  grid.style.cssText = 'display:flex;flex-wrap:wrap;gap:14px;padding:4px 0';
  g.appendChild(grid);

  Object.entries(ICON_VARIANTS).forEach(([key, t]) => {
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;position:relative';

    const cvWrap = document.createElement('div');
    const isSel = cur === key;
    cvWrap.style.cssText = `border-radius:16px;overflow:hidden;transition:transform .15s,box-shadow .15s;` +
      (isSel ? `box-shadow:0 0 0 2.5px var(--accent),0 0 18px color-mix(in srgb,var(--accent) 50%,transparent);transform:scale(1.08)` : '');

    const cv = document.createElement('canvas');
    cv.width = 64; cv.height = 64;
    cv.style.cssText = 'display:block;border-radius:16px;';
    drawIconPreview(cv, t);
    cvWrap.appendChild(cv);

    // Selection tick badge
    const tick = document.createElement('div');
    tick.style.cssText = `position:absolute;top:-4px;right:-4px;background:var(--accent);color:#fff;
      font-size:10px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;
      justify-content:center;font-weight:700;opacity:${isSel?1:0};transition:opacity .15s`;
    tick.textContent = '‚úì';
    wrap.appendChild(cvWrap);
    wrap.appendChild(tick);

    const label = document.createElement('div');
    label.style.cssText = `font-size:11px;font-weight:600;color:${isSel?'var(--accent)':'var(--muted)'};letter-spacing:.03em;text-align:center;max-width:68px;line-height:1.2`;
    label.textContent = t.label;
    wrap.appendChild(label);

    wrap.onclick = () => pickIcon(key);
    wrap.addEventListener('touchstart', () => { cvWrap.style.transform = 'scale(0.94)'; });
    wrap.addEventListener('touchend', () => { cvWrap.style.transform = isSel ? 'scale(1.08)' : ''; });
    grid.appendChild(wrap);
  });
}

function updateIconPicker() { renderIconGrid(); }
function initIconPicker() { renderIconGrid(); }

// ‚ïê‚ïê –¢–ï–ú–´ ‚ïê‚ïê
function applyTheme(key){
  const t=THEMES[key]||THEMES['orange'];
  Object.entries(t.vars).forEach(([k,v])=>document.documentElement.style.setProperty(k,v));
  document.documentElement.setAttribute('data-theme',key);
  S.theme=key;saveLocal();renderThemeGrid();renderIconGrid();updateThemeCurrentRow();
  // Re-apply glass mode with new theme colors
  applyGlassMode(false);
}

/* ‚îÄ‚îÄ Liquid Glass Mode ‚îÄ‚îÄ */
function applyGlassMode(save){
  const body=document.body;
  body.classList.toggle('glass-mode', !!S.liquidGlass);
  body.classList.toggle('glass-optimized', !!(S.liquidGlass && S.liquidGlassOpt));
  // Update toggles
  const gt=document.getElementById('glass-toggle');
  const got=document.getElementById('glass-opt-toggle');
  const optRow=document.getElementById('glass-opt-row');
  if(gt) gt.classList.toggle('on', !!S.liquidGlass);
  if(got) got.classList.toggle('on', !!S.liquidGlassOpt);
  if(optRow) optRow.style.display = S.liquidGlass ? 'flex' : 'none';
  if(save) saveLocal();
}
function toggleGlassMode(){
  S.liquidGlass = !S.liquidGlass;
  if(!S.liquidGlass) S.liquidGlassOpt=false;
  applyGlassMode(true);
  toast(S.liquidGlass ? 'ü´ß Liquid Glass –≤–∫–ª—é—á—ë–Ω' : 'Liquid Glass –≤—ã–∫–ª—é—á–µ–Ω');
}
function toggleGlassOpt(){
  if(!S.liquidGlass) return;
  S.liquidGlassOpt = !S.liquidGlassOpt;
  applyGlassMode(true);
  toast(S.liquidGlassOpt ? '‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞');
}

/* ‚îÄ‚îÄ Custom Background ‚îÄ‚îÄ */
function applyCustomBg(){
  const body=document.body;
  if(S.customBg){
    body.style.backgroundImage='url('+S.customBg+')';
    body.classList.add('custom-bg-active');
  } else {
    body.style.backgroundImage='';
    body.classList.remove('custom-bg-active');
  }
  updateBgUI();
}
function updateBgUI(){
  const preview=document.getElementById('custom-bg-preview');
  const thumb=document.getElementById('custom-bg-img-thumb');
  const removeBtn=document.getElementById('remove-bg-btn');
  if(preview) preview.style.display = S.customBg ? 'block' : 'none';
  if(thumb && S.customBg) thumb.src = S.customBg;
  if(removeBtn) removeBtn.style.display = S.customBg ? '' : 'none';
}
function pickBgImage(){
  const inp=document.getElementById('bg-file-input');
  if(inp) inp.click();
}
function onBgFileChosen(e){
  const file=e.target.files && e.target.files[0];
  if(!file) return;
  if(!file.type.startsWith('image/')) { toast('–í—ã–±–µ—Ä–∏ PNG –∏–ª–∏ JPG —Ñ–∞–π–ª'); return; }
  if(file.size > 10*1024*1024) { toast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)'); return; }
  const reader=new FileReader();
  reader.onload=function(ev){
    S.customBg=ev.target.result;
    saveLocal();
    applyCustomBg();
    toast('üñº –§–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω');
  };
  reader.readAsDataURL(file);
  // Reset input so same file can be picked again
  e.target.value='';
}
function removeBgImage(){
  S.customBg='';
  saveLocal();
  applyCustomBg();
  toast('–§–æ–Ω —É–¥–∞–ª—ë–Ω');
}
function renderThemeGrid(){
  ['theme-grid-screen'].forEach(gid => {
    const g=document.getElementById(gid); if(!g) return;
    g.innerHTML='';
    Object.entries(THEMES).forEach(([key,t])=>{
      const c=document.createElement('div');c.className='theme-card'+(S.theme===key?' selected':'');
      c.innerHTML=`
        <div class="theme-swatch">${t.sw.map(cl=>`<div class="swatch" style="background:${cl}"></div>`).join('')}</div>
        <div style="flex:1;min-width:0">
          <div class="theme-name" style="font-size:13px;font-weight:700">${t.ico||''} ${t.name}</div>
        </div>
        <span class="theme-check">‚úì</span>`;
      c.onclick=()=>{SFX.play('themeSelect');applyTheme(key);}; g.appendChild(c);
    });
  });
}
function updateThemeCurrentRow(){
  const t=THEMES[S.theme];
  const nameEl=document.getElementById('theme-current-name');
  const subEl=document.getElementById('theme-current-sub');
  if(nameEl) nameEl.textContent=(t?.ico||'')+' '+(t?.name||S.theme);
  if(subEl)  subEl.textContent='–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞';
}

// ‚ïê‚ïê DNS ‚ïê‚ïê
function selectDns(key){
  S.dns=key;saveLocal();
  renderDnsGrid();
  const customWrap=document.getElementById('custom-dns-wrap');
  customWrap.classList.toggle('hidden',key!=='custom');
  // –£–≤–µ–¥–æ–º–∏—Ç—å Android –Ω–∞—Ç–∏–≤–Ω–æ
  if(window.Android?.setDns){
    const doh=key==='custom'?S.customDns:(DNS_PROVIDERS[key]?.doh||'');
    window.Android.setDns(key,doh);
  }
  if(key!=='custom')toast('DNS: '+DNS_PROVIDERS[key]?.name);
}
function saveCustomDns(){
  const v=document.getElementById('custom-dns-input')?.value.trim()||'';
  S.customDns=v;saveLocal();
  if(window.Android?.setDns)window.Android.setDns('custom',v);
  toast('–°–≤–æ–π DNS —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}
function renderDnsGrid(){
  const g=document.getElementById('dns-grid');g.innerHTML='';
  Object.entries(DNS_PROVIDERS).forEach(([key,d])=>{
    const c=document.createElement('div');c.className='dns-card'+(S.dns===key?' selected':'');
    c.innerHTML=`<div class="dns-card-ico">${d.ico}</div><div class="dns-card-name">${d.name}</div><div class="dns-card-addr">${d.addr}</div>`;
    c.onclick=()=>selectDns(key);g.appendChild(c);
  });
}

// ‚ïê‚ïê DPI —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚ïê‚ïê
function selectDpi(id) {
  S.dpi = id; saveLocal();
  renderDpiList();
  updateDpiCurrentRow();
updateThemeCurrentRow();
  if (window.Android?.setDpiStrategy) window.Android.setDpiStrategy(id);
  const s = DPI_STRATEGIES.find(x => x.id === id);
  toast('–°—Ç—Ä–∞—Ç–µ–≥–∏—è: ' + s?.name);
}

function updateDpiCurrentRow() {
  const s = DPI_STRATEGIES.find(x => x.id === S.dpi);
  const nameEl = document.getElementById('dpi-current-name');
  const badgeEl = document.getElementById('dpi-current-badge');
  if (nameEl) nameEl.textContent = s ? s.name : S.dpi;
  if (badgeEl) badgeEl.textContent = (s ? s.badge : '') + (dpiWorkingIds ? ' ‚Ä¢ ‚úÖ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ' : ' ‚Ä¢ –ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞');
  const row = document.getElementById('dpi-current-row');
  // –Ω–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ—Å—Ç–æ—è–Ω–Ω–æ ‚Äî –æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è
}

function renderDpiList() {
  // –†–∏—Å—É–µ–º –≤ –æ–±–µ —Ç–æ—á–∫–∏: —ç–∫—Ä–∞–Ω DPI + (–µ—Å–ª–∏ –µ—Å—Ç—å) inline —Å–ø–∏—Å–æ–∫
  ['dpi-list-screen'].forEach(listId => {
    const list = document.getElementById(listId); if (!list) return;
    list.innerHTML = '';
    const toShow = dpiWorkingIds
      ? DPI_STRATEGIES.filter(s => dpiWorkingIds.includes(s.id))
      : DPI_STRATEGIES;
    toShow.forEach(s => {
      const isWorking = dpiWorkingIds && dpiWorkingIds.includes(s.id);
      const item = document.createElement('div');
      item.className = 'dpi-item' + (S.dpi === s.id ? ' selected' : '') + (isWorking ? ' works' : '');
      item.innerHTML = `
        <span class="dpi-badge">${s.badge}</span>
        <div style="flex:1;min-width:0">
          <div class="dpi-name">${s.name}</div>
          ${s.desc ? `<div class="dpi-desc">${s.desc}</div>` : ''}
        </div>
        ${isWorking ? '<span style="font-size:12px;color:var(--success);flex-shrink:0">‚úÖ</span>' : ''}
        <span class="dpi-check">‚úì</span>`;
      item.onclick = () => selectDpi(s.id);
      list.appendChild(item);
    });
  });
}

// ‚ïê‚ïê VPN (Android) ‚ïê‚ïê
let vpnActive=false;
function toggleVpn(){
  if(!window.Android?.toggleVpn){toast('–¢–æ–ª—å–∫–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏');return;}
  window.Android.toggleVpn();
}
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Android –Ω–∞—Ç–∏–≤–Ω–æ
function onVpnStateChanged(active,statusText){
  vpnActive=active;
  const dot=document.getElementById('vpn-dot');
  const title=document.getElementById('vpn-title');
  const sub=document.getElementById('vpn-sub');
  const btn=document.getElementById('vpn-btn');
  if(dot)dot.classList.toggle('on',active);
  if(title)title.textContent=active?'VPN –æ–±—Ö–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω':'VPN –æ–±—Ö–æ–¥ –≤—ã–∫–ª—é—á–µ–Ω';
  if(sub)sub.textContent=statusText||(active?'DNS –∏ DPI –æ–±—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç':'DNS –∏ DPI –æ–±—Ö–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã');
  if(btn){
    btn.className='btn '+(active?'btn-surface':'btn-accent');
    btn.textContent=active?'–û—Ç–∫–ª—é—á–∏—Ç—å VPN –æ–±—Ö–æ–¥':'–í–∫–ª—é—á–∏—Ç—å VPN –æ–±—Ö–æ–¥';
  }
}

// ‚ïê‚ïê –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚ïê‚ïê
// –ò—Å—Ç–æ—Ä–∏—è —ç–∫—Ä–∞–Ω–æ–≤ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
let cur='s-home';
const SCREEN_PARENTS = {
  's-groups':   {parent:'s-home',    nav:'nav-home'},
  's-schedule': {parent:'s-home',    nav:'nav-home'}, // –≤—Å–µ–≥–¥–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
  's-bells':    {parent:'s-home',    nav:'nav-bells'},
  's-settings': {parent:'s-home',    nav:'nav-home'},
  's-themes':   {parent:'s-settings',nav:null},
};

// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Android (–∫–Ω–æ–ø–∫–∞ Back –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)
function nativeBack(){
  const info = SCREEN_PARENTS[cur];
  if(info){
    if(info.parent==='s-home'){
      goHome();
    } else {
      showScreen(info.parent,'back');
      if(info.nav) updateNavActive(info.nav);
    }
    return true;
  }
  return false;
}

// ‚îÄ‚îÄ –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã: –í–°–ï–ì–î–ê —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π ‚îÄ‚îÄ
// requestIdleCallback: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–Ω—è—Ç ‚Äî –∂–¥—ë–º —Å–≤–æ–±–æ–¥–Ω—ã–π –º–æ–º–µ–Ω—Ç, –ø–æ—Ç–æ–º –∞–Ω–∏–º–∏—Ä—É–µ–º.
// –ê–Ω–∏–º–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø—Ä–æ—Å—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è —á—É—Ç—å –ø–æ–∑–∂–µ.
function _doTransition(prev, next, dir) {
  prev.classList.add(dir==='back'?'exit-right':'exit-left');
  prev.classList.remove('active');
  setTimeout(()=>prev.classList.remove('exit-left','exit-right'), 320);
  next.style.transition='none';
  void next.getBoundingClientRect();
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    next.style.transition='';
    next.classList.add('active');
  }));
}
let _pendingScreenId=null;
function showScreen(id, dir='forward'){
  if(id===cur)return;
  const prev=document.getElementById(cur), next=document.getElementById(id);
  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ —Ç–µ–º ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–º—ã –∏ –∏–∫–æ–Ω–∫–∏ –∑–∞—Ä–∞–Ω–µ–µ
  if(id==='s-themes'){renderThemeGrid();renderIconGrid();}
  if(id==='s-settings'){updateBgUI();applyGlassMode(false);}
  cur=id; _pendingScreenId=id;
  const go=()=>{
    if(_pendingScreenId!==id)return; // –µ—Å–ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π –ø–µ—Ä–µ—Ö–æ–¥ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    _doTransition(prev, next, dir);
  };
  if(typeof requestIdleCallback!=='undefined'){
    requestIdleCallback(go, {timeout:300});
  } else {
    setTimeout(go, 0);
  }
}

function goHome(){
  showScreen('s-home','back');
  updateNavActive('nav-home');
  updateLastGroupBtn();
  const fs=document.getElementById('file-section');
  const err=document.getElementById('home-error-hint');
  const noUrl=document.getElementById('no-url-hint');
  if(fs.classList.contains('hidden')&&err.classList.contains('hidden')&&noUrl.classList.contains('hidden')){
    loadFiles();
  }
}
function navTo(id,navId){showScreen(id);updateNavActive(navId);}
function updateNavActive(aid){['nav-home','nav-bells','nav-settings'].forEach(id=>document.getElementById(id)?.classList.toggle('active',id===aid));}

// ‚ïê‚ïê –ü–û–°–õ–ï–î–ù–Ø–Ø –ì–†–£–ü–ü–ê ‚ïê‚ïê
function updateLastGroupBtn(){
  const wrap=document.getElementById('last-group-wrap'),btn=document.getElementById('last-group-btn');
  if(S.lastGroup){btn.textContent='‚ñ∂ '+S.lastGroup;wrap.classList.remove('hidden');}
  else wrap.classList.add('hidden');
}
async function jumpToLastGroup(){
  if(!S.selectedFile){toast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');return;}
  const btn=document.getElementById('last-group-btn');
  const origText=btn.textContent;
  btn.classList.add('loading');
  btn.innerHTML=`<span class="loading-spinner"></span><span class="btn-label">–ó–∞–≥—Ä—É–∂–∞—é...</span>`;
  try{
    await loadSchedule(S.lastGroup);
  } finally {
    btn.classList.remove('loading');
    btn.textContent=origText;
  }
}

// ‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê ‚ïê‚ïê
function saveUrlAndLoad(){
  const inp=document.getElementById('url-input');
  const url=inp?inp.value.trim():'';
  if(!url){toast('–í–≤–µ–¥–∏ —Å—Å—ã–ª–∫—É');return;}
  S.url=url;saveLocal();
  hideHomeHints();
  document.getElementById('file-section').classList.add('hidden');
  goHome();
  loadFiles();
}
async function loadFiles(){
  if(!S.url){showHomeState('no-url');return;}
  hideHomeHints();
  setStatus('home-status','–ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª—ã...');setBar('home-bar',30);
  try{
    const data=await yadGet('/v1/disk/public/resources',{public_key:S.url,limit:100});
    S.files=(data._embedded?.items||[]).filter(i=>i.type==='file'&&/\.(doc|docx)$/i.test(i.name))
      .map(i=>({name:i.name,path:i.path||('/'+i.name),size:i.size||0,resourceId:i.resource_id||''}));
    setBar('home-bar',100);setStatus('home-status',`–ù–∞–π–¥–µ–Ω–æ: ${S.files.length} —Ñ–∞–π–ª–æ–≤`);
    setTimeout(()=>{setBar('home-bar',0);setStatus('home-status','');},1200);
    renderFileList();
  }catch(e){
    setBar('home-bar',0);
    setStatus('home-status','');
    showHomeState('error',e.message);
  }
}
function hideHomeHints(){
  ['no-url-hint','home-error-hint'].forEach(id=>document.getElementById(id)?.classList.add('hidden'));
}
function showHomeState(type,msg){
  hideHomeHints();
  document.getElementById('file-section').classList.add('hidden');
  if(type==='no-url'){
    document.getElementById('no-url-hint').classList.remove('hidden');
  } else if(type==='error'){
    const el=document.getElementById('home-error-hint');
    if(el){const em=el.querySelector('.error-msg');if(em)em.textContent=msg||'–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';el.classList.remove('hidden');}
  }
}
function renderFileList(){
  const list=document.getElementById('file-list');list.innerHTML='';
  S.files.forEach(f=>{
    const item=document.createElement('div');
    item.className='list-item'+(S.selectedFile?.name===f.name?' selected':'');
    item.innerHTML=`<span class="item-name">${f.name}</span>`;
    item.onclick=()=>{S.selectedFile=f;renderFileList();toast('–í—ã–±—Ä–∞–Ω: '+f.name);};
    list.appendChild(item);
  });
  document.getElementById('file-section').classList.remove('hidden');
}

async function getFileBuf(){
  const key=S.selectedFile.path||S.selectedFile.name;
  if(FILE_CACHE[key])return FILE_CACHE[key];
  const filePath=S.selectedFile.path||('/'+S.selectedFile.name);
  const dl=await yadGet('/v1/disk/public/resources/download',{public_key:S.url,path:filePath});
  if(!dl||!dl.href) throw new Error('–Ø–Ω–¥–µ–∫—Å –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª. –ü—É—Ç—å: '+filePath);
  const buf=await yadDownload(dl.href, S.selectedFile.name);
  FILE_CACHE[key]=buf;return buf;
}

// ‚ïê‚ïê –ì–†–£–ü–ü–´ ‚ïê‚ïê
async function goToGroups(){
  if(!S.selectedFile){toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª');return;}
  showScreen('s-groups');
  document.getElementById('groups-title').textContent=S.selectedFile.name;
  document.getElementById('group-search').value='';
  document.getElementById('group-list').innerHTML='';
  setStatus('groups-status','–°–∫–∞—á–∏–≤–∞—é...');setBar('groups-bar',20);
  try{
    const buf=await getFileBuf();
    allGroups=detectGroups(buf);
    setBar('groups-bar',100);setStatus('groups-status',`${allGroups.length} –≥—Ä—É–ø–ø`);
    setTimeout(()=>setBar('groups-bar',0),800);
    renderGroupList(allGroups);
  }catch(e){setBar('groups-bar',0);setStatus('groups-status','‚ùå '+e.message);}
}
function renderGroupList(groups){
  const list=document.getElementById('group-list');list.innerHTML='';
  groups.forEach(g=>{
    const item=document.createElement('div');
    item.className='list-item'+(S.lastGroup===g?' selected':'');
    item.innerHTML=`<span class="item-name">${g}</span>`;
    item.onclick=()=>{
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ ‚Äî —Å–ø–∏–Ω–Ω–µ—Ä –≤ —Å—Ç—Ä–æ–∫–µ
      list.querySelectorAll('.list-item').forEach(el=>el.classList.remove('selected'));
      item.classList.add('selected');
      item.innerHTML=`<span class="item-name">${g}</span><span class="loading-spinner" style="opacity:.6"></span>`;
      loadSchedule(g);
    };
    list.appendChild(item);
  });
}
function filterGroups(q){
  const f=q.trim().toUpperCase();
  renderGroupList(f?allGroups.filter(g=>g.toUpperCase().includes(f)):allGroups);
}

// ‚ïê‚ïê –†–ê–°–ü–ò–°–ê–ù–ò–ï ‚ïê‚ïê
// –†–∞–∑–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫—É "–ù–∏–∫–∏—Ç–∏–Ω–∞ –Æ.–í.–∫.17(2)" –Ω–∞ –∏–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏ –∫–∞–±–∏–Ω–µ—Ç
// –†–∞–∑–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "–§–∞–º–∏–ª–∏—è –ò.–û.–∫.21(1)" –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
function parseTeacherLine(line){
  // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω: –∫.NN(N) –∏–ª–∏ –∫.NN
  const ki=line.search(/–∫\.\d/);
  if(ki<0)return{teacher:line.trim(),cabinetNum:'',korpus:''};
  const teacher=line.slice(0,ki).trim();
  const cabPart=line.slice(ki); // "–∫.21(1)" –∏–ª–∏ "–∫.21"
  const numM=cabPart.match(/–∫\.(\d+)/);
  const korpM=cabPart.match(/\((\d)\)/);
  return{
    teacher,
    cabinetNum:numM?numM[1]:'',
    korpus:korpM?korpM[1]:''
  };
}

// –§–æ—Ä–º–∏—Ä—É–µ—Ç HTML –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–∞—Ä—ã (–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å + –∫–∞–±–∏–Ω–µ—Ç + –∫–æ—Ä–ø—É—Å)
function renderDetailLine(line){
  const p=parseTeacherLine(line);
  if(!p.cabinetNum)return`<span>${line}</span>`;
  let html=`<span>${p.teacher}</span>`;
  html+=`<br><span>–∫–∞–±–∏–Ω–µ—Ç ${p.cabinetNum}</span>`;
  if(p.korpus)html+=`<br><span>–∫–æ—Ä–ø—É—Å ${p.korpus}</span>`;
  return html;
}

// –ü—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è+–∫–∞–±–∏–Ω–µ—Ç, –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª–∏—Ç—ã —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
// –ù–∞–ø—Ä–∏–º–µ—Ä: "–û—Å–Ω–æ–≤—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ö—É–±–∞—Å–æ–≤–∞ –í.–í.–∫.21(1)"
function splitSubjectAndTeacher(subjectLine){
  // –ü–∞—Ç—Ç–µ—Ä–Ω: –∑–∞ —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–¥—ë—Ç –§–∞–º–∏–ª–∏—è (–æ–¥–Ω–æ/–¥–≤–∞ —Å–ª–æ–≤–∞) –ò.–û. (–¥–≤–∞ –∏–Ω–∏—Ü–∏–∞–ª–∞ —Å —Ç–æ—á–∫–∞–º–∏)
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–µ—Ç –∏–¥—Ç–∏ –∫.NN(N)
  const m=subjectLine.match(
    /^(.+?)\s+([–ê-–Ø–Å][–∞-—è—ë]+(?:\s+[–ê-–Ø–Å][–∞-—è—ë]+)?\s+[–ê-–Ø–Å]\.[–ê-–Ø–Å]\.(–∫\.\d+(?:\(\d\))?)?)$/u
  );
  if(m&&m[1].trim().length>2){
    return{subject:m[1].trim(),teacherStr:m[2].trim()};
  }
  return null;
}
async function loadSchedule(group){
  if(!S.selectedFile){toast('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª');return;}
  showScreen('s-schedule');
  S.lastGroup=group;saveLocal();updateLastGroupBtn();
  document.getElementById('sched-group-name').textContent=group;
  document.getElementById('sched-date').textContent='';
  // –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
  document.getElementById('sched-body').innerHTML=
    `<div class="sched-loading">
      <div class="sched-loading-circle"></div>
      <div style="color:var(--muted);font-size:13px;font-weight:500">–ó–∞–≥—Ä—É–∂–∞—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ‚Ä¶</div>
      <div class="sched-loading-dots">
        <div class="sched-loading-dot"></div>
        <div class="sched-loading-dot"></div>
        <div class="sched-loading-dot"></div>
      </div>
    </div>`;
  try{
    const buf=await getFileBuf();
    const{sched,hdr}=parseDoc(buf,group);
    if(!sched.length)throw new Error(`–ì—Ä—É–ø–ø–∞ "${group}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
    renderSchedule(group,hdr,sched,S.selectedFile.name);
  }catch(e){
    document.getElementById('sched-body').innerHTML=`<div style="text-align:center;padding:50px;color:var(--danger)">‚ùå ${e.message}</div>`;
  }
}
function renderSchedule(group,hdr,sched,filename){
  document.getElementById('sched-group-name').textContent=group;
  const cleanDate=formatScheduleDate(hdr);
  document.getElementById('sched-date').textContent=cleanDate||'';
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π
  const dateM=hdr.match(/(\d{2})\.(\d{2})\.(\d{4})/);
  const today=new Date();
  let isToday=false;
  if(dateM){
    const sd=new Date(+dateM[3],+dateM[2]-1,+dateM[1]);
    isToday=(sd.getFullYear()===today.getFullYear()&&sd.getMonth()===today.getMonth()&&sd.getDate()===today.getDate());
  }
  const isMon=filename.toUpperCase().includes('–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö');
  const bell=isMon?BELL_MON:BELL_TUE;
  const nowMin=today.getHours()*60+today.getMinutes();
  const body=document.getElementById('sched-body');body.innerHTML='';
  for(const[roman,lesson]of sched){
    const b=bell[roman];
    let isNow=false,isNext=false;
    if(isToday&&b&&b[0]){
      const[sh,sm]=b[0].split(':').map(Number);
      const endS=b[3]||b[1];
      const[eh,em]=endS.split(':').map(Number);
      const startMin=sh*60+sm,endMin=eh*60+em;
      isNow=nowMin>=startMin&&nowMin<=endMin;
      if(!isNow){const diff=startMin-nowMin;isNext=diff>0&&diff<=30;}
    }
    let lines=lesson?lesson.split('\n').map(l=>l.trim()).filter(Boolean):[];
    // –ï—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∏ –∫–∞–±–∏–Ω–µ—Ç —Å–ª–∏—Ç—ã —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É ‚Äî —Ä–∞–∑–¥–µ–ª—è–µ–º
    if(lines.length>0){
      const split=splitSubjectAndTeacher(lines[0]);
      if(split)lines=[split.subject,split.teacherStr,...lines.slice(1)];
    }
    const isEmpty=!lines.length;
    const card=document.createElement('div');
    card.className='pair-card'+(isEmpty?'':' has-subject')+(isNow?' is-now':isNext?' is-next':'');
    let badge='',remain='';
    if(isNow){
      badge='<span class="now-badge">‚óè —Å–µ–π—á–∞—Å</span>';
      if(b&&b[1]){const endS=b[3]||b[1];const[eh,em]=endS.split(':').map(Number);const diff=(eh*60+em)-nowMin;remain=`<div class="pair-remain">${diff<=0?'–∑–∞–∫–∞–Ω—á.':diff+' –º–∏–Ω'}</div>`;}
    }else if(isNext){badge='<span class="now-badge next-badge">‚óé —Å–∫–æ—Ä–æ</span>';}
    let timesHtml='';
    if(b){
      const[s1,e1,s2,e2]=b;
      timesHtml=`<div class="pair-times"><div class="pair-time-row"><span class="pair-time-val">${s1} ‚Äì ${e1}</span><span class="pair-time-tag">${s2?'1 —É—Ä–æ–∫':'60 –º–∏–Ω'}</span></div>${s2?`<div class="pair-time-row"><span class="pair-time-val">${s2} ‚Äì ${e2}</span><span class="pair-time-tag">2 —É—Ä–æ–∫</span></div>`:''}</div>`;
    }
    const detailsHtml=lines.length>1
      ?`<div class="pair-details">${lines.slice(1).map(l=>renderDetailLine(l)).join('<br>')}</div>`
      :'';
    card.innerHTML=`<div class="pair-top"><div class="pair-num">${roman}</div><div class="pair-subject-wrap"><div class="pair-subject${isEmpty?' empty':''}">${isEmpty?'–û–∫–Ω–æ':lines[0]}</div>${badge}</div>${remain}</div>${timesHtml}${detailsHtml}`;
    body.appendChild(card);
  }
}

// ‚ïê‚ïê –ü–†–ò–í–ï–¢–°–¢–í–ò–ï ‚ïê‚ïê
const APP_VERSION='3.0';
function getGreeting(){
  const now=new Date();
  const h=now.getHours();
  const dow=now.getDay(); // 0=–≤—Å, 6=—Å–±
  const isWeekend=(dow===0||dow===6);
  if(isWeekend){
    if(h>=5&&h<12) return{greet:'–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ',icon:'üõã',sub:'–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π ‚Äî –æ—Ç–¥—ã—Ö–∞–π!'};
    if(h>=12&&h<17) return{greet:'–î–æ–±—Ä—ã–π –¥–µ–Ω—å',icon:'üòé',sub:'–•–æ—Ä–æ—à–∏—Ö –≤—ã—Ö–æ–¥–Ω—ã—Ö!'};
    if(h>=17&&h<22) return{greet:'–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä',icon:'üåÜ',sub:'–ù–∞—Å–ª–∞–∂–¥–∞–π—Å—è –≤–µ—á–µ—Ä–æ–º üéâ'};
    return{greet:'–î–æ–±—Ä–æ–π –Ω–æ—á–∏',icon:'üåô',sub:'–í—ã—Ö–æ–¥–Ω—ã–µ ‚Äî –Ω–µ –ø–æ–≤–æ–¥ –Ω–µ —Å–ø–∞—Ç—å üòÖ'};
  }
  if(h>=5&&h<12) return{greet:'–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ',icon:'üå§',sub:'–•–æ—Ä–æ—à–µ–≥–æ —É—á–µ–±–Ω–æ–≥–æ –¥–Ω—è!'};
  if(h>=12&&h<17) return{greet:'–î–æ–±—Ä—ã–π –¥–µ–Ω—å',icon:'‚òÄÔ∏è',sub:'–£—Å–ø–µ—Ö–æ–≤ –Ω–∞ –ø–∞—Ä–∞—Ö!'};
  if(h>=17&&h<22) return{greet:'–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä',icon:'üåá',sub:'–í—Ä–µ–º—è –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.'};
  return{greet:'–î–æ–±—Ä–æ–π –Ω–æ—á–∏',icon:'üåô',sub:'–ù–µ –∑–∞–±—É–¥—å –ø–æ—Å–ø–∞—Ç—å üò¥'};
}
function showGreeting(){
  const ov=document.getElementById('greeting-overlay');
  if(!ov)return;
  const stored=loadSecret();
  if(stored.greetingOff){ov.classList.add('greet-hidden');return;}

  const now=new Date();
  const g=getGreeting();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');

  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
  const logo=document.getElementById('greet-logo');
  const sub=document.getElementById('greet-sub');
  const time=document.getElementById('greet-time');
  if(logo) logo.textContent=g.icon;
  if(sub)  sub.textContent=g.sub;
  if(time) time.textContent=hh+':'+mm;

  // Typewriter ‚Äî –≤—ã–≤–æ–¥–∏–º –±—É–∫–≤—ã –æ–¥–Ω–∞ –∑–∞ –æ–¥–Ω–æ–π
  const main=document.getElementById('greet-main');
  if(main){
    main.innerHTML='';
    const text=g.greet;
    text.split('').forEach((ch,i)=>{
      const span=document.createElement('span');
      span.className='greet-char';
      span.textContent=ch==' '?'\u00a0':ch;
      span.style.animationDelay=(i*55+80)+'ms';
      main.appendChild(span);
    });
  }

  // –ß–∞—Å—Ç–∏—Ü—ã —Ñ–æ–Ω–∞
  const pc=document.getElementById('greet-particles');
  if(pc){
    pc.innerHTML='';
    for(let i=0;i<12;i++){
      const p=document.createElement('div');
      p.className='greet-particle';
      const sz=4+Math.random()*8;
      p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;bottom:${Math.random()*50}%;--dur:${2.5+Math.random()*2.5}s;--del:${Math.random()*2}s`;
      pc.appendChild(p);
    }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay (–æ–Ω —É–∂–µ display:flex –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  ov.classList.remove('greet-hidden');

  // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 2.2 —Å–µ–∫
  setTimeout(skipGreeting, 2200);
}

function skipGreeting(){
  const ov=document.getElementById('greeting-overlay');
  if(!ov||ov.classList.contains('greet-hidden'))return;
  ov.classList.add('greet-hidden');
}

// ‚ïê‚ïê 4 –¢–ê–ü–ê –ü–û –ó–ê–ì–û–õ–û–í–ö–£ ‚Üí CMD (—Ç–æ–ª—å–∫–æ –ú–ü–î-2-24) ‚ïê‚ïê
let _schedTapCount=0,_schedTapTimer=null;
function initSchedTapTrigger(){
  const el=document.getElementById('sched-header-tap');
  if(!el)return;
  el.addEventListener('click',e=>{
    if(S.lastGroup!=='–ú–ü–î-2-24')return;
    _schedTapCount++;
    clearTimeout(_schedTapTimer);
    _schedTapTimer=setTimeout(()=>{_schedTapCount=0;},800);
    if(_schedTapCount>=4){_schedTapCount=0;clearTimeout(_schedTapTimer);SFX.play('themeSelect');cmdOpen();}
  });
}

// ‚ïê‚ïê SECRET STORAGE ‚ïê‚ïê
const SECRET_KEY='sched_secret';
function loadSecret(){try{return JSON.parse(stor.get(SECRET_KEY)||'{}')}catch(e){return{};}}
function saveSecret(obj){stor.set(SECRET_KEY,JSON.stringify(obj));}

// ‚ïê‚ïê –†–ï–ö–û–†–î–´ –ú–ù–ò-–ò–ì–† ‚ïê‚ïê
const HI_KEY='sched_hiscores';
function loadHiScores(){try{return JSON.parse(stor.get(HI_KEY)||'{}');}catch(e){return{};}}
function saveHi(game,score){
  const h=loadHiScores();
  if(!h[game]||score>h[game]){h[game]=score;stor.set(HI_KEY,JSON.stringify(h));}
  return Math.max(score,h[game]||0);
}
function getHi(game){return loadHiScores()[game]||0;}

// ‚ïê‚ïê CMD-–ö–û–ù–°–û–õ–¨ ‚ïê‚ïê
const CMD_HELP=[
  ['/help',         '–ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫'],
  ['/greeting',     'on|off ‚Äî –≤–∫–ª/–≤—ã–∫–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'],
  ['/hiscores',     '—Ä–µ–∫–æ—Ä–¥—ã –º–∏–Ω–∏-–∏–≥—Ä  |  reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å'],
  ['/version',      '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏'],
  ['/group',        '—Ç–µ–∫—É—â–∞—è –≥—Ä—É–ø–ø–∞ –∏ —Ñ–∞–π–ª'],
  ['/cache',        '[clear] ‚Äî –∫—ç—à —Ñ–∞–π–ª–æ–≤'],
  ['/theme',        'list|<n> ‚Äî —Å–ø–∏—Å–æ–∫ —Ç–µ–º –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å'],
  ['/sound',        'on|off ‚Äî –∑–≤—É–∫–∏'],
  ['/matrix',       'on|off ‚Äî —Ä–µ–∂–∏–º –ú–∞—Ç—Ä–∏—Ü—ã'],
  ['/snow',         'on|off ‚Äî —Å–Ω–µ–≥ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)'],
  ['/disco',        'on|off ‚Äî RGB –¥–∏—Å–∫–æ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)'],
  ['/shake',        '–≤—Å—Ç—Ä—è—Ö–Ω—É—Ç—å –∞–ø–ø'],
  ['/time',         '—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'],
  ['/optimize',     '—è–¥–µ—Ä–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ üöÄ'],
  ['/fps',          '–∑–∞–º–µ—Ä–∏—Ç—å FPS —Ä–µ–Ω–¥–µ—Ä–∞'],
  ['/ram',          '–æ—Ü–µ–Ω–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏'],
  ['/clear',        '–æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å'],
  ['/exit',         '–∑–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å'],
  ['/uwu',          '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å UwU-—Ä–µ–∂–∏–º ü•∫'],
  ['/gpt',          '—Å–ø—Ä–æ—Å–∏—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç—å ü§ñ (—É–º–µ–µ—Ç —Ä–∞–∑–Ω–æ–µ)'],
  ['/coffee',       '–∑–∞–≤–∞—Ä–∏—Ç—å –∫–æ—Ñ–µ ‚òï'],
  ['/homework',     '—Å–¥–µ–ª–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ üìö'],
  ['/absent',       '<–∏–º—è> ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ üôà'],
  ['/hack',         '–≤–∑–ª–æ–º–∞—Ç—å –ø–µ–Ω—Ç–∞–≥–æ–Ω üíª'],
  ['/grade',        '–ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É (—Ç–æ–ª—å–∫–æ 5)'],
  ['/summon',       '–≤—ã–∑–≤–∞—Ç—å –¥–µ–∫–∞–Ω–∞ üò±'],
  ['/ascii',        'ASCII-–±–∞–Ω–Ω–µ—Ä —Å –≥—Ä—É–ø–ø–æ–π'],
  ['/weather',      '–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã üå§'],
  ['/selftest',     '—Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è üî¨'],
  ['/horoscope',    '–≥–æ—Ä–æ—Å–∫–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è üîÆ'],
  ['/roast',        '–ø—Ä–æ–∂–∞—Ä–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ –æ—Ç –ò–ò üî•'],
  ['/pair',         '—Å–æ–≤–µ—Ç –∫–∞–∫ –ø–µ—Ä–µ–∂–∏—Ç—å –ø–∞—Ä—É üò¥'],
  ['/yeet',         '–∑–∞–∫–æ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –ø–∞—Ä—ã üö™'],
  ['/ping',         '–ø–∏–Ω–≥ –¥–æ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–∞ üì°'],
];
function cmdOpen(){
  const ov=document.getElementById('cmd-overlay');
  if(!ov)return;
  ov.style.display='flex';
  const body=document.getElementById('cmd-body');
  body.innerHTML='';
  cmdPrint('out','Microsoft Windows [Version 10.0.26100.3194]');
  cmdPrint('out','(c) Microsoft Corporation. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.');
  cmdPrint('out','');
  cmdPrint('info','‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  cmdPrint('info','‚ïë  Schedule App v'+APP_VERSION+'  Dev Console  ‚ïë');
  cmdPrint('info','‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  cmdPrint('out','');
  cmdPrintHelp();
  cmdPrint('out','');
  setTimeout(()=>document.getElementById('cmd-input')?.focus(),80);
}
function cmdClose(){
  document.getElementById('cmd-overlay').style.display='none';
}
function cmdPrint(cls,text){
  const body=document.getElementById('cmd-body');
  const line=document.createElement('div');
  line.className='cmd-line '+cls;
  line.textContent=text;
  body.appendChild(line);
  body.scrollTop=body.scrollHeight;
}
function cmdPrintHelp(){
  cmdPrint('warn','–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:');
  CMD_HELP.forEach(([c,d])=>cmdPrint('ok','  '+c.padEnd(14)+' ‚Äî '+d));
}
function cmdKey(e){
  if(e.key!=='Enter')return;
  const inp=document.getElementById('cmd-input');
  const raw=(inp.value||'').trim();
  inp.value='';
  if(!raw)return;
  cmdPrint('prompt','C:\\> '+raw);
  cmdExec(raw);
}
function cmdExec(raw){
  const parts=raw.split(/\s+/),cmd=parts[0].toLowerCase(),arg=(parts[1]||'').toLowerCase();
  const sec=loadSecret();
  switch(cmd){
    case '/help': cmdPrintHelp(); break;
    case '/greeting':
      if(arg==='off'){sec.greetingOff=true;saveSecret(sec);cmdPrint('ok','–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ.');}
      else if(arg==='on'){delete sec.greetingOff;saveSecret(sec);cmdPrint('ok','–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.');}
      else cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /greeting on|off');
      break;
    case '/hiscores':{
      const GAME_NAMES={snake:'–ó–º–µ–π–∫–∞',pong:'–ü–∏–Ω–≥-–ø–æ–Ω–≥',tetris:'–¢–µ—Ç—Ä–∏—Å',dino:'–î–∏–Ω–æ–∑–∞–≤—Ä–∏–∫',
        blockblast:'Block Blast',breakout:'–ê—Ä–∫–∞–Ω–æ–∏–¥',bubbles:'–ü—É–∑—ã—Ä–∏',flappy:'–§–ª–∞–ø–ø–∏ –ø—Ç–∏—Ü–∞','2048':'2048'};
      if(arg==='reset'){stor.set(HI_KEY,'{}');cmdPrint('ok','–í—Å–µ —Ä–µ–∫–æ—Ä–¥—ã —Å–±—Ä–æ—à–µ–Ω—ã.');}
      else{
        cmdPrint('info','‚îÄ‚îÄ –†–µ–∫–æ—Ä–¥—ã –º–∏–Ω–∏-–∏–≥—Ä ‚îÄ‚îÄ');
        const h=loadHiScores();
        let any=false;
        Object.entries(GAME_NAMES).forEach(([k,n])=>{
          cmdPrint(h[k]?'ok':'out','  '+(n+':').padEnd(18)+(h[k]||'–Ω–µ—Ç'));any=true;
        });
        cmdPrint('prompt','  /hiscores reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ');
      }
    } break;
    case '/version':
      cmdPrint('info','–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: '+APP_VERSION);
      cmdPrint('info','versionCode: 11');
      cmdPrint('info','–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Android WebView');
      break;
    case '/group':
      cmdPrint('info','–ì—Ä—É–ø–ø–∞: '+(S.lastGroup||'–Ω–µ –≤—ã–±—Ä–∞–Ω–∞'));
      cmdPrint('info','–§–∞–π–ª: '+(S.selectedFile?.name||'‚Äî'));
      break;
    case '/cache':
      if(arg==='clear'){Object.keys(FILE_CACHE).forEach(k=>delete FILE_CACHE[k]);cmdPrint('ok','–ö—ç—à –æ—á–∏—â–µ–Ω.');}
      else cmdPrint('info','–§–∞–π–ª–æ–≤ –≤ –∫—ç—à–µ: '+Object.keys(FILE_CACHE).length+'.  /cache clear ‚Äî –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.');
      break;
    case '/theme':
      if(arg==='list'){Object.entries(THEMES).forEach(([k,t])=>cmdPrint(S.theme===k?'ok':'out','  '+(k+(S.theme===k?' ‚úì':'')).padEnd(15)+t.name));}
      else if(arg&&THEMES[arg]){applyTheme(arg);cmdPrint('ok','–¢–µ–º–∞: '+THEMES[arg].name);}
      else if(arg)cmdPrint('err','–¢–µ–º–∞ "'+arg+'" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. /theme list');
      else cmdPrint('info','–¢–µ–º–∞: '+S.theme+'.  /theme list –∏–ª–∏ /theme <name>');
      break;
    case '/sound':
      if(arg==='off'){S.muted=true;saveLocal();updateMuteLabel();cmdPrint('ok','–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω.');}
      else if(arg==='on'){S.muted=false;saveLocal();updateMuteLabel();cmdPrint('ok','–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω.');}
      else cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /sound on|off');
      break;
    case '/matrix':
      if(arg==='on'){matrixStart();cmdPrint('ok','–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–∞—Ç—Ä–∏—Ü—É. –ö—Ä–∞—Å–Ω–∞—è —Ç–∞–±–ª–µ—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.');}
      else if(arg==='off'){matrixStop();cmdPrint('ok','–ú–∞—Ç—Ä–∏—Ü–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞.');}
      else cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /matrix on|off');
      break;
    case '/snow':
      if(arg==='on'){snowStart();cmdPrint('ok','‚ùÑÔ∏è –°–Ω–µ–≥ –ø–æ—à—ë–ª!');}
      else if(arg==='off'){snowStop();cmdPrint('ok','–°–Ω–µ–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');}
      else cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /snow on|off');
      break;
    case '/disco':
      if(arg==='on'){discoStart();cmdPrint('warn','üï∫ DISCO MODE ACTIVATED');}
      else if(arg==='off'){discoStop();cmdPrint('ok','–î–∏—Å–∫–æ—Ç–µ–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å.');}
      else cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /disco on|off');
      break;
    case '/shake':
      cmdPrint('warn','üí• –í–ê–£!');
      document.body.classList.remove('shaking');
      document.body.offsetHeight;
      document.body.classList.add('shaking');
      setTimeout(()=>document.body.classList.remove('shaking'),500);
      break;
    case '/time':{
      const upMs=performance.now();
      const upS=Math.floor(upMs/1000);
      const m=Math.floor(upS/60),s=upS%60;
      cmdPrint('info',`–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${m} –º–∏–Ω ${s} —Å–µ–∫`);
      cmdPrint('info',`–°–µ–π—á–∞—Å: ${new Date().toLocaleString('ru')}`);
    } break;
    case '/exit':
      cmdPrint('out','–í—ã—Ö–æ–¥...');
      setTimeout(cmdClose,500);
      break;
    case '/uwu': {
      const uwuFaces=['(·µî·¥•·µî)','(‚óï‚Äø‚óï‚úø)','(ÔΩ°‚óï‚Äø‚óïÔΩ°)',' ï‚Ä¢·¥•‚Ä¢ î','(‚âß‚ó°‚â¶)','UwU','OwO'];
      const uwuPhrases=['UwU —Ä–µ–∂–∏–º –∞w—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, —Å–µ–Ω–ø–∞–π –∑–∞–º–µ—á–µ–Ω OwO','*–≤–∏–ª—è–µ—Ç —Ö–≤–æ—Å—Ç–∏–∫–æ–º* —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ–µ nyaa~','—Ç–µ–±–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, —á—Ç–æ–±—ã –Ω–µ –æ–ø–æ–∑–¥–∞—Ç—å –Ω–∞ –ø–∞—Ä—É? (‚âß‚ó°‚â¶)','–≤—Å–µ –ø–∞—Ä—ã –æ—Ç–º–µ–Ω–µ–Ω—ã! ...–Ω–µ—Ç, —ç—Ç–æ –Ω–µ —Ç–∞–∫ (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)','–º—è—É~ *–º—É—Ä—á–∏—Ç* –ø–∞—Ä—ã —Å–µ–≥–æ–¥–Ω—è –µ—Å—Ç—å, –Ω–æ —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è UwU'];
      const face=uwuFaces[Math.floor(Math.random()*uwuFaces.length)];
      const phrase=uwuPhrases[Math.floor(Math.random()*uwuPhrases.length)];
      cmdPrint('ok',face+' '+phrase);
      // –í–º–µ—Å—Ç–æ Comic Sans (–ø–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º CSS-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
      const style=document.createElement('style');
      style.id='uwu-style';
      // –ö—É—Ä—Å–∏–≤–Ω—ã–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç + —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π tracking ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
      style.textContent=`body:not(.cmd-overlay){font-style:italic!important;letter-spacing:.04em!important}
        .pair-subject,.item-name,.hero-title,.greet-main{transform:rotate(-1.5deg) scale(1.01)!important;display:inline-block!important}
        *{transition:transform .3s,letter-spacing .3s!important}`;
      document.head.appendChild(style);
      cmdPrint('warn','‚ö†Ô∏è UwU-—Ä–µ–∂–∏–º: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–ª–µ–≥–∫–∞ —Å–æ—à—ë–ª —Å —É–º–∞ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥ nyaa~');
      setTimeout(()=>{
        const s=document.getElementById('uwu-style');
        if(s)s.remove();
        cmdPrint('ok','UwU-—Ä–µ–∂–∏–º –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ì—Ä—É—Å—Ç–Ω–æ (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)');
      },10000);
    } break;
    case '/gpt': {
      const userQ=(parts.slice(1).join(' ')||'').trim();
      if(!userQ){cmdPrint('err','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /gpt <–≤–æ–ø—Ä–æ—Å>');break;}
      cmdPrint('info','ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...');
      const q=userQ.toLowerCase();
      // Keyword-based –æ—Ç–≤–µ—Ç—ã
      let gptReply='';
      if(/–ø–∞—Ä[–∞—ã]|—Ä–∞—Å–ø–∏—Å–∞–Ω–∏|—É—Ä–æ–∫|–ª–µ–∫—Ü–∏|—Å–µ–º–∏–Ω–∞—Ä/.test(q)){
        const pairs=['–°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ —Ç—ã —ç—Ç–æ–≥–æ –Ω–µ –∂–¥—ë—à—å.','–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è. –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ —Ç–∞–∫ –Ω–µ –¥—É–º–∞—é—Ç.','–°–æ–≥–ª–∞—Å–Ω–æ –º–æ–∏–º –¥–∞–Ω–Ω—ã–º, –ø–∞—Ä—ã –æ—Ç–º–µ–Ω–µ–Ω—ã. –õ–æ–∂—å, –Ω–æ –∫—Ä–∞—Å–∏–≤–∞—è.','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä –∫–æ–Ω–µ—á–Ω–æ. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–µ–ª–∞–Ω–∏—è –Ω–∞ –Ω–∏—Ö –∏–¥—Ç–∏ ‚Äî –Ω–µ—Ç.'];
        gptReply=pairs[Math.floor(Math.random()*pairs.length)];
      } else if(/–ø—Ä–µ–ø–æ–¥|—É—á–∏—Ç–µ–ª—å|–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å|–ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä/.test(q)){
        gptReply='–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ ‚Äî –∑–∞–≥–∞–¥–æ—á–Ω—ã–µ —Å–æ–∑–¥–∞–Ω–∏—è. –ì–æ–≤–æ—Ä—è—Ç –Ω–∞ 2 —Å–∫–æ—Ä–æ—Å—Ç–∏: "—Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ" –∏ "–∑–∞—á–µ–º —Ç—ã –≤–æ–æ–±—â–µ –ø—Ä–∏—à—ë–ª".';
      } else if(/–æ—Ç–≤–µ—Ç|–∑–∞–¥–∞—á|–¥–æ–º–∞—à–Ω|–¥–∑/.test(q)){
        const hw=['–û—Ç–≤–µ—Ç: 42. –í–æ–ø—Ä–æ—Å —É—Ç–æ—á–Ω–∏ –ø–æ—Ç–æ–º.','–†–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å, –Ω–æ –æ–Ω–æ –ø–æ–∫—Ä—ã—Ç–æ –º—Ä–∞–∫–æ–º –¥–µ–¥–ª–∞–π–Ω–æ–≤.','ERROR: –æ—Ç–≤–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ —É —Ç–µ—Ö, –∫—Ç–æ —Å–ª—É—à–∞–ª –Ω–∞ –ª–µ–∫—Ü–∏–∏.','–ü–æ–ø—Ä–æ–±—É–π –º–µ—Ç–æ–¥ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç—ã–∫–∞. –†–∞–±–æ—Ç–∞–µ—Ç –≤ 23% —Å–ª—É—á–∞–µ–≤.'];
        gptReply=hw[Math.floor(Math.random()*hw.length)];
      } else if(/–ø–æ–≥–æ–¥|–¥–æ–∂–¥|—Å–Ω–µ–≥|—Ç–µ–ø–ª–æ/.test(q)){
        gptReply='–Ø –Ω–µ–π—Ä–æ—Å–µ—Ç—å –≤–Ω—É—Ç—Ä–∏ APK, –ø–æ–≥–æ–¥—É –Ω–µ –∑–Ω–∞—é. –ù–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å: —à–∞–Ω—Å—ã –Ω–∞ –¥–æ–∂–¥—å = –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ —Ç—ã –≤–∑—è–ª –∑–æ–Ω—Ç.';
      } else if(/–ª—é–±–æ–≤—å|–Ω—Ä–∞–≤–∏—Ç—Å—è|–≤–ª—é–±/.test(q)){
        gptReply='–≠—Ç–æ –Ω–µ –ø–æ –º–æ–µ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏. –Ø –∑–Ω–∞—é —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ: –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ ‚Äî –Ω–µ –æ–ø–∞–∑–¥—ã–≤–∞—Ç—å –Ω–∞ –ø–∞—Ä—ã.';
      } else if(/–ø–æ–º–æ–≥|–ø–æ–º–æ—â—å|–ø–æ–º–æ–≥–∏|–Ω–µ –∑–Ω–∞—é/.test(q)){
        gptReply='–Ø —Å–ª—ã—à—É —Ç–µ–±—è. –ù–æ –º–æ–∏ —Å–æ–≤–µ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ä–æ–≤–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ ‚Äî –∫—Ä–∞—Å–∏–≤–æ, –Ω–æ 50/50.';
      } else if(/–∂–∏–∑–Ω—å|—Å–º—ã—Å–ª|–∑–∞—á–µ–º|–ø–æ—á–µ–º—É/.test(q)){
        const existential=['–°–º—ã—Å–ª –∂–∏–∑–Ω–∏ ‚Äî –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—ã –ø—è—Ç–Ω–∏—Ü—ã.','–í–µ–ª–∏–∫–∏–µ —É–º—ã –∑–∞–¥–∞–≤–∞–ª–∏ —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å. –ù–∏ –æ–¥–∏–Ω –Ω–µ –Ω–∞—à—ë–ª –æ—Ç–≤–µ—Ç –¥–æ –∑–∞—á—ë—Ç–∞.','–°–æ–≥–ª–∞—Å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º: –∫–æ—Ñ–µ. –û—Ç–≤–µ—Ç ‚Äî –∫–æ—Ñ–µ.'];
        gptReply=existential[Math.floor(Math.random()*existential.length)];
      } else if(/–ø—Ä–∏–≤–µ—Ç|—Ö–∞–π|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π/.test(q)){
        gptReply='–ü—Ä–∏–≤–µ—Ç! –Ø GPT-mini, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —Ç–≤–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ. –ú–æ—â—å ‚Äî –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞. –ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å ‚Äî —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–∞. ü§ñ';
      } else {
        const generic=['–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ù–æ —Å–Ω–∞—á–∞–ª–∞ —Å–∫–∞–∂–∏ –º–Ω–µ —Ç—Ä–∏ —Ñ–∞–∫—Ç–∞ –æ —Å–µ–±–µ.','–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é... –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é... –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—â–µ.','ERROR 402: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤. –ü–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å üí≥','–°–æ–≥–ª–∞—Å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º MIT, –ª—É—á—à–µ —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è.','–û—Ç–≤–µ—Ç –ø—Ä–æ—Å—Ç: —ç—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø—Ä–µ–¥–ø–æ—Å—ã–ª–æ–∫, —É—Å–ª–æ–≤–∏–π, –ø–∞—Ä–∞–¥–∏–≥–º—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫.','–Ø –æ–±—Ä–∞–±–æ—Ç–∞–ª —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–∏—à—ë–ª –∫ –≤—ã–≤–æ–¥—É: —Ç–µ–±–µ –Ω—É–∂–µ–Ω –ø–µ—Ä–µ—Ä—ã–≤. –†–µ–∫–æ–º–µ–Ω–¥—É—é —á–∞–π.'];
        gptReply=generic[Math.floor(Math.random()*generic.length)];
      }
      setTimeout(()=>{
        cmdPrint('ok','ü§ñ GPT: '+gptReply);
      },900+Math.random()*600);
    } break;
    case '/coffee': {
      const steps=['‚òï –ò—â—É –∫–æ—Ñ–µ–º–∞—à–∏–Ω—É...','üíß –ù–∞–ª–∏–≤–∞—é –≤–æ–¥—É...','ü´ò –ó–∞—Å—ã–ø–∞—é –∑–µ—Ä–Ω–∞...','üî• –ù–∞–≥—Ä–µ–≤–∞—é...','‚ú® –ì–æ—Ç–æ–≤–æ!'];
      let i=0;
      const brew=setInterval(()=>{
        cmdPrint(i<steps.length-1?'info':'ok',steps[i]);
        i++;
        if(i>=steps.length){
          clearInterval(brew);
          cmdPrint('warn','‚òï –ö–æ—Ñ–µ –≥–æ—Ç–æ–≤! –¢–æ–ª—å–∫–æ –æ–Ω –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π. –°—Ö–æ–¥–∏ –∑–∞ –Ω–∞—Å—Ç–æ—è—â–∏–º :(');
        }
      },600);
    } break;
    case '/homework': {
      const subjects=['–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞','—Ñ–∏–∑–∏–∫–∞','–∏—Å—Ç–æ—Ä–∏—è','—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫','–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞','—Ö–∏–º–∏—è'];
      cmdPrint('info','üìö –ó–∞–ø—É—Å–∫–∞—é –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó...');
      const subj=subjects[Math.floor(Math.random()*subjects.length)];
      setTimeout(()=>cmdPrint('info','üìñ –û—Ç–∫—Ä—ã–≤–∞—é —É—á–µ–±–Ω–∏–∫ –ø–æ —Ç–µ–º–µ: '+subj+'...'),700);
      setTimeout(()=>cmdPrint('info','üîç –°–∫–∞–Ω–∏—Ä—É—é –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤...'),1400);
      setTimeout(()=>cmdPrint('warn','‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ 47 –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –Ω–æ –≤—Å–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ.'),2200);
      setTimeout(()=>cmdPrint('err','‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –º–æ–∑–≥ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–∏–¥—ë—Ç—Å—è –¥—É–º–∞—Ç—å —Å–∞–º–æ–º—É.'),3000);
      setTimeout(()=>cmdPrint('ok','üí° –°–æ–≤–µ—Ç: –ø–æ–ø—Ä–æ–±—É–π –æ—Ç–∫—Ä—ã—Ç—å —É—á–µ–±–Ω–∏–∫. –ì–æ–≤–æ—Ä—è—Ç, —Ç–∞–º –æ—Ç–≤–µ—Ç—ã.'),3800);
    } break;
    case '/absent': {
      const name=(parts.slice(1).join(' ')||'–ö—Ç–æ-—Ç–æ').trim();
      cmdPrint('info','üôà –ó–∞–ø–∏—Å—ã–≤–∞—é '+name+' –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ...');
      setTimeout(()=>cmdPrint('ok','‚úÖ '+name+' –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ "–±–æ–ª–µ–Ω". –ü—Ä–∏—á–∏–Ω–∞: –û–†–ó, –û–†–í–ò, –∏ –µ—â—ë 3 –±—É–∫–≤—ã.'),800);
      setTimeout(()=>cmdPrint('warn','üìã –ñ—É—Ä–Ω–∞–ª –æ–±–Ω–æ–≤–ª—ë–Ω. –ò–ª–∏ –Ω–µ—Ç. –≠—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç.'),1500);
    } break;
    case '/hack': {
      const steps2=[
        '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–∞–∫–µ—Ä—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞...',
        '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º –ü–µ–Ω—Ç–∞–≥–æ–Ω–∞... 1.2.3.4:80',
        '–û–±—Ö–æ–¥ —Ñ–∞–π—Ä–≤–æ–ª–ª–∞... ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 80%',
        '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ä—É—Å–æ–≤... malware.exe, sudo.bat',
        '–í–∑–ª–æ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è SHA-9999...',
        '> ACCESS GRANTED to... –æ–π.',
      ];
      let si=0;
      document.getElementById('cmd-body').style.color='#00ff41';
      const hackInterval=setInterval(()=>{
        cmdPrint('ok',steps2[si++]);
        if(si>=steps2.length){
          clearInterval(hackInterval);
          setTimeout(()=>{
            cmdPrint('err','‚ùå –ü–µ–Ω—Ç–∞–≥–æ–Ω –æ—Ç–æ–∑–≤–∞–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ. –ü—Ä–∏—á–∏–Ω–∞: —Ç—ã —Å—Ç—É–¥–µ–Ω—Ç.'),
            document.getElementById('cmd-body').style.color='';
          },1000);
        }
      },550);
    } break;
    case '/grade': {
      const gradeNames=['–∞–ª–≥–µ–±—Ä–∞','—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞','–∏—Å—Ç–æ—Ä–∏—è','–∏–Ω—Ñ–∞','—á–µ—Ä—á–µ–Ω–∏–µ'];
      const subj2=gradeNames[Math.floor(Math.random()*gradeNames.length)];
      cmdPrint('info','üìù –û—Ç–∫—Ä—ã–≤–∞—é —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª...');
      setTimeout(()=>cmdPrint('info','‚úèÔ∏è –°—Ç–∞–≤–ª—é –æ—Ü–µ–Ω–∫—É –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: '+subj2+'...'),800);
      setTimeout(()=>cmdPrint('warn','üîí –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–Å–ù. –¢–æ–ª—å–∫–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏.'),1600);
      setTimeout(()=>cmdPrint('err','–•–æ—Ç—è... –µ—Å–ª–∏ –±—ã –º–æ–≥, –ø–æ—Å—Ç–∞–≤–∏–ª –±—ã —Ç–µ–±–µ 5. –ß–µ—Å—Ç–Ω–æ.'),2400);
    } break;
    case '/summon': {
      cmdPrint('warn','üò± –í–´–ó–û–í –î–ï–ö–ê–ù–ê...');
      matrixStart();
      setTimeout(()=>{
        matrixStop();
        cmdPrint('ok','‚ú® –î–µ–∫–∞–Ω –≤—ã–∑–≤–∞–Ω... –∏ —Å—Ä–∞–∑—É —É—à—ë–ª –Ω–∞ —Å–æ–±—Ä–∞–Ω–∏–µ.');
        cmdPrint('info','–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 3-4 —É—á–µ–±–Ω—ã—Ö —á–∞—Å–∞.');
      },4000);
    } break;
    case '/optimize': {
      cmdPrint('warn','üöÄ –Ø–î–ï–†–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ó–ê–ü–£–©–ï–ù–ê...');
      let freed=0;
      setTimeout(()=>{
        // 1. –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –∫—ç—à (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –Ω–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å—Å—ã–ª–∫–∏)
        const cacheCount=Object.keys(FILE_CACHE).length;
        Object.keys(FILE_CACHE).forEach(k=>delete FILE_CACHE[k]);
        freed+=cacheCount;
        cmdPrint('ok',`  ‚úì –§–∞–π–ª–æ–≤—ã–π –∫—ç—à –æ—á–∏—â–µ–Ω (${cacheCount} –∑–∞–ø–∏—Å–µ–π)`);
      },300);
      setTimeout(()=>{
        // 2. –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–≤—ã—Ö canvases
        ['matrix-canvas','snow-canvas'].forEach(id=>{
          const c=document.getElementById(id);
          if(c&&!_matrixRunning&&!_snowRunning){const ctx=c.getContext('2d');if(ctx)ctx.clearRect(0,0,c.width,c.height);freed++;}
        });
        cmdPrint('ok','  ‚úì –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ canvas-–±—É—Ñ–µ—Ä—ã –æ—á–∏—â–µ–Ω—ã');
      },700);
      setTimeout(()=>{
        // 3. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏
        const uwuStyle=document.getElementById('uwu-style');
        if(uwuStyle){uwuStyle.remove();freed++;}
        // 4. Trim –∏–≥—Ä–æ–≤—ã—Ö —Å–ø–∏—Å–∫–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω—Å–æ–ª–∏)
        const body=document.getElementById('cmd-body');
        if(body&&body.children.length>80){
          while(body.children.length>60)body.removeChild(body.firstChild);
          freed+=20;
        }
        cmdPrint('ok','  ‚úì –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –±—É—Ñ–µ—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã');
      },1100);
      setTimeout(()=>{
        cmdPrint('ok','  ‚úì –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π garbage collect (GC –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞)');
        cmdPrint('warn','');
        cmdPrint('ok',`üèÅ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—á–∏—â–µ–Ω–æ ~${freed} –æ–±—ä–µ–∫—Ç–æ–≤.`);
        cmdPrint('info','  –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.');
      },1600);
    } break;
    case '/fps': {
      cmdPrint('info','üìä –ó–∞–º–µ—Ä—è—é FPS...');
      let frames=0,startT=performance.now();
      const rafLoop=()=>{
        frames++;
        if(performance.now()-startT<1000)requestAnimationFrame(rafLoop);
        else{
          const fps=Math.round(frames*1000/(performance.now()-startT));
          const quality=fps>=55?'ok':fps>=30?'warn':'err';
          cmdPrint(quality,`üìä FPS: ${fps} (${fps>=55?'–æ—Ç–ª–∏—á–Ω–æ':fps>=30?'–Ω–æ—Ä–º–∞–ª—å–Ω–æ':'–Ω–∏–∑–∫–∏–π'})`);
          if(fps<30)cmdPrint('warn','  –°–æ–≤–µ—Ç: /optimize –∏–ª–∏ –∑–∞–∫—Ä–æ–π —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
        }
      };
      requestAnimationFrame(rafLoop);
    } break;
    case '/ram': {
      cmdPrint('info','üíæ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–∞–º—è—Ç—å...');
      setTimeout(()=>{
        const domNodes=document.querySelectorAll('*').length;
        const cacheItems=Object.keys(FILE_CACHE).length;
        const perf=performance?.memory;
        if(perf){
          const used=Math.round(perf.usedJSHeapSize/1024/1024*10)/10;
          const total=Math.round(perf.totalJSHeapSize/1024/1024*10)/10;
          cmdPrint('info',`  JS Heap: ${used} –ú–ë / ${total} –ú–ë`);
        }
        cmdPrint('info',`  DOM-—É–∑–ª–æ–≤: ${domNodes}`);
        cmdPrint('info',`  –§–∞–π–ª–æ–≤ –≤ –∫—ç—à–µ: ${cacheItems}`);
        const quality=cacheItems>20||domNodes>2000?'warn':'ok';
        cmdPrint(quality,quality==='ok'?'  –ü–∞–º—è—Ç—å –≤ –Ω–æ—Ä–º–µ üëç':'  –†–µ–∫–æ–º–µ–Ω–¥—É—é /optimize');
      },400);
    } break;
    case '/clear': {
      const body=document.getElementById('cmd-body');
      if(body){body.innerHTML='';}
      cmdPrint('ok','–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞.');
    } break;
    case '/ascii': {
      const grp=S.lastGroup||'–ú–ü–î-2-24';
      cmdPrint('out','‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
      cmdPrint('out','‚îÇ  ScheduleApp v'+APP_VERSION+'       ‚îÇ');
      cmdPrint('out','‚îÇ  –ì—Ä—É–ø–ø–∞: '+grp.padEnd(15)+'‚îÇ');
      cmdPrint('out','‚îÇ  üè´ –ö–æ–ª–ª–µ–¥–∂ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ   ‚îÇ');
      cmdPrint('out','‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
      cmdPrint('ok','ASCII –±–∞–Ω–Ω–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω üé®');
    } break;
    case '/weather': {
      const weathers=[
        {ico:'‚òÄÔ∏è',desc:'–°–æ–ª–Ω–µ—á–Ω–æ, +22¬∞C. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–≥—É–ª–∞ –ø–∞—Ä—ã.',cls:'ok'},
        {ico:'üåß',desc:'–î–æ–∂–¥—å –≤–µ—Å—å –¥–µ–Ω—å. –û—Ç–ª–∏—á–Ω—ã–π –ø–æ–≤–æ–¥ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å.',cls:'info'},
        {ico:'‚ùÑÔ∏è',desc:'–°–Ω–µ–≥, -8¬∞C. –ó–∞–Ω—è—Ç–∏—è —Ç–æ—á–Ω–æ –æ—Ç–º–µ–Ω—è—Ç... –∏–ª–∏ –Ω–µ—Ç.',cls:'warn'},
        {ico:'‚õÖ',desc:'–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å. –ö–∞–∫ —Ç–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É.',cls:'out'},
        {ico:'‚ö°',desc:'–ì—Ä–æ–∑–∞. –ú–µ—Ç–µ–æ—Å–ª—É–∂–±–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —Å–∏–¥–µ—Ç—å –¥–æ–º–∞.',cls:'err'},
      ];
      const w=weathers[Math.floor(Math.random()*weathers.length)];
      cmdPrint('info','üåç –ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ...');
      setTimeout(()=>cmdPrint(w.cls,w.ico+' '+w.desc),700);
    } break;
    case '/selftest': {
      cmdPrint('warn','üî¨ –°–ò–°–¢–ï–ú–ù–´–ô –¢–ï–°–¢...');
      const tests=[
        ['localStorage',()=>{try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return true;}catch(e){return false;}}],
        ['Canvas 2D',()=>{const c=document.createElement('canvas');return !!c.getContext('2d');}],
        ['requestAnimationFrame',()=>typeof requestAnimationFrame==='function'],
        ['–§–∞–π–ª–æ–≤—ã–π –∫—ç—à',()=>typeof FILE_CACHE==='object'],
        ['–¢–µ–º—ã',()=>Object.keys(THEMES||{}).length>0],
        ['–ì—Ä—É–ø–ø–∞ –≤—ã–±—Ä–∞–Ω–∞',()=>!!(S.lastGroup)],
        ['–ó–≤—É–∫',()=>!S.muted],
      ];
      tests.forEach(([name,fn],i)=>{
        setTimeout(()=>{
          let ok=false;try{ok=fn();}catch(e){}
          cmdPrint(ok?'ok':'err',`  ${ok?'‚úì':'‚úó'} ${name}`);
          if(i===tests.length-1)setTimeout(()=>cmdPrint('info','üèÅ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω'),100);
        },i*200);
      });
    } break;
    case '/horoscope': {
      const signs=['–û–≤–µ–Ω','–¢–µ–ª–µ—Ü','–ë–ª–∏–∑–Ω–µ—Ü—ã','–†–∞–∫','–õ–µ–≤','–î–µ–≤–∞','–í–µ—Å—ã','–°–∫–æ—Ä–ø–∏–æ–Ω','–°—Ç—Ä–µ–ª–µ—Ü','–ö–æ–∑–µ—Ä–æ–≥','–í–æ–¥–æ–ª–µ–π','–†—ã–±—ã'];
      const sign=signs[new Date().getDate()%12];
      const predictions=[
        `–ó–≤—ë–∑–¥—ã –≥–æ–≤–æ—Ä—è—Ç: —Å–¥–∞—à—å –∑–∞—á—ë—Ç. –ù–æ –ø–µ—Ä–µ—Å–¥–∞—à—å –µ–≥–æ –¥–≤–∞–∂–¥—ã.`,
        `–ú–µ—Ä–∫—É—Ä–∏–π –≤ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–µ ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –ø–æ–≤–æ–¥ –Ω–µ –¥–µ–ª–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ.`,
        `–°–µ–≥–æ–¥–Ω—è –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è... –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è —É—á–µ–±–Ω–∏–∫–æ–≤ —Å –º–µ—Å—Ç–∞ –Ω–∞ –º–µ—Å—Ç–æ.`,
        `–õ—É–Ω–∞ –≤ ${sign} –ø—Ä–µ–¥–≤–µ—â–∞–µ—Ç: –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Å–µ–≥–æ–¥–Ω—è –¥–æ–±—Ä—ã–π. –ò–ª–∏ –Ω–µ—Ç. 50/50.`,
        `–°–∞—Ç—É—Ä–Ω –Ω–∞–º–µ–∫–∞–µ—Ç: –ø–æ—Ä–∞ –∑–∞–∫—Ä—ã—Ç—å 47 –≤–∫–ª–∞–¥–æ–∫ –∏ –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç.`,
        `–í–∞—à —Å—á–∞—Å—Ç–ª–∏–≤—ã–π –Ω–æ–º–µ—Ä: –ø–∞—Ä–∞ –∫–æ—Ç–æ—Ä—É—é –≤—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ. –í—ã –∑–Ω–∞–µ—Ç–µ –∫–∞–∫–∞—è.`,
        `–ö–æ–∑–µ—Ä–æ–≥ —à–µ–ø—á–µ—Ç: –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π —Å–¥–∞—Å—Ç –∑–∞ —Ç–µ–±—è? –ù–µ—Ç. –£–≤—ã.`,
        `–ó–≤—ë–∑–¥—ã —Å–æ—à–ª–∏—Å—å –≤ —Å–æ–∑–≤–µ–∑–¥–∏–µ "–í—Å—ë –±—É–¥–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ". –í—Ä—É—Ç.`,
      ];
      cmdPrint('warn', `üîÆ –ì–æ—Ä–æ—Å–∫–æ–ø —Å—Ç—É–¥–µ–Ω—Ç–∞ (${new Date().toLocaleDateString('ru')})`);
      cmdPrint('info', `  –ó–Ω–∞–∫: ${sign}`);
      setTimeout(()=>cmdPrint('out', '  ' + predictions[new Date().getDate() % predictions.length]), 600);
      setTimeout(()=>cmdPrint('ok', '  –£–¥–∞—á–∏. –û–Ω–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è.'), 1300);
    } break;

    case '/roast': {
      const roasts=[
        ['üî• –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —É—á–µ–±–Ω—É—é –∫–∞—Ä–º—É...', '–¢–≤–æ–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª, —Å—É–¥—è –ø–æ –≤—Å–µ–º—É, ‚Äî –∫–∞–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∑–∏–º–æ–π: –æ–∫–æ–ª–æ –Ω—É–ª—è.'],
        ['üî• –°–∫–∞–Ω–∏—Ä—É—é –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å...', '–¢—ã –±—ã–≤–∞–µ—à—å –≤ –∫–æ–ª–ª–µ–¥–∂–µ —Ä–µ–∂–µ, —á–µ–º —Å–æ–ª–Ω—Ü–µ –≤ –Ω–æ—è–±—Ä–µ. –ù–æ —Ö–æ—Ç—è –±—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ.'],
        ['üî• –û—Ü–µ–Ω–∏–≤–∞—é –∫–æ–Ω—Å–ø–µ–∫—Ç—ã...', '–¢–≤–æ–∏ –∑–∞–ø–∏—Å–∏ —Ç–∞–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ, —á—Ç–æ —Ç—ã —Å–∞–º –∏—Ö –Ω–µ –ø–æ–Ω–∏–º–∞–µ—à—å. –£–≤–∞–∂–∞—é.'],
        ['üî• –ò–∑–º–µ—Ä—è—é —Å–∏–ª—É –≤–æ–ª–∏...', '–¢—ã –æ—Ç–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –≠—Ç–æ —É–∂–µ 80% —É—Å–ø–µ—Ö–∞. –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî —è–≤–∏—Ç—å—Å—è —Ç—É–¥–∞.'],
        ['üî• –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ–º–∞—à–∫—É...', '–¢—ã —Ç–æ—á–Ω–æ –¥–µ–ª–∞–ª –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ? –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–µ—è–ª—Å—è, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ —Å–ø—Ä–æ—Å–∏—Ç? –ü—Ä–∞–≤–∏–ª—å–Ω–æ.'],
      ];
      const r=roasts[Math.floor(Math.random()*roasts.length)];
      cmdPrint('warn', r[0]);
      setTimeout(()=>cmdPrint('err', '  ' + r[1]), 1000);
      setTimeout(()=>cmdPrint('ok', '  (–≠—Ç–æ —à—É—Ç–∫–∞. –¢—ã –º–æ–ª–æ–¥–µ—Ü —á—Ç–æ —É—á–∏—à—å—Å—è. –°–µ—Ä—å—ë–∑–Ω–æ.)'), 2200);
    } break;

    case '/pair': {
      const tips=[
        'üò¥ –ü–æ–ª–æ–∂–∏ –≥–æ–ª–æ–≤—É –Ω–∞ —Ä—É–∫–∏. –≠—Ç–æ –Ω–µ —Å–æ–Ω ‚Äî —ç—Ç–æ "–≥–ª—É–±–æ–∫–æ–µ –æ—Å–º—ã—Å–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞".',
        'üì± –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –í–¥—Ä—É–≥ —Å–ª–µ–¥—É—é—â–µ–π –ø–∞—Ä—ã –Ω–µ—Ç? –ù–∞–¥–µ–∂–¥–∞ —É–º–∏—Ä–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π.',
        '‚úèÔ∏è –†–∏—Å—É–π –≤ —Ç–µ—Ç—Ä–∞–¥–∏. –ò—Å–∫—É—Å—Å—Ç–≤–æ ‚Äî —Ç–æ–∂–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.',
        'üßÉ –î–æ—Å—Ç–∞–Ω—å –µ–¥—É. –ú–µ–¥–ª–µ–Ω–Ω–æ. –®—É—Ä—à–∏. –î–∞–π –≤—Å–µ–º –ø–æ–Ω—è—Ç—å —á—Ç–æ —Ç—ã –∑–¥–µ—Å—å.',
        'üí¨ –ó–∞–¥–∞–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ. –≠—Ç–æ —É–±–∏–≤–∞–µ—Ç –¥–æ 15 –º–∏–Ω—É—Ç –ø–∞—Ä—ã.',
        'ü™ü –°–º–æ—Ç—Ä–∏ –≤ –æ–∫–Ω–æ. –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏. –ö–∞–∫ –±—É–¥—Ç–æ –ø–æ—Å—Ç–∏–≥–∞–µ—à—å —Å—É—Ç—å –±—ã—Ç–∏—è.',
        'üìñ –û—Ç–∫—Ä–æ–π —É—á–µ–±–Ω–∏–∫. –ù–ï —á–∏—Ç–∞–π. –ü—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏ –ø–µ—Ä–µ–¥ —Å–æ–±–æ–π ‚Äî –≤—ã–≥–ª—è–¥–∏—Ç —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ.',
        '‚è∞ –°–º–æ—Ç—Ä–∏ –Ω–∞ —á–∞—Å—ã –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã. –í—Ä–µ–º—è –Ω–µ —É—Å–∫–æ—Ä–∏—Ç—Å—è, –Ω–æ —Ç–∞–∫ —á–µ—Å—Ç–Ω–µ–µ.',
      ];
      cmdPrint('warn', 'üò¥ –°–û–í–ï–¢ –ö–ê–ö –ü–ï–†–ï–ñ–ò–¢–¨ –ü–ê–†–£:');
      setTimeout(()=>cmdPrint('ok', '  ' + tips[Math.floor(Math.random()*tips.length)]), 500);
    } break;

    case '/yeet': {
      cmdPrint('warn', 'üö™ –ì–ï–ù–ï–†–ò–†–£–Æ –ó–ê–ö–û–ù–ù–´–ô –í–´–•–û–î –ò–ó –ü–ê–†–´...');
      const excuses=[
        '–°–∫–∞–∂–∏ —á—Ç–æ —É —Ç–µ–±—è "–≤—Å—Ç—Ä–µ—á–∞ —Å –∫—É—Ä–∞—Ç–æ—Ä–æ–º". –ó–≤—É—á–∏—Ç —Å–æ–ª–∏–¥–Ω–æ.',
        '–°–æ–æ–±—â–∏ —á—Ç–æ "–≤—ã–∑–≤–∞–ª–∏ –≤ –¥–µ–∫–∞–Ω–∞—Ç". –ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç.',
        '"–ú–Ω–µ –ø–ª–æ—Ö–æ" ‚Äî –∫–ª–∞—Å—Å–∏–∫–∞ –∂–∞–Ω—Ä–∞. –í–µ—á–Ω–∞—è –∫–ª–∞—Å—Å–∏–∫–∞.',
        '–ü–æ–¥–Ω–∏–º–∏ —Ä—É–∫—É: "–ú–æ–∂–Ω–æ –≤—ã–π—Ç–∏?" ‚Äî –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è 40 –º–∏–Ω—É—Ç.',
        '–ü—Ä–∏—Ç–≤–æ—Ä–∏—Å—å —á—Ç–æ –ø–æ–ª—É—á–∏–ª –≤–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í—ã–π–¥–∏ "–Ω–∞ 1 –º–∏–Ω—É—Ç—É".',
        '–°–∫–∞–∂–∏ —á—Ç–æ –∑–∞–±—ã–ª —Ç–µ—Ç—Ä–∞–¥—å. –£–π–¥–∏ –∑–∞ –Ω–µ–π. –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–π—Å—è –¥–æ–º–æ–π.',
      ];
      setTimeout(()=>cmdPrint('info', '  –ú–µ—Ç–æ–¥: ' + excuses[new Date().getMinutes()%excuses.length]), 800);
      setTimeout(()=>cmdPrint('err',  '  ‚ö†Ô∏è –≠—Ç–æ —à—É—Ç–∫–∞. –•–æ–¥–∏ –Ω–∞ –ø–∞—Ä—ã, –∑–Ω–∞–Ω–∏—è –ø—Ä–∏–≥–æ–¥—è—Ç—Å—è.'), 1800);
      setTimeout(()=>cmdPrint('ok',   '  –•–æ—Ç—è —ç—Ç–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —è–≤–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç. üòå'), 2500);
    } break;

    case '/ping': {
      const startT=performance.now();
      cmdPrint('info', 'üì° –ü–∏–Ω–≥—É—é cloud-api.yandex.net...');
      const pingUrl='https://cloud-api.yandex.net/v1/disk';
      const doPing=(attempt)=>{
        const t0=performance.now();
        if(window.Android&&window.Android.nativeFetch){
          setTimeout(()=>{
            try{
              window.Android.nativeFetch(pingUrl);
              const ms=Math.round(performance.now()-t0);
              const q=ms<150?'ok':ms<400?'warn':'err';
              cmdPrint(q,`  [${attempt}] ${ms} –º—Å ‚Äî ${ms<150?'üü¢ –æ—Ç–ª–∏—á–Ω–æ':ms<400?'üü° –Ω–æ—Ä–º':'üî¥ –º–µ–¥–ª–µ–Ω–Ω–æ'}`);
            }catch(e){cmdPrint('err',`  [${attempt}] –æ—à–∏–±–∫–∞: `+e.message);}
          },0);
        } else {
          fetch(pingUrl,{method:'HEAD',mode:'no-cors',cache:'no-store'})
            .then(()=>cmdPrint('ok',`  [${attempt}] ${Math.round(performance.now()-t0)} –º—Å ‚Äî üü¢ –æ–∫`))
            .catch(()=>cmdPrint('warn',`  [${attempt}] ${Math.round(performance.now()-t0)} –º—Å ‚Äî CORS`));
        }
      };
      setTimeout(()=>doPing(1), 100);
      setTimeout(()=>doPing(2), 700);
      setTimeout(()=>doPing(3), 1300);
      setTimeout(()=>cmdPrint('info',`  –ì–æ—Ç–æ–≤–æ. –û–±—â–µ–µ –≤—Ä–µ–º—è: ${Math.round(performance.now()-startT+1300)} –º—Å`), 1900);
    } break;

    default:
      cmdPrint('err','"'+cmd+'" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–≤–µ–¥–∏ /help');
  }
}

// ‚ïê‚ïê –ó–í–û–ù–ö–ò ‚ïê‚ïê
function renderBells(){
  const body=document.getElementById('bells-body');
  const day=(title,bell)=>{
    let h=`<div class="bell-day">${title}</div>`;
    Object.entries(bell).forEach(([num,[s1,e1,s2,e2]])=>{
      h+=`<div class="bell-card"><div class="bell-num">${num}</div><div class="bell-slots"><div class="bell-slot"><span class="bell-slot-time">${s1} ‚Äì ${e1}</span><span class="bell-slot-tag">${s2?'1 —É—Ä–æ–∫':'60 –º–∏–Ω'}</span></div>${s2?`<div class="bell-slot"><span class="bell-slot-time">${s2} ‚Äì ${e2}</span><span class="bell-slot-tag">2 —É—Ä–æ–∫</span></div>`:''}</div></div>`;
    });
    return h;
  };
  body.innerHTML=day('–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',BELL_MON)+day('–í—Ç–æ—Ä–Ω–∏–∫ ‚Äì –ü—è—Ç–Ω–∏—Ü–∞',BELL_TUE);
}

// ‚ïê‚ïê –£–¢–ò–õ–ò–¢–´ ‚ïê‚ïê
function setStatus(id,t){const el=document.getElementById(id);if(el)el.textContent=t;}
function setBar(id,v){const el=document.getElementById(id);if(el)el.style.width=v+'%';}
let _tt;
function toast(msg){SFX.play('toastShow');const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2500);}

// ‚ïê‚ïê DPI –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ‚ïê‚ïê
const TEST_URLS = [
  'https://1.1.1.1/cdn-cgi/trace',
  'https://www.google.com/generate_204',
  'https://connectivitycheck.gstatic.com/generate_204'
];
let dpiTestActive = false;
let dpiWorkingIds = null; // null = –Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å, [] = —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞

async function testUrl(timeout = 4000) {
  for (const url of TEST_URLS) {
    try {
      const r = await Promise.race([
        fetch(url, { method: 'HEAD', cache: 'no-store', mode: 'no-cors' }),
        new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), timeout))
      ]);
      return true;
    } catch (e) { continue; }
  }
  return false;
}

async function testAllDpi() {
  if (dpiTestActive) return;
  dpiTestActive = true;

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —ç–∫—Ä–∞–Ω–∞ DPI
  const btn     = document.getElementById('dpi-test-btn2');
  const block   = document.getElementById('dpi-test-block2');
  const bar     = document.getElementById('dpi-test-bar2');
  const status  = document.getElementById('dpi-test-status2');
  const badges  = document.getElementById('dpi-result-badges2');
  const showAllBtn = document.getElementById('dpi-show-all-btn2');
  const label   = document.getElementById('dpi-screen-label');

  if(btn) { btn.disabled = true; btn.innerHTML = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...'; }
  if(block) block.style.display = 'block';
  if(badges) badges.innerHTML = '';
  if(showAllBtn) showAllBtn.style.display = 'none';
  if(bar) bar.style.width = '0%';

  const working = [];
  const total = DPI_STRATEGIES.length;

  for (let i = 0; i < total; i++) {
    const strat = DPI_STRATEGIES[i];
    const pct = Math.round(((i) / total) * 100);
    if(bar) bar.style.width = pct + '%';
    if(status) status.textContent = `–¢–µ—Å—Ç–∏—Ä—É—é ${i + 1}/${total}: ${strat.name}...`;

    // –°–æ–∑–¥–∞—Ç—å –±–µ–π–¥–∂ "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ"
    const badge = document.createElement('span');
    badge.className = 'test-badge testing';
    badge.id = 'tbadge-' + strat.id;
    badge.textContent = strat.badge;
    if(badges) badges.appendChild(badge);

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —á–µ—Ä–µ–∑ Android
    if (window.Android?.setDpiStrategy) {
      window.Android.setDpiStrategy(strat.id);
      await new Promise(r => setTimeout(r, 600)); // –¥–∞—Ç—å –≤—Ä–µ–º—è VPN –ø—Ä–∏–º–µ–Ω–∏—Ç—å
    } else {
      await new Promise(r => setTimeout(r, 150)); // –±–µ–∑ Android ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∏–º—É–ª—è—Ü–∏—è
    }

    // –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    let ok;
    if (window.Android?.setDpiStrategy) {
      ok = await testUrl(4000);
    } else {
      // –í –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ Android: —Å–∏–º—É–ª–∏—Ä—É–µ–º ‚Äî –ø–æ–º–µ—á–∞–µ–º "–æ—Å–Ω–æ–≤–Ω–æ–π" –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ alt –∫–∞–∫ —Ä–∞–±–æ—á–∏–µ
      const simulatedWorking = ['general', 'alt', 'simpleFake'];
      ok = simulatedWorking.includes(strat.id) || Math.random() > 0.7;
      await new Promise(r => setTimeout(r, 80));
    }

    badge.className = 'test-badge ' + (ok ? 'ok' : 'fail');
    badge.textContent = (ok ? '‚úì ' : '‚úó ') + strat.badge;
    if (ok) working.push(strat.id);
  }

  bar.style.width = '100%';
  dpiWorkingIds = working;

  if (working.length > 0) {
    if(status) status.textContent = `‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç: ${working.length} –∏–∑ ${total} —Å—Ç—Ä–∞—Ç–µ–≥–∏–π`;
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ —Ä–∞–±–æ—á–∞—è ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—á—É—é
    if (!working.includes(S.dpi)) {
      selectDpi(working[0]);
    } else {
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é
      if (window.Android?.setDpiStrategy) window.Android.setDpiStrategy(S.dpi);
    }
    if(label) label.textContent = '–†–∞–±–æ—á–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (' + working.length + ')';
    if(showAllBtn) showAllBtn.style.display = 'block';
  } else {
    if(status) status.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–±–æ—á–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏';
    dpiWorkingIds = null;
  }

  renderDpiList();
  updateDpiCurrentRow();
updateThemeCurrentRow();
  if(btn) { btn.disabled = false; btn.innerHTML = 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç'; }
  dpiTestActive = false;
  setTimeout(() => { if(bar) bar.style.width = '0%'; }, 1500);
}

function showAllDpi() {
  dpiWorkingIds = null;
  const label2 = document.getElementById('dpi-screen-label');
  const btn2   = document.getElementById('dpi-show-all-btn2');
  if (label2) label2.textContent = '–í—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏';
  if (btn2)   btn2.style.display = 'none';
  renderDpiList();
  updateDpiCurrentRow();
updateThemeCurrentRow();
  toast('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏');
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
loadLocal();
applyTheme(S.theme);
applyGlassMode(false);
applyCustomBg();
updateBgUI();
updateMuteLabel();
// –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
setTimeout(function(){
  if(window.Android&&window.Android.logMsg){
    window.Android.logMsg('INFO','index.html: JS –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å');
    window.Android.logMsg('INFO','index.html: —Ç–µ–º–∞='+S.theme+' dns='+S.dns+' dpi='+S.dpi+' url='+S.url.substring(0,40));
    window.Android.logMsg('INFO','index.html: Android bridge = '+(window.Android?'–¥–æ—Å—Ç—É–ø–µ–Ω':'–ù–ï –î–û–°–¢–£–ü–ï–ù'));
    window.Android.logMsg('INFO','index.html: localStorage = '+(function(){try{localStorage.setItem('t','1');localStorage.removeItem('t');return '—Ä–∞–±–æ—Ç–∞–µ—Ç';}catch(e){return '–ù–ï–î–û–°–¢–£–ü–ï–ù: '+e.message;}})());
  }
}, 300);
renderBells();
updateLastGroupBtn();
updateNavActive('nav-home');
updateThemeCurrentRow();
initIconPicker();
initSchedTapTrigger();
document.getElementById('url-input').value=S.url;

loadFiles();
showGreeting();

// ‚ïê‚ïê –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ ‚ïê‚ïê
(function restoreSecretState(){
  const sec=loadSecret();
  if(sec.disco){discoStart();}
  if(sec.snow){snowStart();}
  // /sound –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ S.muted –≤ loadLocal()
})();

// ‚ïê‚ïê OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚ïê‚ïê
// ‚ö†Ô∏è CLAUDE: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–π —ç—Ç—É –≤–µ—Ä—Å–∏—é!

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (APP_VERSION –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ)
(function(){
  const el = document.getElementById('app-version-str');
  if (el) el.textContent = APP_VERSION + ' ‚Äî Android';
})();

// ‚îÄ‚îÄ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚îÄ‚îÄ

// ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ OTA ‚îÄ‚îÄ
// _otaApkUrl –∏ _otaVersion –æ–±—ä—è–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

function otaOpen(version, apkUrl, notes) {
  _otaApkUrl = apkUrl;
  _otaVersion = version;
  document.getElementById('ota-version-label').textContent =
    'v' + APP_VERSION + '  ‚Üí  v' + version;
  const notesEl = document.getElementById('ota-notes-text');
  if (notes && notes.trim()) {
    notesEl.textContent = notes.trim();
    notesEl.classList.add('has-text');
  } else {
    notesEl.classList.remove('has-text');
  }
  document.getElementById('ota-progress-wrap').classList.add('hidden');
  document.getElementById('ota-progress-bar').style.width = '0%';
  document.getElementById('ota-progress-label').textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...';
  const dlBtn = document.getElementById('ota-dl-btn');
  dlBtn.disabled = false;
  dlBtn.textContent = '‚¨á –°–∫–∞—á–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
  document.getElementById('ota-cancel-btn').disabled = false;
  document.getElementById('ota-overlay').classList.add('show');
}

function otaClose() {
  document.getElementById('ota-overlay').classList.remove('show');
}

function otaOverlayClose(e) {
  if (e.target === document.getElementById('ota-overlay')) otaClose();
}

async function otaStartDownload() {
  if (!_otaApkUrl) { toast('‚ùå URL APK –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const dlBtn = document.getElementById('ota-dl-btn');
  const cancelBtn = document.getElementById('ota-cancel-btn');
  const wrap = document.getElementById('ota-progress-wrap');
  const bar = document.getElementById('ota-progress-bar');
  const label = document.getElementById('ota-progress-label');
  dlBtn.disabled = true;
  dlBtn.textContent = '‚è≥ –°–∫–∞—á–∏–≤–∞—é...';
  cancelBtn.disabled = true;
  wrap.classList.remove('hidden');

  let fakeProgress = 0;
  const fakeTimer = setInterval(() => {
    if (fakeProgress < 88) {
      fakeProgress += (88 - fakeProgress) * 0.05 + 0.5;
      bar.style.width = Math.min(fakeProgress, 88) + '%';
      label.textContent = Math.round(Math.min(fakeProgress, 88)) + '% ‚Äî –°–∫–∞—á–∏–≤–∞—é...';
    }
  }, 150);

  try {
    if (window.Android && window.Android.downloadAndInstallApk) {
      clearInterval(fakeTimer);
      bar.style.width = '100%';
      label.textContent = '100% ‚Äî –ó–∞–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫...';
      window.Android.downloadAndInstallApk(_otaApkUrl);
      setTimeout(() => otaClose(), 1200);
    } else {
      clearInterval(fakeTimer);
      bar.style.width = '100%';
      label.textContent = '–û—Ç–∫—Ä—ã–≤–∞—é –±—Ä–∞—É–∑–µ—Ä...';
      if (window.Android && window.Android.openUrl) {
        window.Android.openUrl(_otaApkUrl);
      } else {
        window.open(_otaApkUrl, '_blank');
      }
      setTimeout(() => otaClose(), 800);
    }
  } catch(e) {
    clearInterval(fakeTimer);
    dlBtn.disabled = false;
    dlBtn.textContent = '‚¨á –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
    cancelBtn.disabled = false;
    label.textContent = '‚ùå ' + e.message;
    bar.style.width = '0%';
  }
}

function compareVersions(a, b) {
  const pa = (a || '').split('.').map(Number);
  const pb = (b || '').split('.').map(Number);
  for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
    const diff = (pa[i] || 0) - (pb[i] || 0);
    if (diff !== 0) return diff > 0 ? 1 : -1;
  }
  return 0;
}

async function checkOtaUpdate(silent) {
  const btn = document.querySelector('[onclick="checkOtaUpdate()"]');
  if (!silent && btn) { btn.disabled = true; btn.textContent = '‚è≥'; }
  try {
    const baseApi = 'https://api.github.com/repos/LomKich/ScheduleApp/releases';

    async function ghFetch(url) {
      if (window.Android && window.Android.nativeFetch) {
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π @JavascriptInterface –≤ Promise+setTimeout
        // —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å JS event loop –Ω–∞ –≤—Ä–µ–º—è HTTP –∑–∞–ø—Ä–æ—Å–∞
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            try {
              const resStr = window.Android.nativeFetch(url);
              const res = JSON.parse(resStr);
              if (!res.ok) {
                const err = new Error(res.error || 'HTTP ' + res.status);
                err.status = res.status;
                reject(err);
              } else {
                resolve(JSON.parse(res.body));
              }
            } catch(e) { reject(e); }
          }, 0);
        });
      } else {
        const r = await fetch(url);
        if (!r.ok) { const err = new Error('HTTP ' + r.status); err.status = r.status; throw err; }
        return r.json();
      }
    }

    let data;
    try {
      data = await ghFetch(baseApi + '/latest');
    } catch(e) {
      if (e.status === 404) {
        const all = await ghFetch(baseApi + '?per_page=5');
        if (!Array.isArray(all) || all.length === 0) {
          if (!silent) toast('‚ùå –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ—Ç —Ä–µ–ª–∏–∑–æ–≤');
          return;
        }
        data = all[0];
      } else { throw e; }
    }

    const rawTag    = (data.tag_name || '').trim();
    const latestTag = rawTag.replace(/^v/i, '');
    const apkAsset  = (data.assets || []).find(a => a.name && a.name.endsWith('.apk'));

    if (!latestTag) { if (!silent) toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é'); return; }

    const isNewer = compareVersions(latestTag, APP_VERSION) > 0;
    if (!isNewer) {
      if (!silent) toast('‚úÖ –í–µ—Ä—Å–∏—è ' + APP_VERSION + ' –∞–∫—Ç—É–∞–ª—å–Ω–∞');
      return;
    }

    if (apkAsset) {
      otaOpen(latestTag, apkAsset.browser_download_url, data.body || '');
    } else {
      if (!silent) toast('üÜï v' + latestTag + ' ‚Äî APK –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫ —Ä–µ–ª–∏–∑—É');
    }
  } catch(e) {
    if (!silent) toast('‚ùå ' + e.message);
  }
  if (!silent && btn) { btn.disabled = false; btn.textContent = 'üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å'; }
}

function showUpdateDialog(version, apkUrl, notes) {
  otaOpen(version, apkUrl, notes || '');
}

function clearCacheAndReload() {
  try { localStorage.clear(); sessionStorage.clear(); } catch(e) {}
  if (window.Android && window.Android.clearWebViewCache) window.Android.clearWebViewCache();
  setTimeout(() => location.reload(true), 200);
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë                    ü§ñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø CLAUDE (–ß–ò–¢–ê–ô –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û!)           ‚ïë
// ‚ïë                                                                              ‚ïë
// ‚ïë  –ü—Ä–∏–≤–µ—Ç! –ï—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —ç—Ç–æ—Ç –∫–æ–¥ ‚Äî –∑–Ω–∞—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏–ª —Ç–µ–±—è       ‚ïë
// ‚ïë  –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –Ω—ë–º.                                  ‚ïë
// ‚ïë                                                                              ‚ïë
// ‚ïë  –ù–ê–ß–ò–ù–ê–Ø –° v1.9.0 ‚Äî –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –ú–ï–ù–Æ –í–´–ë–û–†–ê –ø–∞—Å—Ö–∞–ª–æ–∫.                 ‚ïë
// ‚ïë  –í—Å–µ –∏–≥—Ä—ã –∂–∏–≤—É—Ç –≤ –æ–¥–Ω–æ–º –æ–≤–µ—Ä–ª–µ–µ. –î–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —á–µ—Ä–µ–∑ eggStartGame().        ‚ïë
// ‚ïë                                                                              ‚ïë
// ‚ïë  –ò–°–¢–û–†–ò–Ø –ü–ê–°–•–ê–õ–û–ö (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π!):                                            ‚ïë
// ‚ïë  ‚Ä¢ v1.6.0 ‚Äî –ó–º–µ–π–∫–∞ (Snake). –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å–≤–∞–π–ø + d-pad.                      ‚ïë
// ‚ïë  ‚Ä¢ v1.7.0 ‚Äî –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ –ø—Ä–æ—Ç–∏–≤ –ò–ò (minimax). Touch/click.               ‚ïë
// ‚ïë  ‚Ä¢ v1.8.0 ‚Äî –ü–∏–Ω–≥-–ø–æ–Ω–≥. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π —Å–≤–∞–π–ø–æ–º/—Ç–∞–ø–æ–º.                 ‚ïë
// ‚ïë  ‚Ä¢ v1.9.0 ‚Äî –¢–µ—Ç—Ä–∏—Å. –°–≤–∞–π–ø + —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏. –£—Ä–æ–≤–Ω–∏, –æ—á–∫–∏.                 ‚ïë
// ‚ïë  ‚Ä¢ v2.2.0 ‚Äî –î–∏–Ω–æ–∑–∞–≤—Ä: –ø—Ç–µ—Ä–æ–¥–∞–∫—Ç–∏–ª–∏ (2 –≤—ã—Å–æ—Ç—ã), —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∫–∞–∫—Ç—É—Å–æ–≤,  ‚ïë
// ‚ïë             –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–µ (—Å–≤–∞–π–ø –≤–Ω–∏–∑), —Å—Ç–∏–∫–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã.       ‚ïë
// ‚ïë                                                                              ‚ïë
// ‚ïë  –ö–ê–ö –ê–ö–¢–ò–í–ò–†–£–ï–¢–°–Ø: 5 –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞–ø–æ–≤ –ø–æ —Å—Ç—Ä–æ–∫–µ "–í–µ—Ä—Å–∏—è" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.         ‚ïë
// ‚ïë  –ü–æ—Å–ª–µ 2 —Ç–∞–ø–æ–≤ ‚Äî —Ç–æ—Å—Ç "ü§î –ü—Ä–æ–¥–æ–ª–∂–∞–π..." –∫–∞–∫ –ø–æ–¥—Å–∫–∞–∑–∫–∞.                      ‚ïë
// ‚ïë                                                                              ‚ïë
// ‚ïë  –¢–†–ï–ë–û–í–ê–ù–ò–Ø –∫ –Ω–æ–≤—ã–º –ø–∞—Å—Ö–∞–ª–∫–∞–º:                                               ‚ïë
// ‚ïë  1. –°—Ç–∏–ª—å: —Ü–≤–µ—Ç–∞ --accent, --surface, --bg ‚Äî —Å–º–æ—Ç—Ä–∏ getAccent()             ‚ïë
// ‚ïë  2. –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ touch ‚Äî —ç—Ç–æ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ                          ‚ïë
// ‚ïë  3. –î–æ–±–∞–≤—å –∫–∞—Ä—Ç–æ—á–∫—É –≤ #egg-picker –∏ —Å–µ–∫—Ü–∏—é .egg-game –≤ HTML                 ‚ïë
// ‚ïë  4. –î–æ–±–∞–≤—å case –≤ eggStartGame() –∏ —Ñ—É–Ω–∫—Ü–∏—é –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ eggStopAll()         ‚ïë
// ‚ïë  5. –ó–∞–ø–∏—à–∏ –≤–µ—Ä—Å–∏—é –≤ –ò–°–¢–û–†–ò–Æ –≤—ã—à–µ                                             ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

// ‚ïê‚ïê –°–ò–°–¢–ï–ú–ê –ü–ê–°–•–ê–õ–û–ö v1.9.0 ‚ïê‚ïê
// _eggTaps, _eggTimer, _eggLastTouch –æ–±—ä—è–≤–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

function eggTap() {
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è touchstart + onclick
  const now = Date.now();
  if (now - _eggLastTouch < 350) return;
  _eggLastTouch = now;

  _eggTaps++;
  clearTimeout(_eggTimer);
  if (_eggTaps >= 5) { _eggTaps = 0; eggOpen(); return; }
  if (_eggTaps === 2) toast('ü§î –ü—Ä–æ–¥–æ–ª–∂–∞–π...');
  if (_eggTaps === 4) toast('üî• –ï—â—ë —Ä–∞–∑!');
  _eggTimer = setTimeout(() => { _eggTaps = 0; }, 1500);
}

function eggOpen() {
  SFX.play('eggOpen');
  document.getElementById('egg-overlay').classList.add('show');
  eggShowPicker();
}

function eggClose() {
  document.getElementById('egg-overlay').classList.remove('show');
  eggStopAll();
}

function eggShowPicker() {
  eggStopAll();
  ['egg-snake','egg-ttt','egg-pong','egg-tetris','egg-dino','egg-blockblast','egg-breakout','egg-bubbles','egg-flappy','egg-2048'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  document.getElementById('egg-picker').style.display = '';
  document.getElementById('egg-back').classList.remove('show');
}

function eggStartGame(name) {
  SFX.play('gameSelect');
  document.getElementById('egg-picker').style.display = 'none';
  document.getElementById('egg-back').classList.add('show');
  eggStopAll();
  if (name === 'snake') { document.getElementById('egg-snake').style.display = ''; snakeInit(); }
  else if (name === 'ttt')  { document.getElementById('egg-ttt').style.display = ''; tttInit(); }
  else if (name === 'pong') { document.getElementById('egg-pong').style.display = ''; pongInit(); }
  else if (name === 'tetris') { document.getElementById('egg-tetris').style.display = ''; tetInit(); }
  else if (name === 'dino') { document.getElementById('egg-dino').style.display = ''; dinoInit(); }
  else if (name === 'blockblast') { document.getElementById('egg-blockblast').style.display = ''; bbInit(); }
  else if (name === 'breakout') { document.getElementById('egg-breakout').style.display = ''; brInit(); }
  else if (name === 'bubbles')  { document.getElementById('egg-bubbles').style.display = '';  bubInit(); }
  else if (name === 'flappy')   { document.getElementById('egg-flappy').style.display = '';   flappyInit(); }
  else if (name === '2048')     { document.getElementById('egg-2048').style.display = '';     g2048Init(); }
}

function eggStopAll() {
  snakeStop();
  pongStop();
  tetStop();
  dinoStop();
  brStop();
  bubStop();
  flappyStop();
  g2048Stop();
}
function g2048Stop(){document.removeEventListener('keydown',g2048Key);}

// ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç–∞: –æ–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚îÄ‚îÄ
function updateDiffBtns(game) {
  const gameIdMap = {
    snake: 'egg-snake', pong: 'egg-pong', tetris: 'egg-tetris',
    dino: 'egg-dino', blockblast: 'egg-blockblast', breakout: 'egg-breakout', bubbles: 'egg-bubbles'
  };
  const container = document.getElementById(gameIdMap[game]);
  if (!container) return;
  const diffMap = {
    snake: snakeDifficulty, pong: pongDifficulty,
    tetris: tetDifficulty, dino: dinoDifficulty, blockblast: bbDifficulty, breakout: brDifficulty, bubbles: bubDifficulty
  };
  const cur = diffMap[game];
  const order = ['easy', 'normal', 'hard'];
  container.querySelectorAll('.diff-btn').forEach((btn, i) => {
    btn.classList.toggle('active', order[i] === cur);
  });
}

function getAccent() {
  return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#e87722';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üêç –ó–ú–ï–ô–ö–ê (v1.6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let snakeRaf = null, snakeRunning = false, snakePaused = false;
let snakeGrid, snakeCells, snakeDir_v, snakeNextDir, snakeFood, snakeLen;
let snakeHi = 0, snakeSW, snakeSH, snakeCellSize;
const SNAKE_COLS = 20, SNAKE_ROWS = 24;
let snakeDifficulty = 'normal';
const SNAKE_DIFF = { easy: {baseDelay:280, step:3}, normal: {baseDelay:200, step:4}, hard: {baseDelay:120, step:6} };

function snakeInit() {
  snakeHi = getHi('snake');
  const canvas = document.getElementById('snake-canvas');
  const maxW = Math.min(window.innerWidth - 64, 320);
  snakeCellSize = Math.floor(maxW / SNAKE_COLS);
  canvas.width  = snakeCellSize * SNAKE_COLS;
  canvas.height = snakeCellSize * SNAKE_ROWS;
  snakeSW = canvas.width; snakeSH = canvas.height;

  // –°–≤–∞–π–ø —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  let tx0, ty0;
  canvas.ontouchstart = e => { e.preventDefault(); tx0 = e.touches[0].clientX; ty0 = e.touches[0].clientY; };
  canvas.ontouchend   = e => {
    e.preventDefault();
    const dx = e.changedTouches[0].clientX - tx0;
    const dy = e.changedTouches[0].clientY - ty0;
    if (Math.abs(dx) < 10 && Math.abs(dy) < 10) { snakeTogglePause(); return; }
    if (Math.abs(dx) > Math.abs(dy)) snakeDir(dx > 0 ? 1 : -1, 0);
    else snakeDir(0, dy > 0 ? 1 : -1);
  };
  snakeRestart();
}

function snakeRestart() {
  snakeStop();
  snakeGrid = Array.from({length: SNAKE_ROWS}, () => new Array(SNAKE_COLS).fill(0));
  const sx = Math.floor(SNAKE_COLS / 2), sy = Math.floor(SNAKE_ROWS / 2);
  snakeCells = [{x: sx, y: sy}, {x: sx-1, y: sy}, {x: sx-2, y: sy}];
  snakeCells.forEach(c => snakeGrid[c.y][c.x] = 1);
  snakeDir_v = {x: 1, y: 0}; snakeNextDir = {x: 1, y: 0};
  snakeLen = 3;
  snakePlaceFood();
  snakeRunning = true; snakePaused = false;
  snakeDraw();
  snakeSchedule();
}

function snakeStop() {
  snakeRunning = false;
  clearTimeout(snakeRaf); snakeRaf = null;
}

function snakeTogglePause() {
  if (!snakeRunning) { snakeRestart(); return; }
  snakePaused = !snakePaused;
  if (!snakePaused) snakeSchedule();
}

function snakeDir(dx, dy) { SFX.play('snakeTurn');
  // –ù–µ–ª—å–∑—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
  if (dx === -snakeDir_v.x && dy === -snakeDir_v.y) return;
  snakeNextDir = {x: dx, y: dy};
}

function snakePlaceFood() {
  const empty = [];
  for (let y = 0; y < SNAKE_ROWS; y++)
    for (let x = 0; x < SNAKE_COLS; x++)
      if (!snakeGrid[y][x]) empty.push({x, y});
  if (!empty.length) return;
  snakeFood = empty[Math.floor(Math.random() * empty.length)];
}

function snakeSchedule() {
  if (!snakeRunning || snakePaused) return;
  const d = SNAKE_DIFF[snakeDifficulty] || SNAKE_DIFF.normal;
  const delay = Math.max(60, d.baseDelay - (snakeLen - 3) * d.step);
  snakeRaf = setTimeout(() => { snakeTick(); snakeDraw(); snakeSchedule(); }, delay);
}

function snakeTick() {
  snakeDir_v = {...snakeNextDir};
  const head = snakeCells[0];
  let nx = (head.x + snakeDir_v.x + SNAKE_COLS) % SNAKE_COLS;
  let ny = (head.y + snakeDir_v.y + SNAKE_ROWS) % SNAKE_ROWS;

  // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–æ–±–æ–π
  if (snakeGrid[ny][nx] === 1) {
    snakeRunning = false;
    snakeDrawGameOver();
    SFX.play('snakeDie');
    if (snakeLen - 3 > snakeHi) snakeHi = saveHi('snake', snakeLen - 3);
    snakeUpdateScore();
    toast('üêç –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á—ë—Ç: ' + (snakeLen - 3));
    return;
  }

  const ate = snakeFood && nx === snakeFood.x && ny === snakeFood.y;
  snakeCells.unshift({x: nx, y: ny});
  snakeGrid[ny][nx] = 1;

  if (!ate) {
    const tail = snakeCells.pop();
    snakeGrid[tail.y][tail.x] = 0;
  } else {
    snakeLen++;
    SFX.play('snakeEat');
    snakePlaceFood();
    snakeUpdateScore();
  }
}

function snakeUpdateScore() {
  const el = document.getElementById('snake-score-label');
  if (el) el.textContent = '–°—á—ë—Ç: ' + (snakeLen - 3) + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + snakeHi;
}

function snakeDraw() {
  const canvas = document.getElementById('snake-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const accent = getAccent();
  const cs = snakeCellSize;

  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, snakeSW, snakeSH);

  // –°–µ—Ç–∫–∞
  ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  ctx.lineWidth = 0.5;
  for (let x = 0; x <= SNAKE_COLS; x++) { ctx.beginPath(); ctx.moveTo(x*cs,0); ctx.lineTo(x*cs,snakeSH); ctx.stroke(); }
  for (let y = 0; y <= SNAKE_ROWS; y++) { ctx.beginPath(); ctx.moveTo(0,y*cs); ctx.lineTo(snakeSW,y*cs); ctx.stroke(); }

  // –ï–¥–∞
  if (snakeFood) {
    ctx.shadowColor = '#ff4e00'; ctx.shadowBlur = 12;
    ctx.fillStyle = '#ff4e00';
    ctx.beginPath();
    ctx.arc(snakeFood.x*cs + cs/2, snakeFood.y*cs + cs/2, cs/2 - 2, 0, Math.PI*2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  // –ó–º–µ—è
  snakeCells.forEach((c, i) => {
    const alpha = i === 0 ? 1 : Math.max(0.35, 1 - i / snakeCells.length * 0.65);
    ctx.shadowColor = accent; ctx.shadowBlur = i === 0 ? 10 : 0;
    // –î–ª—è —Ç–µ–ª–∞ –ø–∞—Ä—Å–∏–º accent –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
    let bodyColor;
    if (i === 0) {
      bodyColor = accent;
    } else {
      // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å HEX –≤ RGB –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
      const hex = accent.replace('#','');
      if (hex.length === 6) {
        const r = parseInt(hex.slice(0,2),16);
        const g2 = parseInt(hex.slice(2,4),16);
        const b2 = parseInt(hex.slice(4,6),16);
        bodyColor = `rgba(${r},${g2},${b2},${alpha})`;
      } else {
        bodyColor = accent;
      }
    }
    ctx.fillStyle = bodyColor;
    const pad = i === 0 ? 1 : 2;
    if (ctx.roundRect) ctx.roundRect(c.x*cs+pad, c.y*cs+pad, cs-pad*2, cs-pad*2, 3);
    else ctx.rect(c.x*cs+pad, c.y*cs+pad, cs-pad*2, cs-pad*2);
    ctx.fill();
    ctx.shadowBlur = 0;
  });

  if (snakePaused) {
    ctx.fillStyle = 'rgba(0,0,0,.55)';
    ctx.fillRect(0, snakeSH/2-26, snakeSW, 52);
    ctx.fillStyle = '#f0ede8';
    ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('‚è∏ –ü–∞—É–∑–∞ ‚Äî —Ç–∞–ø–Ω–∏ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å', snakeSW/2, snakeSH/2+6);
  }
}

function snakeDrawGameOver() {
  const canvas = document.getElementById('snake-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  snakeDraw();
  ctx.fillStyle = 'rgba(0,0,0,.6)';
  ctx.fillRect(0, snakeSH/2-32, snakeSW, 64);
  ctx.fillStyle = '#f0ede8';
  ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!', snakeSW/2, snakeSH/2-6);
  ctx.font = '13px sans-serif'; ctx.fillStyle = getAccent();
  ctx.fillText('–ù–∞–∂–º–∏ ¬´–ó–∞–Ω–æ–≤–æ¬ª —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞', snakeSW/2, snakeSH/2+16);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ‚ùå –ö–†–ï–°–¢–ò–ö–ò-–ù–û–õ–ò–ö–ò (v1.7.0) ‚Äî minimax IG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tttBoard, tttXWins = 0, tttOWins = 0, tttDraws = 0, tttGameOver;

function tttInit() { tttRestart(); }

function tttRestart() {
  tttBoard = Array(9).fill(null);
  tttGameOver = false;
  tttRenderBoard();
  document.getElementById('ttt-status').textContent = '–¢–≤–æ–π —Ö–æ–¥ ‚Äî —Å—Ç–∞–≤—å ‚úï';
}

function tttRenderBoard() {
  const el = document.getElementById('ttt-board');
  if (!el) return;
  el.innerHTML = '';
  tttBoard.forEach((v, i) => {
    const cell = document.createElement('div');
    cell.className = 'ttt-cell' + (v === 'X' ? ' x-cell' : v === 'O' ? ' o-cell' : '');
    cell.textContent = v === 'X' ? '‚úï' : v === 'O' ? '‚óØ' : '';
    if (!v && !tttGameOver) cell.onclick = () => tttMove(i);
    el.appendChild(cell);
  });
}

function tttMove(i) {
  if (tttBoard[i] || tttGameOver) return;
  SFX.play('tttPlace');
  tttBoard[i] = 'X';
  tttRenderBoard();
  const win = tttCheck(tttBoard);
  if (win === 'X') { SFX.play('tttWin'); tttEndGame('‚ú® –¢—ã –ø–æ–±–µ–¥–∏–ª! –ù–µ–ø–ª–æ—Ö–æ!', win); return; }
  if (tttFull(tttBoard)) { SFX.play('tttDraw'); tttEndGame('ü§ù –ù–∏—á—å—è!', null); return; }
  document.getElementById('ttt-status').textContent = 'ü§î –ò–ò –¥—É–º–∞–µ—Ç...';
  setTimeout(() => {
    const best = tttMinimax(tttBoard, 'O', -Infinity, Infinity);
    tttBoard[best.idx] = 'O';
    SFX.play('tttPlace');
    tttRenderBoard();
    const win2 = tttCheck(tttBoard);
    if (win2 === 'O') { SFX.play('tttLose'); tttEndGame('ü§ñ –ò–ò –ø–æ–±–µ–¥–∏–ª! –ï—â—ë —Ä–∞–∑?', win2); return; }
    if (tttFull(tttBoard)) { SFX.play('tttDraw'); tttEndGame('ü§ù –ù–∏—á—å—è!', null); return; }
    document.getElementById('ttt-status').textContent = '–¢–≤–æ–π —Ö–æ–¥ ‚Äî —Å—Ç–∞–≤—å ‚úï';
  }, 250);
}

function tttCheck(b) {
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for (const [a,c,d] of lines) if (b[a] && b[a]===b[c] && b[a]===b[d]) return b[a];
  return null;
}

function tttFull(b) { return b.every(v => v); }

function tttMinimax(b, player, alpha, beta) {
  const win = tttCheck(b);
  if (win === 'O') return {score: 10};
  if (win === 'X') return {score: -10};
  if (tttFull(b))  return {score: 0};
  let best = player === 'O' ? {score: -Infinity, idx: -1} : {score: Infinity, idx: -1};
  for (let i = 0; i < 9; i++) {
    if (b[i]) continue;
    b[i] = player;
    const res = tttMinimax(b, player === 'O' ? 'X' : 'O', alpha, beta);
    b[i] = null;
    res.idx = i;
    if (player === 'O') { if (res.score > best.score) best = res; alpha = Math.max(alpha, best.score); }
    else                { if (res.score < best.score) best = res; beta  = Math.min(beta,  best.score); }
    if (beta <= alpha) break;
  }
  return best;
}

function tttEndGame(msg, winner) {
  tttGameOver = true;
  document.getElementById('ttt-status').textContent = msg;
  if (winner === 'X') tttXWins++;
  else if (winner === 'O') tttOWins++;
  else tttDraws++;
  document.getElementById('ttt-score-x').textContent = tttXWins;
  document.getElementById('ttt-score-o').textContent = tttOWins;
  document.getElementById('ttt-score-d').textContent = tttDraws;
  // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–∏–≥—Ä—ã—à–Ω—É—é –ª–∏–Ω–∏—é
  if (winner) {
    const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    const cells = document.getElementById('ttt-board').children;
    for (const [a,c,d] of lines) {
      if (tttBoard[a] === winner && tttBoard[c] === winner && tttBoard[d] === winner) {
        [a,c,d].forEach(idx => cells[idx].classList.add('win'));
        break;
      }
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üèì –ü–ò–ù–ì-–ü–û–ù–ì (v1.8.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pongRaf = null, pongRunning = false;
let pongScore = 0, pongHi = 0;
let pongBall, pongPad, pongW, pongH, pongSpeed, pongMissed;
let pongDifficulty = 'normal'; // easy / normal / hard
let pongLastTime = 0;

const PONG_DIFF = {
  easy:   { initSpeed: 2.0, maxSpeed: 7,  padW: 0.38 },
  normal: { initSpeed: 3.0, maxSpeed: 10, padW: 0.30 },
  hard:   { initSpeed: 4.5, maxSpeed: 14, padW: 0.22 },
};

function pongInit() {
  const canvas = document.getElementById('pong-canvas');
  const side = Math.min(window.innerWidth - 36, 360);
  canvas.width = side;
  canvas.height = Math.round(side * 1.1);
  pongW = canvas.width; pongH = canvas.height;
  pongHi = getHi('pong');
  pongRestart();
  const movePad = (clientX) => {
    const rect = canvas.getBoundingClientRect();
    pongPad.x = Math.max(pongPad.w/2, Math.min(pongW - pongPad.w/2, clientX - rect.left));
  };
  canvas.ontouchstart = e => { e.preventDefault(); movePad(e.touches[0].clientX); if (!pongRunning && !pongMissed) pongStart(); };
  canvas.ontouchmove  = e => { e.preventDefault(); movePad(e.touches[0].clientX); };
  canvas.onmousemove  = e => movePad(e.clientX);
  canvas.onclick = () => { if (!pongRunning && !pongMissed) pongStart(); };
}

function pongRestart() {
  pongStop();
  pongLastTime = 0;
  const diff = PONG_DIFF[pongDifficulty] || PONG_DIFF.normal;
  const padW = Math.round(pongW * diff.padW);
  pongPad = {x: pongW/2, w: padW, h: 10, y: pongH - 22};
  pongSpeed = diff.initSpeed; pongScore = 0; pongMissed = false; pongRunning = false;
  const angle = (Math.random() * 60 + 60) * (Math.PI/180) * (Math.random() > .5 ? 1 : -1);
  pongBall = {x: pongW/2, y: pongH/2, r: 8, vx: Math.cos(angle)*pongSpeed, vy: -Math.abs(Math.sin(angle)*pongSpeed), sx:1, sy:1, sqT:0, trail:[]};
  pongUpdateScore();
  pongDraw();
  _drawPongMsg('–¢–∞–ø–Ω–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ üèì');
}

function pongStart() { if (pongRunning) return; pongRunning = true; pongLoop(); }

function pongStop() { cancelAnimationFrame(pongRaf); pongRaf = null; pongRunning = false; }

function pongLoop(ts) {
  if (!pongRunning) return;
  const dt = pongLastTime ? Math.min((ts - pongLastTime) / 16.667, 3) : 1;
  pongLastTime = ts;
  pongTick(dt); pongDraw();
  pongRaf = requestAnimationFrame(pongLoop);
}

function pongTick(dt) {
  const b = pongBall, p = pongPad;
  b.x += b.vx * dt; b.y += b.vy * dt;

  // Trail ‚Äî —Ö—Ä–∞–Ω–∏–º —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π, —á—Ç–æ–±—ã –¥–ª–∏–Ω–∞ –Ω–µ –∑–∞–≤–∏—Å–µ–ª–∞ –æ—Ç FPS
  const now1 = performance.now();
  b.trail.push({x: b.x, y: b.y, ts: now1});
  // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏ —Å—Ç–∞—Ä—à–µ 160–º—Å
  while (b.trail.length > 0 && now1 - b.trail[0].ts > 160) b.trail.shift();

  // Squish recovery
  if (b.sqT > 0) {
    b.sqT = Math.max(0, b.sqT - dt * 0.17);
    const k = b.sqT;
    b.sx = 1 + (b._sqTx || 0) * k;
    b.sy = 1 + (b._sqTy || 0) * k;
  } else { b.sx = 1; b.sy = 1; }

  if (b.x - b.r < 0) {
    b.x = b.r; b.vx = Math.abs(b.vx);
    b.sx = 0.84; b.sy = 1.14; b._sqTx = -0.16; b._sqTy = 0.14; b.sqT = 1;
    SFX.play('pongWall');
  }
  if (b.x + b.r > pongW) {
    b.x = pongW - b.r; b.vx = -Math.abs(b.vx);
    b.sx = 0.84; b.sy = 1.14; b._sqTx = -0.16; b._sqTy = 0.14; b.sqT = 1;
    SFX.play('pongWall');
  }
  if (b.y - b.r < 0) {
    b.y = b.r; b.vy = Math.abs(b.vy);
    b.sx = 1.14; b.sy = 0.84; b._sqTx = 0.14; b._sqTy = -0.16; b.sqT = 1;
  }
  const padLeft = p.x - p.w/2, padRight = p.x + p.w/2;
  if (b.vy > 0 && b.y+b.r >= p.y && b.y+b.r <= p.y+p.h+4 && b.x >= padLeft-b.r && b.x <= padRight+b.r) {
    b.y = p.y - b.r;
    const hit = (b.x - p.x) / (p.w/2);
    const ba = hit * 65 * (Math.PI/180);
    pongSpeed = Math.min(pongSpeed + 0.18, PONG_DIFF[pongDifficulty].maxSpeed);
    b.vx = Math.sin(ba) * pongSpeed; b.vy = -Math.cos(ba) * pongSpeed;
    b.sx = 1.16; b.sy = 0.86; b._sqTx = 0.16; b._sqTy = -0.14; b.sqT = 1;
    SFX.play('pongHit'); SFX.play('pongScore');
    pongScore++; if (pongScore > pongHi) pongHi = saveHi('pong', pongScore);
    pongUpdateScore();
  }
  if (b.y - b.r > pongH) {
    pongRunning = false; pongMissed = true;
    cancelAnimationFrame(pongRaf);
    SFX.play('pongLose');
    pongDraw(); _drawPongMsg('üíÄ –ü—Ä–æ–º–∞—Ö! –¢–∞–ø–Ω–∏ ‚Äî –∑–∞–Ω–æ–≤–æ');
    toast('üíÄ –°—á—ë—Ç: ' + pongScore);
  }
}

function pongDraw() {
  const canvas = document.getElementById('pong-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const b = pongBall, p = pongPad;
  const accent = getAccent();
  ctx.fillStyle = '#111'; ctx.fillRect(0, 0, pongW, pongH);
  ctx.setLineDash([6,6]); ctx.strokeStyle = 'rgba(255,255,255,.08)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, pongH/2); ctx.lineTo(pongW, pongH/2); ctx.stroke();
  ctx.setLineDash([]);

  // Trail ‚Äî –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Ç–æ—á–∫–∏, –Ω–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É
  const trail = b.trail || [];
  const trailDur = 160;
  const nowT = performance.now();
  for (let i = 0; i < trail.length; i++) {
    const age = nowT - trail[i].ts;
    const t = Math.max(0, 1 - age / trailDur); // 1=—Å–≤–µ–∂–∞—è, 0=—Å—Ç–∞—Ä–∞—è
    const alpha = t * t * 0.45;
    const r = b.r * (0.25 + t * 0.55);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = accent;
    ctx.beginPath(); ctx.arc(trail[i].x, trail[i].y, r, 0, Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Ball with squish
  const sx = b.sx || 1, sy = b.sy || 1;
  ctx.save();
  ctx.translate(b.x, b.y);
  ctx.scale(sx, sy);
  ctx.shadowColor = accent; ctx.shadowBlur = 16; ctx.fillStyle = accent;
  ctx.beginPath(); ctx.arc(0, 0, b.r, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();

  // Paddle
  const grad = ctx.createLinearGradient(p.x-p.w/2, 0, p.x+p.w/2, 0);
  grad.addColorStop(0, 'rgba(255,255,255,.15)'); grad.addColorStop(.5, accent); grad.addColorStop(1, 'rgba(255,255,255,.15)');
  ctx.fillStyle = grad; ctx.shadowColor = accent; ctx.shadowBlur = 10;
  if (ctx.roundRect) ctx.roundRect(p.x-p.w/2, p.y, p.w, p.h, 6); else ctx.rect(p.x-p.w/2, p.y, p.w, p.h);
  ctx.fill(); ctx.shadowBlur = 0;
}

function _drawPongMsg(msg) {
  const canvas = document.getElementById('pong-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,.5)'; ctx.fillRect(0, pongH/2-30, pongW, 56);
  ctx.fillStyle = '#f0ede8'; ctx.font = 'bold 15px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText(msg, pongW/2, pongH/2+8);
  canvas.onclick = () => { pongMissed = false; pongRestart(); pongStart(); };
}

function pongUpdateScore() {
  const el = document.getElementById('pong-score-label');
  if (el) el.textContent = '–°—á—ë—Ç: ' + pongScore + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + pongHi;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üß± –¢–ï–¢–†–ò–° (v1.9.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TET_COLS = 10, TET_ROWS = 20;
const TET_PIECES = [
  { shape: [[1,1,1,1]],             color: '#00e5ff' }, // I
  { shape: [[1,1],[1,1]],           color: '#f5c518' }, // O
  { shape: [[0,1,0],[1,1,1]],       color: '#a78bfa' }, // T
  { shape: [[1,0],[1,0],[1,1]],     color: '#e87722' }, // L
  { shape: [[0,1],[0,1],[1,1]],     color: '#60cdff' }, // J
  { shape: [[0,1,1],[1,1,0]],       color: '#4caf7d' }, // S
  { shape: [[1,1,0],[0,1,1]],       color: '#c94f4f' }, // Z
];

let tetGrid, tetPiece, tetNext, tetX, tetY;
let tetScore = 0, tetHi = 0, tetLevel = 1, tetLines = 0;
let tetInterval = null, tetRunning = false, tetDead = false;
let tetCellSize, tetCanvasW, tetCanvasH;
let tetSwipeX0, tetSwipeY0, tetSwipeLastX;
let tetDifficulty = 'normal';
const TET_DIFF = { easy: {speedBase:600, minSpeed:150}, normal: {speedBase:500, minSpeed:80}, hard: {speedBase:300, minSpeed:50} };

function tetInit() {
  tetHi = getHi('tetris');
  const canvas = document.getElementById('tet-canvas');
  const maxW = Math.min(window.innerWidth - 64, 220);
  tetCellSize = Math.floor(maxW / TET_COLS);
  canvas.width  = tetCellSize * TET_COLS;
  canvas.height = tetCellSize * TET_ROWS;
  tetCanvasW = canvas.width; tetCanvasH = canvas.height;

  // –°–≤–∞–π–ø: –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ ‚Äî –¥–≤–∏–≥–∞—Ç—å, –≤–Ω–∏–∑ ‚Äî —É—Å–∫–æ—Ä–∏—Ç—å, –≤–≤–µ—Ä—Ö ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å
  canvas.ontouchstart = e => {
    e.preventDefault();
    tetSwipeX0 = tetSwipeLastX = e.touches[0].clientX;
    tetSwipeY0 = e.touches[0].clientY;
  };
  canvas.ontouchmove = e => {
    e.preventDefault();
    const dx = e.touches[0].clientX - tetSwipeLastX;
    if (Math.abs(dx) >= tetCellSize) {
      tetMove(dx > 0 ? 1 : -1);
      tetSwipeLastX = e.touches[0].clientX;
    }
  };
  canvas.ontouchend = e => {
    e.preventDefault();
    const dy = e.changedTouches[0].clientY - tetSwipeY0;
    const dx = e.changedTouches[0].clientX - tetSwipeX0;
    if (dy > 40 && Math.abs(dx) < 40) tetDrop();
    else if (dy < -40 && Math.abs(dx) < 40) tetRotate();
  };

  tetRestart();
}

function tetRestart() {
  tetStop();
  tetGrid = Array.from({length: TET_ROWS}, () => new Array(TET_COLS).fill(null));
  tetScore = 0; tetLevel = 1; tetLines = 0; tetDead = false;
  tetNext = tetRandomPiece();
  tetSpawn();
  tetRunning = true;
  tetSchedule();
  tetDraw();
}

function tetStop() {
  clearInterval(tetInterval); tetInterval = null;
  tetRunning = false;
}

function tetRandomPiece() {
  return JSON.parse(JSON.stringify(TET_PIECES[Math.floor(Math.random() * TET_PIECES.length)]));
}

function tetSpawn() {
  tetPiece = tetNext;
  tetNext  = tetRandomPiece();
  tetX = Math.floor((TET_COLS - tetPiece.shape[0].length) / 2);
  tetY = 0;
  if (tetCollide(tetPiece.shape, tetX, tetY)) {
    tetDead = true; tetStop();
    SFX.play('tetGameOver');
    if (tetScore > tetHi) tetHi = saveHi("tetris", tetScore);
    tetUpdateScore();
    tetDraw();
    tetDrawMsg('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!');
    toast('üß± –¢–µ—Ç—Ä–∏—Å: ' + tetScore + ' –æ—á–∫–æ–≤');
  }
}

function tetSchedule() {
  const d = TET_DIFF[tetDifficulty] || TET_DIFF.normal;
  const delay = Math.max(d.minSpeed, d.speedBase - (tetLevel - 1) * 45);
  tetInterval = setInterval(() => { tetGravity(); tetDraw(); }, delay);
}

function tetGravity() {
  if (!tetRunning || tetDead) return;
  if (!tetCollide(tetPiece.shape, tetX, tetY + 1)) { tetY++; }
  else { tetLock(); }
}

function tetCollide(shape, ox, oy) {
  for (let r = 0; r < shape.length; r++)
    for (let c = 0; c < shape[r].length; c++)
      if (shape[r][c]) {
        const nx = ox + c, ny = oy + r;
        if (nx < 0 || nx >= TET_COLS || ny >= TET_ROWS) return true;
        if (ny >= 0 && tetGrid[ny][nx]) return true;
      }
  return false;
}

function tetLock() {
  for (let r = 0; r < tetPiece.shape.length; r++)
    for (let c = 0; c < tetPiece.shape[r].length; c++)
      if (tetPiece.shape[r][c] && tetY+r >= 0)
        tetGrid[tetY+r][tetX+c] = tetPiece.color;
  tetClearLines();
  tetSpawn();
}

function tetClearLines() {
  let cleared = 0;
  for (let r = TET_ROWS - 1; r >= 0; r--) {
    if (tetGrid[r].every(v => v)) {
      tetGrid.splice(r, 1);
      tetGrid.unshift(new Array(TET_COLS).fill(null));
      cleared++; r++;
    }
  }
  if (cleared) {
    SFX.play('tetLine');
    const pts = [0, 100, 300, 500, 800][cleared] * tetLevel;
    tetScore += pts; tetLines += cleared;
    tetLevel = Math.floor(tetLines / 10) + 1;
    if (tetScore > tetHi) tetHi = saveHi("tetris", tetScore);
    tetUpdateScore();
    // –ü–µ—Ä–µ–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
    tetStop();
    tetRunning = true;
    tetSchedule();
  }
}

function tetMove(dx) {
  if (tetDead || !tetRunning) return;
  if (!tetCollide(tetPiece.shape, tetX + dx, tetY)) { tetX += dx; SFX.play('tetMove'); tetDraw(); }
}

function tetRotate() {
  if (tetDead || !tetRunning) return;
  const rows = tetPiece.shape.length, cols = tetPiece.shape[0].length;
  const rotated = Array.from({length: cols}, (_, c) => Array.from({length: rows}, (_, r) => tetPiece.shape[rows-1-r][c]));
  // Kick: –ø—Ä–æ–±—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ, ¬±1, ¬±2
  for (const kick of [0, -1, 1, -2, 2]) {
    if (!tetCollide(rotated, tetX + kick, tetY)) {
      tetPiece.shape = rotated; tetX += kick; SFX.play('tetRotate'); tetDraw(); return;
    }
  }
}

function tetDrop() {
  if (tetDead || !tetRunning) return;
  while (!tetCollide(tetPiece.shape, tetX, tetY + 1)) { tetY++; tetScore += 1; }
  tetUpdateScore();
  SFX.play('tetDrop');
  tetLock(); tetDraw();
}

function tetUpdateScore() {
  const el = document.getElementById('tet-score-label');
  if (el) el.textContent = '–°—á—ë—Ç: ' + tetScore + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + tetHi + ' ‚Ä¢ –£—Ä–æ–≤–µ–Ω—å: ' + tetLevel;
}

function tetDraw() {
  const canvas = document.getElementById('tet-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cs = tetCellSize;
  const accent = getAccent();

  // –§–æ–Ω
  ctx.fillStyle = '#111'; ctx.fillRect(0, 0, tetCanvasW, tetCanvasH);

  // –°–µ—Ç–∫–∞
  ctx.strokeStyle = 'rgba(255,255,255,.04)'; ctx.lineWidth = .5;
  for (let x = 0; x <= TET_COLS; x++) { ctx.beginPath(); ctx.moveTo(x*cs,0); ctx.lineTo(x*cs,tetCanvasH); ctx.stroke(); }
  for (let y = 0; y <= TET_ROWS; y++) { ctx.beginPath(); ctx.moveTo(0,y*cs); ctx.lineTo(tetCanvasW,y*cs); ctx.stroke(); }

  // –£–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
  for (let r = 0; r < TET_ROWS; r++)
    for (let c = 0; c < TET_COLS; c++)
      if (tetGrid[r][c]) { _tetDrawCell(ctx, c, r, tetGrid[r][c], cs); }

  // –¢–µ–Ω—å (ghost piece)
  if (!tetDead && tetRunning) {
    let ghostY = tetY;
    while (!tetCollide(tetPiece.shape, tetX, ghostY + 1)) ghostY++;
    if (ghostY !== tetY) {
      for (let r = 0; r < tetPiece.shape.length; r++)
        for (let c = 0; c < tetPiece.shape[r].length; c++)
          if (tetPiece.shape[r][c]) {
            ctx.fillStyle = 'rgba(255,255,255,.1)';
            ctx.fillRect((tetX+c)*cs+1, (ghostY+r)*cs+1, cs-2, cs-2);
          }
    }

    // –ê–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–≥—É—Ä–∞
    for (let r = 0; r < tetPiece.shape.length; r++)
      for (let c = 0; c < tetPiece.shape[r].length; c++)
        if (tetPiece.shape[r][c]) { _tetDrawCell(ctx, tetX+c, tetY+r, tetPiece.color, cs); }
  }
}

function _tetDrawCell(ctx, cx, cy, color, cs) {
  ctx.shadowColor = color; ctx.shadowBlur = 2;
  ctx.fillStyle = color;
  if (ctx.roundRect) ctx.roundRect(cx*cs+1, cy*cs+1, cs-2, cs-2, 3);
  else ctx.rect(cx*cs+1, cy*cs+1, cs-2, cs-2);
  ctx.fill();
  // –ë–ª–∏–∫
  ctx.fillStyle = 'rgba(255,255,255,.18)';
  ctx.fillRect(cx*cs+2, cy*cs+2, cs-4, Math.floor((cs-4)*0.4));
  ctx.shadowBlur = 0;
}

function tetDrawMsg(msg) {
  const canvas = document.getElementById('tet-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,.65)'; ctx.fillRect(0, tetCanvasH/2-34, tetCanvasW, 68);
  ctx.fillStyle = '#f0ede8'; ctx.font = 'bold 15px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText(msg, tetCanvasW/2, tetCanvasH/2-8);
  ctx.font = '12px sans-serif'; ctx.fillStyle = getAccent();
  ctx.fillText('–ù–∞–∂–º–∏ ¬´–ó–∞–Ω–æ–≤–æ¬ª —á—Ç–æ–±—ã –µ—â—ë —Ä–∞–∑', tetCanvasW/2, tetCanvasH/2+16);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ü¶ï –î–ò–ù–û–ó–ê–í–†–ò–ö (v2.0.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ü¶ï DINO GAME (v2.2 ‚Äî —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –∫–∞–∫—Ç—É—Å—ã + –ø—Ç–µ—Ä–æ–¥–∞–∫—Ç–∏–ª–∏) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dinoRaf = null, dinoRunning = false;
let dinoScore = 0, dinoHi = 0;
let dinoW, dinoH, dinoCellH;
let dinoDino, dinoGround, dinoObstacles, dinoBirds, dinoCloudX, dinoFrameCount;
let dinoDifficulty = 'normal';
let dinoLastTime = 0;
let dinoLegFrame = 0, dinoLegTimer = 0;
let dinoDucking = false;
let dinoBirdWing = 0, dinoBirdWingTimer = 0;
let dinoDustParticles = [];

const DINO_DIFF = {
  easy:   { initSpeed: 4,   accel: 0.008, jumpVel: -13.5, gravity: 0.72 },
  normal: { initSpeed: 5.5, accel: 0.012, jumpVel: -14.5, gravity: 0.80 },
  hard:   { initSpeed: 7.5, accel: 0.018, jumpVel: -14,   gravity: 0.90 },
};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≥—Ä—É–ø–ø –∫–∞–∫—Ç—É—Å–æ–≤: –º–∞—Å—Å–∏–≤ –≤—ã—Å–æ—Ç (–∫–∞–∫ –¥–æ–ª—è –æ—Ç dinoH) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–∫—Ç—É—Å–∞ –≤ –≥—Ä—É–ø–ø–µ
const CACTUS_CONFIGS = [
  [0.26],               // –æ–¥–∏–Ω–æ—á–Ω—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π
  [0.34],               // –æ–¥–∏–Ω–æ—á–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π
  [0.40],               // –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã—Å–æ–∫–∏–π
  [0.32, 0.36],         // –¥–≤–æ–π–Ω–æ–π (–º–∞–ª–µ–Ω—å–∫–∏–π + –≤—ã—Å–æ–∫–∏–π)
  [0.38, 0.24],         // –¥–≤–æ–π–Ω–æ–π (–≤—ã—Å–æ–∫–∏–π + –º–∞–ª–µ–Ω—å–∫–∏–π)
  [0.32, 0.32],         // –¥–≤–æ–π–Ω–æ–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π
  [0.28, 0.38, 0.28],   // —Ç—Ä–æ–π–Ω–æ–π (–∞—Ä–∫–∞)
  [0.36, 0.36, 0.36],   // —Ç—Ä–æ–π–Ω–æ–π –º–æ–Ω–æ–ª–∏—Ç
  [0.24, 0.38, 0.38],   // —Ç—Ä–æ–π–Ω–æ–π –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–π
  [0.40, 0.28, 0.36],   // —Ç—Ä–æ–π–Ω–æ–π —Ö–∞–æ—Å
];

function dinoInit() {
  dinoHi = getHi("dino");
  const canvas = document.getElementById('dino-canvas');
  const maxW = Math.min(window.innerWidth - 36, 400);
  canvas.width  = maxW;
  canvas.height = Math.round(maxW * 0.48);
  dinoW = canvas.width; dinoH = canvas.height;
  dinoCellH = Math.round(dinoH * 0.28);

  // –¢–∞—á: —Å–≤–∞–π–ø –≤–Ω–∏–∑ = –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–µ, —Ç–∞–ø = –ø—Ä—ã–∂–æ–∫
  let _ty = 0, _moved = false;
  canvas.ontouchstart = e => { e.preventDefault(); _ty = e.touches[0].clientY; _moved = false; };
  canvas.ontouchmove  = e => {
    e.preventDefault();
    if (!_moved && e.touches[0].clientY - _ty > 22) {
      _moved = true;
      if (dinoRunning && dinoDino.onGround) dinoDucking = true;
    }
  };
  canvas.ontouchend = e => {
    e.preventDefault();
    dinoDucking = false;
    if (!_moved) dinoJump();
  };
  canvas.onclick = () => dinoJump();
  dinoRestart();
}

function dinoRestart() {
  dinoStop();
  dinoLastTime = 0;
  dinoLegFrame = 0; dinoLegTimer = 0;
  dinoDucking = false;
  dinoBirdWing = 0; dinoBirdWingTimer = 0;
  const d = DINO_DIFF[dinoDifficulty] || DINO_DIFF.normal;
  dinoScore = 0;
  dinoGround = dinoH - Math.round(dinoH * 0.12);
  const baseH = Math.round(dinoH * 0.32);
  dinoDino = {
    x: Math.round(dinoW * 0.12),
    w: Math.round(dinoH * 0.26),
    h: baseH, baseH,
    duckH: Math.round(baseH * 0.55), // –≤—ã—Å–æ—Ç–∞ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è
    y: 0, vy: 0, onGround: true,
    speed: d.initSpeed, accel: d.accel,
    jumpVel: d.jumpVel, gravity: d.gravity
  };
  dinoDino.y = dinoGround - dinoDino.h;
  dinoObstacles = [];
  dinoBirds = [];
  dinoCloudX = dinoW;
  dinoFrameCount = 0;
  dinoUpdateScore();
  dinoRunning = true;
  dinoLoop();
}

function dinoStop() {
  cancelAnimationFrame(dinoRaf); dinoRaf = null;
  dinoRunning = false;
}

function dinoJump() {
  if (!dinoRunning) { dinoRestart(); return; }
  if (dinoDucking) { dinoDucking = false; return; }
  if (dinoDino.onGround) {
    SFX.play('dinoJump');
    dinoDino.vy = dinoDino.jumpVel;
    dinoDino.onGround = false;
  }
}

function dinoLoop(ts) {
  if (!dinoRunning) return;
  const dt = dinoLastTime ? Math.min((ts - dinoLastTime) / 16.667, 3) : 1;
  dinoLastTime = ts;
  dinoTick(dt);
  dinoDraw();
  dinoRaf = requestAnimationFrame(dinoLoop);
}

function dinoTick(dt) {
  const d = dinoDino;
  // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
  d.speed = Math.min(d.speed + d.accel * dt, 22);
  dinoFrameCount += dt;

  // –ü—Ä–∏—Å–µ–¥–∞–Ω–∏–µ: –∏–∑–º–µ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –¥–∏–Ω–æ
  if (d.onGround) {
    const targetH = dinoDucking ? d.duckH : d.baseH;
    d.h = targetH;
    d.y = dinoGround - d.h;
  }

  // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–æ–≥
  if (d.onGround) {
    dinoLegTimer += d.speed * dt;
    if (dinoLegTimer >= 38) { dinoLegTimer = 0; dinoLegFrame = 1 - dinoLegFrame; }
  }

  // –ê–Ω–∏–º–∞—Ü–∏—è –∫—Ä—ã–ª—å–µ–≤ –ø—Ç–∏—Ü—ã
  dinoBirdWingTimer += d.speed * dt * 0.6;
  if (dinoBirdWingTimer >= 9) { dinoBirdWingTimer = 0; dinoBirdWing = 1 - dinoBirdWing; }

  // –§–∏–∑–∏–∫–∞
  const wasOnGround = d.onGround;
  d.vy += d.gravity * dt;
  d.y  += d.vy * dt;
  if (d.y >= dinoGround - d.h) {
    d.y = dinoGround - d.h; d.vy = 0;
    if (!wasOnGround) {
      // Landing dust burst
      for (let i = 0; i < 8; i++) {
        const ang = Math.PI + (Math.random() - 0.5) * 1.2;
        const spd = 0.8 + Math.random() * 2;
        dinoDustParticles.push({
          x: d.x + d.w * 0.3, y: dinoGround,
          vx: Math.cos(ang) * spd, vy: Math.sin(ang) * spd - 0.5,
          life: 1, maxLife: 1, r: 3 + Math.random() * 3
        });
      }
    }
    d.onGround = true;
  }

  // Update dust
  for (let i = dinoDustParticles.length - 1; i >= 0; i--) {
    const p = dinoDustParticles[i];
    p.x += p.vx * dt * 0.4; p.y += p.vy * dt * 0.4;
    p.vy += 0.04 * dt;
    p.life -= dt * 0.004;
    if (p.life <= 0) dinoDustParticles.splice(i, 1);
  }

  // –°—á—ë—Ç
  dinoScore = Math.floor(dinoFrameCount * 0.1);
  if (dinoScore > dinoHi) dinoHi = saveHi("dino", dinoScore);
  dinoUpdateScore();

  // ‚îÄ‚îÄ –°–ø–∞–≤–Ω –∫–∞–∫—Ç—É—Å–æ–≤ (—Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã) ‚îÄ‚îÄ
  const lastCactX = dinoObstacles.length ? dinoObstacles[dinoObstacles.length - 1].x : -Infinity;
  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫: –æ—Ç 140 –¥–æ 380px, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
  const minGap = Math.max(140, 280 - d.speed * 10) + Math.random() * 120;
  if (lastCactX < dinoW - minGap || dinoObstacles.length === 0) {
    if (Math.random() < 0.018 * dt || dinoObstacles.length === 0) {
      // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≥—Ä—É–ø–ø—ã –∫–∞–∫—Ç—É—Å–æ–≤
      const config = CACTUS_CONFIGS[Math.floor(Math.random() * CACTUS_CONFIGS.length)];
      let offsetX = dinoW + 10;
      for (let i = 0; i < config.length; i++) {
        const cactH = Math.round(dinoH * config[i]);
        const cactW = Math.round(cactH * (0.40 + Math.random() * 0.15));
        dinoObstacles.push({ x: offsetX, w: cactW, h: cactH, y: dinoGround - cactH });
        // –ú–µ–∂–¥—É –∫–∞–∫—Ç—É—Å–∞–º–∏ –≤ –≥—Ä—É–ø–ø–µ –º–∞–ª–µ–Ω—å–∫–∏–π —Å–ª—É—á–∞–π–Ω—ã–π –∑–∞–∑–æ—Ä
        offsetX += cactW + Math.round(6 + Math.random() * 10);
      }
    }
  }

  // ‚îÄ‚îÄ –°–ø–∞–≤–Ω –ø—Ç–∏—Ü (–Ω–∞—á–∏–Ω–∞—è —Å –æ—á–∫–æ–≤ 15) ‚îÄ‚îÄ
  if (dinoScore >= 15) {
    const lastBirdX = dinoBirds.length ? dinoBirds[dinoBirds.length - 1].x : -Infinity;
    const birdGap = Math.max(300, 550 - d.speed * 15) + Math.random() * 200;
    if (lastBirdX < dinoW - birdGap) {
      if (Math.random() < 0.010 * dt) {
        const bW = Math.round(dinoH * 0.25);
        const bH = Math.round(bW * 0.45);
        // –î–≤–∞ —É—Ä–æ–≤–Ω—è –≤—ã—Å–æ—Ç—ã: LOW (–Ω–∞–¥–æ –ø—Ä—ã–≥–∞—Ç—å) –∏ HIGH (–Ω–∞–¥–æ –ø—Ä–∏—Å–µ–¥–∞—Ç—å)
        // LOW: –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–µ–º–ª–∏ ‚Äî –ø—Ç–∏—Ü–∞ –ª–µ—Ç–∏—Ç –Ω–∞ –≤—ã—Å–æ—Ç–µ —Ç–µ–ª–∞ –¥–∏–Ω–æ
        // HIGH: –≤—ã—à–µ ‚Äî –¥–∏–Ω–æ –ø—Ä–æ–ª–µ—Ç–∞–µ—Ç –ø–æ–¥ –Ω–µ–π –ø—Ä–∏—Å–µ–¥–∞—è
        const isHigh = Math.random() < 0.45;
        const birdY = isHigh
          ? dinoGround - d.baseH * 1.05 - bH  // –≤—ã—Å–æ–∫–æ ‚Äî –Ω–∞–¥–æ –ø—Ä–∏—Å–µ—Å—Ç—å
          : dinoGround - d.baseH * 0.65 - bH; // –Ω–∏–∑–∫–æ ‚Äî –Ω–∞–¥–æ –ø—Ä—ã–≥–Ω—É—Ç—å
        dinoBirds.push({ x: dinoW + 10, w: bW, h: bH, y: birdY, high: isHigh });
      }
    }
  }

  // –î–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
  for (const obs of dinoObstacles) obs.x -= d.speed * dt;
  while (dinoObstacles.length && dinoObstacles[0].x + dinoObstacles[0].w < 0) dinoObstacles.shift();

  for (const bird of dinoBirds) bird.x -= d.speed * dt;
  while (dinoBirds.length && dinoBirds[0].x + dinoBirds[0].w < 0) dinoBirds.shift();

  // –û–±–ª–∞–∫–æ
  dinoCloudX -= d.speed * 0.25 * dt;
  if (dinoCloudX < -100) dinoCloudX = dinoW + 30;

  // –ö–æ–ª–ª–∏–∑–∏–∏
  const pad = Math.round(d.w * 0.13);
  const checkHit = (obs) =>
    d.x + d.w - pad > obs.x + pad && d.x + pad < obs.x + obs.w - pad &&
    d.y + d.h - pad > obs.y + pad && d.y + pad < obs.y + obs.h - pad;

  for (const obs of dinoObstacles) {
    if (checkHit(obs)) { dinoDie(); return; }
  }
  for (const bird of dinoBirds) {
    if (checkHit(bird)) { dinoDie(); return; }
  }
}

function dinoDie() {
  dinoStop();
  dinoRunning = false;
  SFX.play('dinoCactus');
  dinoDraw();
  _dinoPaintMsg('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞');
  toast('ü¶ï –°—á—ë—Ç: ' + dinoScore);
}

function dinoDraw() {
  const canvas = document.getElementById('dino-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const accent = getAccent();

  // –§–æ–Ω
  ctx.fillStyle = '#111'; ctx.fillRect(0, 0, dinoW, dinoH);

  // –ó–µ–º–ª—è
  ctx.fillStyle = 'rgba(255,255,255,0.25)';
  ctx.fillRect(0, dinoGround, dinoW, 1);

  // –ü—ã–ª—å –ø—Ä–∏ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏–∏
  for (const p of dinoDustParticles) {
    ctx.globalAlpha = Math.max(0, p.life * 0.55);
    ctx.fillStyle = accent;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r * p.life, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // –ö–∞–º—É—à–∫–∏ –Ω–∞ –∑–µ–º–ª–µ
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  const pebbleSeed = Math.floor(dinoFrameCount * 0.5) % 40;
  for (let i = 0; i < 8; i++) {
    const px = ((i * 53 + 7 - pebbleSeed) % (dinoW + 20)) - 10;
    const pw = 3 + (i * 7 % 5), ph = 2 + (i * 3 % 3);
    ctx.fillRect(px, dinoGround + 3 + (i % 3), pw, ph);
  }

  // –û–±–ª–∞–∫–∞
  const drawCloud = (cx, cy, scale) => {
    ctx.fillStyle = 'rgba(255,255,255,0.07)';
    const s = scale || 1;
    ctx.fillRect(cx, cy + 5*s, 46*s, 7*s);
    ctx.fillRect(cx + 8*s, cy + 2*s, 22*s, 5*s);
    ctx.fillRect(cx + 14*s, cy, 14*s, 3*s);
  };
  drawCloud(dinoCloudX, dinoH * 0.1, 1);
  drawCloud((dinoCloudX + dinoW * 0.6) % (dinoW + 60) - 30, dinoH * 0.06, 0.7);
  drawCloud((dinoCloudX + dinoW * 0.3) % (dinoW + 50) - 20, dinoH * 0.2, 0.85);

  // HI + —Å—á—ë—Ç
  const fs = Math.round(dinoH * 0.13);
  ctx.font = `700 ${fs}px "JetBrains Mono",monospace`;
  ctx.textAlign = 'right';
  if (dinoHi > 0) {
    ctx.fillStyle = 'rgba(255,255,255,0.28)';
    ctx.fillText('HI ' + String(dinoHi).padStart(5,'0'), dinoW - 8, fs + 4);
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    const hiW = ctx.measureText('HI 00000').width + 6;
    ctx.fillText(String(dinoScore).padStart(5,'0'), dinoW - 8 - hiW, fs + 4);
  } else {
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    ctx.fillText(String(dinoScore).padStart(5,'0'), dinoW - 8, fs + 4);
  }
  ctx.textAlign = 'left';

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é (–ø–µ—Ä–≤—ã–µ 10 –æ—á–∫–æ–≤)
  if (dinoScore < 10) {
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.font = `${Math.round(dinoH * 0.09)}px sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillText('‚ñ≤ –ø—Ä—ã–∂–æ–∫  ‚ñº –ø—Ä–∏—Å–µ—Å—Ç—å', dinoW / 2, dinoH * 0.88);
    ctx.textAlign = 'left';
  }

  // ‚îÄ‚îÄ –ö–∞–∫—Ç—É—Å—ã ‚îÄ‚îÄ
  for (const obs of dinoObstacles) {
    ctx.fillStyle = accent;
    ctx.shadowColor = accent; ctx.shadowBlur = 5;
    const tW = Math.max(3, Math.round(obs.w * 0.32));
    const tX = obs.x + Math.round((obs.w - tW) / 2);
    ctx.fillRect(tX, obs.y, tW, obs.h);
    const aH = Math.round(obs.h * 0.32), aW = Math.round(obs.w * 0.35);
    ctx.fillRect(obs.x, obs.y + Math.round(obs.h * 0.25), aW, aH);
    ctx.fillRect(obs.x, obs.y + Math.round(obs.h * 0.25) - Math.round(aH * 0.55), aW, Math.round(aH * 0.55));
    const rX = obs.x + obs.w - aW;
    ctx.fillRect(rX, obs.y + Math.round(obs.h * 0.35), aW, aH);
    ctx.fillRect(rX + Math.round(aW * 0.55), obs.y + Math.round(obs.h * 0.35) - Math.round(aH * 0.45), Math.round(aW * 0.45), Math.round(aH * 0.45));
    ctx.shadowBlur = 0;
  }

  // ‚îÄ‚îÄ –ü—Ç–µ—Ä–æ–¥–∞–∫—Ç–∏–ª–∏ ‚îÄ‚îÄ
  for (const bird of dinoBirds) {
    ctx.fillStyle = accent;
    ctx.shadowColor = accent; ctx.shadowBlur = 6;
    const bx = Math.round(bird.x), by = Math.round(bird.y);
    const bw = bird.w, bh = bird.h;
    // –¢–µ–ª–æ –ø—Ç–∏—Ü—ã (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)
    const bodyW = Math.round(bw * 0.45), bodyH = Math.round(bh * 0.42);
    const bodyX = bx + Math.round((bw - bodyW) / 2);
    const bodyY = by + Math.round(bh * 0.35);
    ctx.fillRect(bodyX, bodyY, bodyW, bodyH);
    // –ì–æ–ª–æ–≤–∞ (—Å–ø—Ä–∞–≤–∞ –æ—Ç —Ç–µ–ª–∞)
    const headW = Math.round(bw * 0.22), headH = Math.round(bh * 0.32);
    ctx.fillRect(bodyX + bodyW - Math.round(headW * 0.3), bodyY - Math.round(headH * 0.5), headW, headH);
    // –ö–ª—é–≤
    ctx.fillRect(bodyX + bodyW + Math.round(headW * 0.6), bodyY - Math.round(headH * 0.15), Math.round(bw * 0.15), Math.round(bh * 0.12));
    // –•–≤–æ—Å—Ç (—Å–ª–µ–≤–∞)
    ctx.fillRect(bx, bodyY + Math.round(bodyH * 0.2), Math.round(bw * 0.15), Math.round(bh * 0.14));
    // –ö—Ä—ã–ª—å—è (2-–∫–∞–¥—Ä–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è)
    const wingW = Math.round(bw * 0.42), wingH = Math.round(bh * 0.38);
    if (dinoBirdWing === 0) {
      // –ö—Ä—ã–ª—å—è –≤–≤–µ—Ä—Ö
      ctx.fillRect(bodyX - Math.round(wingW * 0.5), by, wingW, Math.round(wingH * 0.6));
      ctx.fillRect(bodyX + Math.round(bodyW * 0.3), by, Math.round(wingW * 0.8), Math.round(wingH * 0.5));
    } else {
      // –ö—Ä—ã–ª—å—è –≤–Ω–∏–∑
      ctx.fillRect(bodyX - Math.round(wingW * 0.5), bodyY - Math.round(wingH * 0.2), wingW, Math.round(wingH * 0.55));
      ctx.fillRect(bodyX + Math.round(bodyW * 0.3), bodyY - Math.round(wingH * 0.15), Math.round(wingW * 0.8), Math.round(wingH * 0.5));
    }
    ctx.shadowBlur = 0;
  }

  // ‚îÄ‚îÄ –î–∏–Ω–æ (–ø–∏–∫—Å–µ–ª—å–Ω—ã–π, Google-—Å—Ç–∏–ª—å) ‚îÄ‚îÄ
  const d = dinoDino;
  const isDuck = dinoDucking && d.onGround;
  // Scale unit: –≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç ~47, –≤ –ø—Ä–∏—Å–µ–¥–µ ~26
  const U = d.h / (isDuck ? 26 : 47);
  const bx = Math.round(d.x), by = Math.round(d.y);

  ctx.fillStyle = accent;
  ctx.shadowColor = accent; ctx.shadowBlur = 6;

  if (!isDuck) {
    // ‚îÄ‚îÄ –û–±—ã—á–Ω—ã–π –¥–∏–Ω–æ ‚îÄ‚îÄ
    ctx.fillRect(bx,                      by + Math.round(23*U), Math.round(6*U),  Math.round(6*U));  // —Ö–≤–æ—Å—Ç
    ctx.fillRect(bx+Math.round(2*U),      by + Math.round(27*U), Math.round(5*U),  Math.round(4*U));
    ctx.fillRect(bx+Math.round(4*U),      by+Math.round(20*U),   Math.round(18*U), Math.round(20*U)); // —Ç–æ—Ä—Å
    ctx.fillRect(bx+Math.round(18*U),     by+Math.round(24*U),   Math.round(8*U),  Math.round(12*U)); // –≥—Ä—É–¥—å
    ctx.fillRect(bx+Math.round(15*U),     by+Math.round(12*U),   Math.round(10*U), Math.round(11*U)); // —à–µ—è
    ctx.fillRect(bx+Math.round(10*U),     by,                    Math.round(22*U), Math.round(14*U)); // –≥–æ–ª–æ–≤–∞
    ctx.fillRect(bx+Math.round(8*U),      by+Math.round(4*U),    Math.round(24*U), Math.round(9*U));
    ctx.fillStyle = '#111'; ctx.shadowBlur = 0;
    ctx.fillRect(bx+Math.round(22*U),     by+Math.round(10*U),   Math.round(10*U), Math.round(4*U));  // –ø–∞—Å—Ç—å
    ctx.fillStyle = '#f0ede8';
    ctx.fillRect(bx+Math.round(22*U),     by+Math.round(2*U),    Math.round(6*U),  Math.round(6*U));  // –±–µ–ª–æ–∫
    ctx.fillStyle = '#111';
    ctx.fillRect(bx+Math.round(25*U),     by+Math.round(3*U),    Math.round(3*U),  Math.round(3*U));  // –∑—Ä–∞—á–æ–∫
    ctx.fillStyle = accent; ctx.shadowColor = accent; ctx.shadowBlur = 4;
    ctx.fillRect(bx+Math.round(18*U),     by+Math.round(27*U),   Math.round(6*U),  Math.round(3*U));  // –ª–∞–ø–∫–∞
    // –ù–æ–≥–∏
    const legW = Math.round(5*U), legH = Math.round(11*U);
    const legY = by + Math.round(38*U);
    if (!d.onGround) {
      ctx.fillRect(bx+Math.round(8*U),  legY, legW, Math.round(8*U));
      ctx.fillRect(bx+Math.round(16*U), legY + Math.round(4*U), legW, Math.round(6*U));
    } else if (dinoLegFrame === 0) {
      ctx.fillRect(bx+Math.round(7*U),  legY,                    legW, legH);
      ctx.fillRect(bx+Math.round(7*U),  legY+legH-Math.round(U), Math.round(7*U), Math.round(2*U));
      ctx.fillRect(bx+Math.round(18*U), legY+Math.round(4*U),    legW, legH-Math.round(4*U));
      ctx.fillRect(bx+Math.round(16*U), legY+legH-Math.round(U), Math.round(7*U), Math.round(2*U));
    } else {
      ctx.fillRect(bx+Math.round(7*U),  legY+Math.round(4*U),    legW, legH-Math.round(4*U));
      ctx.fillRect(bx+Math.round(5*U),  legY+legH-Math.round(U), Math.round(7*U), Math.round(2*U));
      ctx.fillRect(bx+Math.round(18*U), legY,                    legW, legH);
      ctx.fillRect(bx+Math.round(18*U), legY+legH-Math.round(U), Math.round(7*U), Math.round(2*U));
    }
  } else {
    // ‚îÄ‚îÄ –î–∏–Ω–æ –≤ –ø—Ä–∏—Å–µ–¥–µ (–ø–ª–æ—Å–∫–∏–π, –≤—ã—Ç—è–Ω—É—Ç—ã–π) ‚îÄ‚îÄ
    const DW = d.w * 1.3; // –ø—Ä–∏—Å–µ–≤ ‚Äî –¥–ª–∏–Ω–Ω–µ–µ
    ctx.fillRect(bx,                   by + Math.round(8*U),  Math.round(8*U),  Math.round(8*U));  // —Ö–≤–æ—Å—Ç
    ctx.fillRect(bx+Math.round(6*U),   by + Math.round(6*U),  Math.round(DW*0.55), Math.round(14*U)); // —Ç–µ–ª–æ
    ctx.fillRect(bx+Math.round(DW*0.45), by,                  Math.round(DW*0.35), Math.round(10*U)); // –≥–æ–ª–æ–≤–∞
    ctx.fillRect(bx+Math.round(DW*0.78), by+Math.round(2*U), Math.round(DW*0.18), Math.round(5*U));  // –∫–ª—é–≤
    ctx.fillStyle = '#f0ede8';
    ctx.fillRect(bx+Math.round(DW*0.5), by+Math.round(1*U), Math.round(5*U), Math.round(4*U));  // –≥–ª–∞–∑
    ctx.fillStyle = '#111'; ctx.shadowBlur = 0;
    ctx.fillRect(bx+Math.round(DW*0.53), by+Math.round(2*U), Math.round(3*U), Math.round(2*U)); // –∑—Ä–∞—á–æ–∫
    ctx.fillStyle = accent; ctx.shadowColor = accent; ctx.shadowBlur = 4;
    // –ù–æ–≥–∏ –ø—Ä–∏ –ø—Ä–∏—Å–µ–¥–µ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ)
    const legH2 = Math.round(5*U);
    ctx.fillRect(bx+Math.round(8*U),  by+Math.round(18*U), Math.round(7*U), legH2);
    ctx.fillRect(bx+Math.round(18*U), by+Math.round(20*U), Math.round(7*U), legH2);
  }
  ctx.shadowBlur = 0;
}

function _dinoPaintMsg(msg) {
  const canvas = document.getElementById('dino-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,.6)'; ctx.fillRect(0, dinoH/2-26, dinoW, 52);
  ctx.fillStyle = '#f0ede8'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText(msg, dinoW/2, dinoH/2+6);
}

function dinoUpdateScore() {
  const el = document.getElementById('dino-score-label');
  if (el) el.textContent = '–°—á—ë—Ç: ' + dinoScore + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + dinoHi;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üü¶ BLOCK BLAST (v2.0.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BB_ROWS = 8, BB_COLS = 8;
let bbGrid, bbScore = 0, bbHi = 0, bbPieces, bbDragging = null;
let bbCellSize, bbDifficulty = 'normal';

const BB_SHAPES = [
  [[1,1],[1,1]],      // 2x2
  [[1,1,1]],          // 1x3
  [[1],[1],[1]],      // 3x1
  [[1,1,1],[0,1,0]], // T-shape
  [[1,0],[1,1]],     // L small
  [[0,1],[1,1]],     // J small
  [[1,1,0],[0,1,1]], // S
  [[0,1,1],[1,1,0]], // Z
  [[1,1,1,1]],       // I
  [[1]],             // dot
  [[1,1,1],[1,0,0]], // L
  [[1,1,1],[0,0,1]], // J
];

const BB_COLORS = ['#e87722','#00e5ff','#a78bfa','#4caf7d','#f5c518','#c94f4f','#60cdff','#f472b6'];

function bbInit() {
  bbHi = getHi("blockblast");
  const wrap = document.getElementById('bb-board-wrap');
  const maxW = Math.min(window.innerWidth - 64, 280);
  bbCellSize = Math.floor(maxW / BB_COLS);
  bbRestart();
}

function bbRestart() {
  bbGrid = Array.from({length: BB_ROWS}, () => Array(BB_COLS).fill(null));
  bbScore = 0;
  bbUpdateScore();
  bbGeneratePieces();
  bbRenderBoard();
}

function bbRandomPiece() {
  const shape = BB_SHAPES[Math.floor(Math.random() * BB_SHAPES.length)];
  const color = BB_COLORS[Math.floor(Math.random() * BB_COLORS.length)];
  return { shape, color, placed: false };
}

function bbGeneratePieces() {
  bbPieces = [bbRandomPiece(), bbRandomPiece(), bbRandomPiece()];
  bbRenderPieces();
}

function bbUpdateScore() {
  const el = document.getElementById('bb-score-label');
  if (el) el.textContent = '–°—á—ë—Ç: ' + bbScore + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + bbHi;
}

function bbRenderBoard() {
  const wrap = document.getElementById('bb-board-wrap');
  if (!wrap) return;
  const cs = bbCellSize;
  const bw = cs * BB_COLS, bh = cs * BB_ROWS;

  wrap.innerHTML = '';
  const canvas = document.createElement('canvas');
  canvas.id = 'bb-canvas';
  canvas.width = bw; canvas.height = bh;
  canvas.style.borderRadius = '12px';
  canvas.style.border = '1.5px solid var(--surface3)';
  wrap.appendChild(canvas);

  canvas.addEventListener('dragover', e => { e.preventDefault(); bbOnDragOver(e, canvas); });
  canvas.addEventListener('drop',     e => { e.preventDefault(); bbOnDrop(e, canvas); });
  // Touch events for mobile drag-and-drop
  canvas.addEventListener('touchmove',  e => { e.preventDefault(); bbOnTouchMove(e, canvas); }, {passive:false});
  canvas.addEventListener('touchend',   e => { e.preventDefault(); bbOnTouchEnd(e, canvas); }, {passive:false});

  bbDrawBoard();
}

function bbDrawBoard() {
  const canvas = document.getElementById('bb-canvas'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cs = bbCellSize;
  ctx.fillStyle = '#181818'; ctx.fillRect(0, 0, cs*BB_COLS, cs*BB_ROWS);
  for (let r = 0; r < BB_ROWS; r++) for (let c = 0; c < BB_COLS; c++) {
    const v = bbGrid[r][c];
    if (v) {
      ctx.fillStyle = v; ctx.shadowColor = v; ctx.shadowBlur = 4;
      if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(c*cs+1.5, r*cs+1.5, cs-3, cs-3, 3); ctx.fill(); }
      else ctx.fillRect(c*cs+1.5, r*cs+1.5, cs-3, cs-3);
      ctx.shadowBlur = 0;
      ctx.fillStyle = 'rgba(255,255,255,.14)'; ctx.fillRect(c*cs+2.5, r*cs+2.5, cs-5, (cs-5)*0.35);
    } else {
      ctx.strokeStyle = 'rgba(255,255,255,.06)'; ctx.lineWidth = 0.5;
      ctx.strokeRect(c*cs+0.5, r*cs+0.5, cs-1, cs-1);
    }
  }
  // Drop preview
  if (bbDragging && bbDragging.previewR !== undefined) {
    const piece = bbDragging.piece;
    const pr = bbDragging.previewR, pc = bbDragging.previewC;
    const canPlace = bbCanPlace(piece.shape, pr, pc);
    piece.shape.forEach((row, dr) => row.forEach((v, dc) => {
      if (!v) return;
      const gr = pr + dr, gc = pc + dc;
      if (gr < 0 || gr >= BB_ROWS || gc < 0 || gc >= BB_COLS) return;
      ctx.fillStyle = canPlace ? (piece.color + '80') : 'rgba(201,79,79,0.5)';
      if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(gc*cs+1.5, gr*cs+1.5, cs-3, cs-3, 3); ctx.fill(); }
      else ctx.fillRect(gc*cs+1.5, gr*cs+1.5, cs-3, cs-3);
    }));
  }
}

// Piece mini-canvas rendering + drag setup
function bbRenderPieces() {
  const wrap = document.getElementById('bb-pieces-wrap'); if (!wrap) return;
  wrap.innerHTML = '';
  // Remove old global touch listeners
  document.removeEventListener('touchmove', bbDocTouchMove);
  document.removeEventListener('touchend', bbDocTouchEnd);

  bbPieces.forEach((piece, idx) => {
    if (piece.placed) { const ph = document.createElement('div'); ph.style.width='80px'; wrap.appendChild(ph); return; }
    const cs = Math.floor(bbCellSize * 0.85);
    const pw = piece.shape[0].length * cs, ph2 = piece.shape.length * cs;
    const cv = document.createElement('canvas');
    cv.width = pw; cv.height = ph2;
    cv.style.cursor = 'grab';
    cv.style.touchAction = 'none';
    cv.style.opacity = '1';
    cv.style.display = 'block';
    cv.style.flexShrink = '0';
    cv.style.transition = 'transform .15s, opacity .15s';
    wrap.appendChild(cv);
    const ctx2 = cv.getContext('2d');
    piece.shape.forEach((row, r) => row.forEach((v, c) => {
      if (!v) return;
      ctx2.fillStyle = piece.color; ctx2.shadowColor = piece.color; ctx2.shadowBlur = 3;
      if (ctx2.roundRect) { ctx2.beginPath(); ctx2.roundRect(c*cs+1, r*cs+1, cs-2, cs-2, 3); ctx2.fill(); }
      else ctx2.fillRect(c*cs+1, r*cs+1, cs-2, cs-2);
      ctx2.shadowBlur = 0;
      ctx2.fillStyle = 'rgba(255,255,255,.15)'; ctx2.fillRect(c*cs+2, r*cs+2, cs-4, (cs-4)*0.35);
    }));

    // Desktop drag
    cv.setAttribute('draggable', 'true');
    cv.addEventListener('dragstart', e => {
      // Track where within piece the user grabbed (in cell units)
      const rect = cv.getBoundingClientRect();
      const localX = e.clientX - rect.left, localY = e.clientY - rect.top;
      const grabCol = Math.floor(localX / cs), grabRow = Math.floor(localY / cs);
      bbDragging = { piece, idx, pieceCS: cs, grabRow, grabCol };
      cv.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    });
    cv.addEventListener('dragend', () => { if (cv) cv.style.opacity = '1'; bbDragging = null; bbDrawBoard(); });

    // Mobile touch drag
    cv.addEventListener('touchstart', e => {
      e.preventDefault();
      const t = e.touches[0];
      const rect = cv.getBoundingClientRect();
      const localX = t.clientX - rect.left, localY = t.clientY - rect.top;
      const grabCol = Math.floor(localX / cs), grabRow = Math.floor(localY / cs);
      bbDragging = { piece, idx, pieceCS: cs, grabRow, grabCol };
      cv.style.transform = 'scale(1.15)';
      cv.style.opacity = '0.7';
      // Attach global doc listeners so we track movement outside piece canvas
      document.addEventListener('touchmove', bbDocTouchMove, {passive:false});
      document.addEventListener('touchend', bbDocTouchEnd, {passive:false});
    }, {passive:false});
  });
}

function bbDocTouchMove(e) {
  if (!bbDragging) return;
  e.preventDefault();
  const t = e.touches[0];
  const canvas = document.getElementById('bb-canvas');
  if (!canvas) return;
  const rect = canvas.getBoundingClientRect();
  const cs = bbCellSize;
  const x = t.clientX - rect.left, y = t.clientY - rect.top;
  const touchCol = Math.floor(x / cs), touchRow = Math.floor(y / cs);
  const pr = touchRow - (bbDragging.grabRow || 0);
  const pc = touchCol - (bbDragging.grabCol || 0);
  bbDragging.previewR = pr; bbDragging.previewC = pc;
  bbDrawBoard();
}

function bbDocTouchEnd(e) {
  if (!bbDragging) return;
  e.preventDefault();
  document.removeEventListener('touchmove', bbDocTouchMove);
  document.removeEventListener('touchend', bbDocTouchEnd);
  // Remove visual feedback from all piece canvases
  const wrap = document.getElementById('bb-pieces-wrap');
  if (wrap) wrap.querySelectorAll('canvas').forEach(cv => { cv.style.transform = ''; cv.style.opacity = '1'; });
  const pr = bbDragging.previewR, pc = bbDragging.previewC;
  if (pr !== undefined) {
    bbTryPlaceDirect(pr, pc);
  } else {
    bbDragging = null; bbDrawBoard();
  }
}

function bbGetGridCell(e, canvas) {
  const rect = canvas.getBoundingClientRect();
  const cs = bbCellSize;
  const x = (e.clientX !== undefined ? e.clientX : (e.touches ? e.touches[0].clientX : 0)) - rect.left;
  const y = (e.clientY !== undefined ? e.clientY : (e.touches ? e.touches[0].clientY : 0)) - rect.top;
  return { r: Math.floor(y / cs), c: Math.floor(x / cs) };
}

function bbOnDragOver(e, canvas) {
  if (!bbDragging) return;
  const { r, c } = bbGetGridCell(e, canvas);
  const pr = r - (bbDragging.grabRow || Math.floor(bbDragging.piece.shape.length / 2));
  const pc = c - (bbDragging.grabCol || Math.floor(bbDragging.piece.shape[0].length / 2));
  bbDragging.previewR = pr; bbDragging.previewC = pc;
  bbDrawBoard();
}

function bbOnTouchMove(e, canvas) {
  // handled by document-level bbDocTouchMove
}

function bbOnTouchEnd(e, canvas) {
  // handled by document-level bbDocTouchEnd
}

function bbOnDrop(e, canvas) {
  if (!bbDragging) return;
  const { r, c } = bbGetGridCell(e, canvas);
  bbTryPlace(r, c);
}

function bbOnTouchEnd(e, canvas) {
  if (!bbDragging) return;
  // Use last known position from last touchmove
  const pr = bbDragging.previewR, pc = bbDragging.previewC;
  if (pr !== undefined) {
    bbTryPlaceDirect(pr, pc);
  }
  // Reset piece visuals
  const wrap = document.getElementById('bb-pieces-wrap');
  if (wrap) wrap.querySelectorAll('canvas').forEach(cv => { cv.style.transform = ''; });
  bbDragging = null;
  bbDrawBoard();
}

function bbTryPlace(r, c) {
  if (!bbDragging) return;
  const pr = r - (bbDragging.grabRow || Math.floor(bbDragging.piece.shape.length / 2));
  const pc = c - (bbDragging.grabCol || Math.floor(bbDragging.piece.shape[0].length / 2));
  bbTryPlaceDirect(pr, pc);
}

function bbCanPlace(shape, pr, pc) {
  for (let dr = 0; dr < shape.length; dr++) for (let dc = 0; dc < shape[dr].length; dc++) {
    if (!shape[dr][dc]) continue;
    const gr = pr + dr, gc = pc + dc;
    if (gr < 0 || gr >= BB_ROWS || gc < 0 || gc >= BB_COLS || bbGrid[gr][gc]) return false;
  }
  return true;
}

function bbTryPlaceDirect(pr, pc) {
  if (!bbDragging) return;
  const piece = bbDragging.piece;
  if (!bbCanPlace(piece.shape, pr, pc)) {
    toast('‚ùå –ù–µ –≤–ª–µ–∑–∞–µ—Ç!'); bbDragging = null; bbDrawBoard(); return;
  }
  // Place
  piece.shape.forEach((row, dr) => row.forEach((v, dc) => {
    if (v) bbGrid[pr + dr][pc + dc] = piece.color;
  }));
  bbDragging.piece.placed = true;
  bbDragging = null;
  SFX.play('bbPlace');

  // Count cells
  let cells = 0; piece.shape.forEach(r => r.forEach(v => { if(v) cells++; }));
  bbScore += cells;
  if (bbScore > bbHi) bbHi = saveHi("blockblast", bbScore);

  bbClearLines();
  bbDrawBoard();
  bbUpdateScore();

  // If all placed, generate new
  if (bbPieces.every(p => p.placed)) setTimeout(() => { bbGeneratePieces(); bbDrawBoard(); }, 300);
  else bbRenderPieces();
}

function bbClearLines() {
  const toClear = new Set();
  // Check rows
  for (let r = 0; r < BB_ROWS; r++) if (bbGrid[r].every(v => v)) {
    for (let c = 0; c < BB_COLS; c++) toClear.add(`${r},${c}`);
  }
  // Check cols
  for (let c = 0; c < BB_COLS; c++) {
    let full = true;
    for (let r = 0; r < BB_ROWS; r++) if (!bbGrid[r][c]) { full = false; break; }
    if (full) for (let r = 0; r < BB_ROWS; r++) toClear.add(`${r},${c}`);
  }
  if (!toClear.size) return;
  SFX.play('bbLine');
  bbScore += toClear.size * 10;
  if (bbScore > bbHi) bbHi = saveHi("blockblast", bbScore);

  const canvas = document.getElementById('bb-canvas'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cs = bbCellSize;

  // Collect cell data for animation
  const cells = [];
  toClear.forEach(key => {
    const [r, c] = key.split(',').map(Number);
    cells.push({ r, c, color: bbGrid[r][c], scale: 1, alpha: 1, vy: 0 });
  });

  const startTime = performance.now();
  const DURATION = 380;

  function animFrame(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / DURATION, 1);
    // Easing: fast at start, smooth out
    const ease = 1 - Math.pow(1 - t, 3);

    bbDrawBoard();

    // Draw animating cells on top
    for (const cell of cells) {
      const sc = 1 - ease * 0.8; // shrink
      const alpha = 1 - ease;
      const x = cell.c * cs + cs / 2;
      const y = cell.r * cs + cs / 2 + ease * cs * 0.4; // slight drop

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.translate(x, y);
      ctx.scale(sc, sc);
      ctx.fillStyle = cell.color;
      ctx.shadowColor = cell.color;
      ctx.shadowBlur = 8 * (1 - ease);
      if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(-cs/2 + 1.5, -cs/2 + 1.5, cs - 3, cs - 3, 3); ctx.fill(); }
      else ctx.fillRect(-cs/2 + 1.5, -cs/2 + 1.5, cs - 3, cs - 3);
      // Gleam flash at start
      if (t < 0.3) {
        ctx.fillStyle = `rgba(255,255,255,${0.6 * (1 - t / 0.3)})`;
        ctx.fillRect(-cs/2 + 1.5, -cs/2 + 1.5, cs - 3, (cs - 3) * 0.5);
      }
      ctx.restore();
    }
    ctx.globalAlpha = 1; ctx.shadowBlur = 0;

    if (t < 1) {
      requestAnimationFrame(animFrame);
    } else {
      toClear.forEach(key => { const [r, c] = key.split(',').map(Number); bbGrid[r][c] = null; });
      bbDrawBoard();
      bbUpdateScore();
    }
  }
  requestAnimationFrame(animFrame);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üß± –ê–†–ö–ê–ù–û–ò–î (v2.1.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BR_COLS = 8, BR_BRICK_ROWS = 5;
let brRaf = null, brRunning = false, brLastTime = 0;
let brScore = 0, brHi = 0, brLives = 3, brDifficulty = 'normal';
let brW, brH, brBall, brPad, brBricks, brSpeed;
let brParticles = [];
let brWaiting = true;

const BR_DIFF = {
  easy:   { speed: 4.5, padW: 0.35 },
  normal: { speed: 5.5, padW: 0.27 },
  hard:   { speed: 7,   padW: 0.20 },
};

const BR_BRICK_COLORS = [
  ['#c94f4f','#c94f4f','#c94f4f','#c94f4f','#c94f4f','#c94f4f','#c94f4f','#c94f4f'],
  ['#e87722','#e87722','#e87722','#e87722','#e87722','#e87722','#e87722','#e87722'],
  ['#f5c518','#f5c518','#f5c518','#f5c518','#f5c518','#f5c518','#f5c518','#f5c518'],
  ['#4caf7d','#4caf7d','#4caf7d','#4caf7d','#4caf7d','#4caf7d','#4caf7d','#4caf7d'],
  ['#60cdff','#60cdff','#60cdff','#60cdff','#60cdff','#60cdff','#60cdff','#60cdff'],
];

function brInit() {
  brHi = getHi("breakout");
  const canvas = document.getElementById('br-canvas');
  const w = Math.min(window.innerWidth - 36, 360);
  canvas.width = w;
  canvas.height = Math.round(w * 1.3);
  brW = canvas.width; brH = canvas.height;
  const movePad = (clientX) => {
    const rect = canvas.getBoundingClientRect();
    const x = clientX - rect.left;
    brPad.x = Math.max(brPad.w/2, Math.min(brW - brPad.w/2, x));
    if (brWaiting) brBall.x = brPad.x;
  };
  canvas.ontouchmove = e => { e.preventDefault(); movePad(e.touches[0].clientX); };
  canvas.ontouchstart = e => { e.preventDefault(); movePad(e.touches[0].clientX); if (brWaiting && brRunning) brLaunch(); };
  canvas.onmousemove = e => movePad(e.clientX);
  canvas.onclick = () => { if (brWaiting && brRunning) brLaunch(); };
  brRestart();
}

function brRestart() {
  brStop();
  brLastTime = 0;
  brScore = 0; brLives = 3; brWaiting = true;
  const d = BR_DIFF[brDifficulty] || BR_DIFF.normal;
  brSpeed = d.speed;
  const padW = Math.round(brW * d.padW);
  brPad = { x: brW/2, w: padW, h: 10, y: brH - 28 };
  brBall = { x: brW/2, y: brPad.y - 9, r: 7, vx: 0, vy: 0, sx:1, sy:1, sqT:0, trail:[] };
  brBricks = [];
  const bw = Math.floor((brW - 16) / BR_COLS);
  const bh = Math.round(bw * 0.38);
  const startY = 30;
  for (let row = 0; row < BR_BRICK_ROWS; row++) {
    for (let col = 0; col < BR_COLS; col++) {
      brBricks.push({
        x: 8 + col * bw, y: startY + row * (bh + 4),
        w: bw - 3, h: bh,
        color: BR_BRICK_COLORS[row][col],
        alive: true, hits: row < 2 ? 2 : 1
      });
    }
  }
  brUpdateScore();
  brRunning = true;
  brRaf = requestAnimationFrame(brLoop);
}

function brLaunch() {
  if (!brWaiting) return;
  brWaiting = false;
  const angle = (Math.random() * 40 + 70) * Math.PI / 180;
  brBall.vx = Math.cos(angle) * brSpeed * (Math.random() > 0.5 ? 1 : -1);
  brBall.vy = -Math.abs(Math.sin(angle) * brSpeed);
}

function brStop() { cancelAnimationFrame(brRaf); brRaf = null; brRunning = false; }

function brLoop(ts) {
  if (!brRunning) return;
  const dt = brLastTime ? Math.min((ts - brLastTime) / 16.667, 3) : 1;
  brLastTime = ts;
  if (!brWaiting) brTick(dt);
  brDraw();
  brRaf = requestAnimationFrame(brLoop);
}

function brTick(dt) {
  const b = brBall;
  b.x += b.vx * dt; b.y += b.vy * dt;

  // Trail ‚Äî —Ö—Ä–∞–Ω–∏–º —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
  if (!b.trail) b.trail = [];
  const now2 = performance.now();
  b.trail.push({x: b.x, y: b.y, ts: now2});
  while (b.trail.length > 0 && now2 - b.trail[0].ts > 160) b.trail.shift();

  // Squish recovery
  if (b.sqT > 0) {
    b.sqT = Math.max(0, b.sqT - dt * 0.17);
    b.sx = 1 + (b._sqTx || 0) * b.sqT;
    b.sy = 1 + (b._sqTy || 0) * b.sqT;
  } else { b.sx = 1; b.sy = 1; }

  if (b.x - b.r < 0) {
    b.x = b.r; b.vx = Math.abs(b.vx);
    b.sx = 0.84; b.sy = 1.14; b._sqTx = -0.16; b._sqTy = 0.14; b.sqT = 1;
    SFX.play('brWall');
  }
  if (b.x + b.r > brW) {
    b.x = brW - b.r; b.vx = -Math.abs(b.vx);
    b.sx = 0.84; b.sy = 1.14; b._sqTx = -0.16; b._sqTy = 0.14; b.sqT = 1;
    SFX.play('brWall');
  }
  if (b.y - b.r < 0) {
    b.y = b.r; b.vy = Math.abs(b.vy);
    b.sx = 1.14; b.sy = 0.84; b._sqTx = 0.14; b._sqTy = -0.16; b.sqT = 1;
  }
  const pl = brPad.x - brPad.w/2, pr2 = brPad.x + brPad.w/2;
  if (b.vy > 0 && b.y + b.r >= brPad.y && b.y + b.r <= brPad.y + brPad.h + 4
      && b.x >= pl - b.r && b.x <= pr2 + b.r) {
    b.y = brPad.y - b.r;
    const hit = (b.x - brPad.x) / (brPad.w / 2);
    const angle = hit * 65 * Math.PI / 180;
    const spd = Math.sqrt(b.vx*b.vx + b.vy*b.vy);
    b.vx = Math.sin(angle) * spd;
    b.vy = -Math.cos(angle) * spd;
    b.sx = 1.16; b.sy = 0.86; b._sqTx = 0.16; b._sqTy = -0.14; b.sqT = 1;
    SFX.play('brPaddle');
  }
  let brokeCount = 0;
  for (const bk of brBricks) {
    if (!bk.alive) continue;
    if (b.x + b.r > bk.x && b.x - b.r < bk.x + bk.w &&
        b.y + b.r > bk.y && b.y - b.r < bk.y + bk.h) {
      bk.hits--;
      if (bk.hits <= 0) {
        bk.alive = false; brokeCount++;
        // Brick death particles
        if (!brParticles) brParticles = [];
        for (let i = 0; i < 8; i++) {
          const ang = Math.random() * Math.PI * 2;
          const spd2 = 1.5 + Math.random() * 2.5;
          brParticles.push({ x: bk.x + bk.w/2, y: bk.y + bk.h/2, vx: Math.cos(ang)*spd2, vy: Math.sin(ang)*spd2, life: 1, color: bk.color });
        }
        SFX.play('brBrick');
      } else {
        bk.hitTime = performance.now(); // hit flash timestamp
      }
      const overlapL = (b.x + b.r) - bk.x, overlapR = (bk.x + bk.w) - (b.x - b.r);
      const overlapT = (b.y + b.r) - bk.y, overlapB = (bk.y + bk.h) - (b.y - b.r);
      if (Math.min(overlapL, overlapR) < Math.min(overlapT, overlapB)) {
        b.vx = -b.vx;
        b.sx = 0.86; b.sy = 1.14; b._sqTx = -0.14; b._sqTy = 0.14; b.sqT = 1;
      } else {
        b.vy = -b.vy;
        b.sx = 1.14; b.sy = 0.86; b._sqTx = 0.14; b._sqTy = -0.14; b.sqT = 1;
      }
      break;
    }
  }
  if (brokeCount) { brScore += brokeCount * 10; if (brScore > brHi) brHi = saveHi("breakout", brScore); brUpdateScore(); }
  if (brBricks.every(bk => !bk.alive)) {
    brStop(); brWaiting = true;
    SFX.play('brLevelUp');
    setTimeout(() => { brRestart(); toast('üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!'); }, 400);
    return;
  }
  if (b.y - b.r > brH) {
    brLives--;
    SFX.play('brLive');
    brUpdateScore();
    if (brLives <= 0) {
      brStop(); brRunning = false;
      brDraw(); brDrawMsg('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞');
      toast('üß± –°—á—ë—Ç: ' + brScore); return;
    }
    brWaiting = true;
    b.x = brPad.x; b.y = brPad.y - b.r - 2; b.vx = 0; b.vy = 0;
    b.trail = [];
    toast('‚ù§Ô∏è –û—Å—Ç–∞–ª–æ—Å—å –∂–∏–∑–Ω–µ–π: ' + brLives);
  }
  // Update particles
  if (brParticles) {
    for (let i = brParticles.length - 1; i >= 0; i--) {
      const p2 = brParticles[i];
      p2.x += p2.vx * dt * 0.5; p2.y += p2.vy * dt * 0.5;
      p2.life -= dt * 0.003;
      if (p2.life <= 0) brParticles.splice(i, 1);
    }
  }
}

function brDraw() {
  const canvas = document.getElementById('br-canvas'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const accent = getAccent();
  ctx.fillStyle = '#0d0d0d'; ctx.fillRect(0, 0, brW, brH);

  // Bricks
  for (const bk of brBricks) {
    if (!bk.alive) continue;
    const flashAge = bk.hitTime ? performance.now() - bk.hitTime : Infinity;
    const flashT = Math.max(0, 1 - flashAge / 120);
    ctx.globalAlpha = bk.hits > 1 ? 1 : 0.82;
    ctx.fillStyle = flashT > 0 ? `rgba(255,255,255,${flashT})` : bk.color;
    ctx.shadowColor = bk.color; ctx.shadowBlur = bk.hits > 1 ? 8 : 3;
    if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(bk.x, bk.y, bk.w, bk.h, 3); ctx.fill(); }
    else ctx.fillRect(bk.x, bk.y, bk.w, bk.h);
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'rgba(255,255,255,0.18)';
    ctx.fillRect(bk.x + 2, bk.y + 2, bk.w - 4, Math.floor((bk.h - 4) * 0.4));
    ctx.globalAlpha = 1;
  }

  // Particles
  if (brParticles) {
    for (const p2 of brParticles) {
      ctx.globalAlpha = Math.max(0, p2.life * 0.9);
      ctx.fillStyle = p2.color;
      ctx.shadowColor = p2.color; ctx.shadowBlur = 4;
      const sz = 3 * p2.life;
      ctx.fillRect(p2.x - sz/2, p2.y - sz/2, sz, sz);
    }
    ctx.shadowBlur = 0; ctx.globalAlpha = 1;
  }

  // Paddle
  const grad = ctx.createLinearGradient(brPad.x - brPad.w/2, 0, brPad.x + brPad.w/2, 0);
  grad.addColorStop(0, 'rgba(255,255,255,.15)'); grad.addColorStop(.5, accent); grad.addColorStop(1, 'rgba(255,255,255,.15)');
  ctx.fillStyle = grad; ctx.shadowColor = accent; ctx.shadowBlur = 10;
  if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(brPad.x - brPad.w/2, brPad.y, brPad.w, brPad.h, 6); ctx.fill(); }
  else ctx.fillRect(brPad.x - brPad.w/2, brPad.y, brPad.w, brPad.h);
  ctx.shadowBlur = 0;

  // Ball trail ‚Äî –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É —Ç–æ—á–∫–∏
  const bt = brBall.trail || [];
  const brTrailDur = 160;
  const nowBr = performance.now();
  for (let i = 0; i < bt.length; i++) {
    const age = nowBr - bt[i].ts;
    const t = Math.max(0, 1 - age / brTrailDur);
    const alpha = t * t * 0.5;
    const r = brBall.r * (0.2 + t * 0.6);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = '#fff';
    ctx.shadowColor = accent; ctx.shadowBlur = 6;
    ctx.beginPath(); ctx.arc(bt[i].x, bt[i].y, r, 0, Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1; ctx.shadowBlur = 0;

  // Ball with squish
  const sx = brBall.sx || 1, sy = brBall.sy || 1;
  ctx.save();
  ctx.translate(brBall.x, brBall.y);
  ctx.scale(sx, sy);
  ctx.fillStyle = '#fff'; ctx.shadowColor = accent; ctx.shadowBlur = 14;
  ctx.beginPath(); ctx.arc(0, 0, brBall.r, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();

  if (brWaiting && brRunning) {
    ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(0, brH/2 - 20, brW, 40);
    ctx.fillStyle = '#f0ede8'; ctx.font = 'bold 13px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('–¢–∞–ø–Ω–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ üèì', brW/2, brH/2 + 6); ctx.textAlign = 'left';
  }
}

function brDrawMsg(msg) {
  const canvas = document.getElementById('br-canvas'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,.65)'; ctx.fillRect(0, brH/2-30, brW, 60);
  ctx.fillStyle = '#f0ede8'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText(msg, brW/2, brH/2 + 6); ctx.textAlign = 'left';
  canvas.ontouchstart = () => brRestart();
  canvas.onclick = () => brRestart();
}

function brUpdateScore() {
  const el = document.getElementById('br-score-label'); if (!el) return;
  const hearts = '‚ù§Ô∏è'.repeat(Math.max(0,brLives)) + 'üñ§'.repeat(Math.max(0, 3 - brLives));
  el.textContent = '–°—á—ë—Ç: ' + brScore + ' ‚Ä¢ –†–µ–∫–æ—Ä–¥: ' + brHi + ' ‚Ä¢ ' + hearts;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ü´ß –ü–£–ó–´–†–ò (v2.2.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BUB_COLORS = ['#e87722','#00e5ff','#a78bfa','#4caf7d','#f5c518','#f472b6','#60cdff','#c94f4f'];
let bubRaf = null, bubRunning = false, bubLastTime = 0;
let bubScore = 0, bubHi = 0, bubLives = 3;
let bubW, bubH, bubBubbles = [], bubSpawnTimer = 0, bubDifficulty = 'normal', bubLevel = 1;
let bubLevelTimer = 0, bubCombo = 0, bubComboTimer = 0;

const BUB_DIFF = {
  easy:   { spawnInterval: 2200, lifespan: 3500, minR: 26, maxR: 42, maxBubs: 8  },
  normal: { spawnInterval: 1500, lifespan: 2800, minR: 22, maxR: 36, maxBubs: 12 },
  hard:   { spawnInterval: 900,  lifespan: 2000, minR: 16, maxR: 30, maxBubs: 16 },
};

function bubInit() {
  bubHi = getHi("bubbles");
  const canvas = document.getElementById('bub-canvas');
  const w = Math.min(window.innerWidth - 36, 360);
  canvas.width = w;
  canvas.height = Math.round(w * 1.2);
  bubW = canvas.width; bubH = canvas.height;
  const handleTap = (clientX, clientY) => {
    const rect = canvas.getBoundingClientRect();
    const tx = clientX - rect.left, ty = clientY - rect.top;
    let popped = false;
    for (let i = bubBubbles.length - 1; i >= 0; i--) {
      const b = bubBubbles[i];
      if (b.popped) continue;
      const dx = tx - b.x, dy = ty - b.y;
      if (dx*dx + dy*dy <= (b.r + 8)*(b.r + 8)) {
        b.popped = true; b.popTime = 0;
        bubCombo++; bubComboTimer = 1500;
        SFX.play('bubPop'); if(bubCombo>=3) SFX.play('bubCombo');
        const pts = Math.round(10 * bubCombo * (1 + bubLevel * 0.1));
        bubScore += pts; if (bubScore > bubHi) bubHi = saveHi("bubbles", bubScore);
        bubUpdateScore(); popped = true; break;
      }
    }
    if (!popped && bubRunning) bubCombo = 0;
  };
  canvas.ontouchstart = e => { e.preventDefault(); const t = e.touches[0]; handleTap(t.clientX, t.clientY); };
  canvas.onclick = e => handleTap(e.clientX, e.clientY);
  bubRestart();
}

function bubRestart() {
  bubStop();
  bubLastTime = 0; bubBubbles = []; bubSpawnTimer = 0;
  bubScore = 0; bubLives = 3; bubLevel = 1; bubLevelTimer = 0;
  bubCombo = 0; bubComboTimer = 0;
  bubUpdateScore(); bubRunning = true;
  bubRaf = requestAnimationFrame(bubLoop);
}

function bubStop() { cancelAnimationFrame(bubRaf); bubRaf = null; bubRunning = false; }

function bubLoop(ts) {
  if (!bubRunning) return;
  const dt = bubLastTime ? Math.min(ts - bubLastTime, 50) : 16;
  bubLastTime = ts;
  bubTick(dt); bubDraw();
  bubRaf = requestAnimationFrame(bubLoop);
}

function bubTick(dt) {
  const d = BUB_DIFF[bubDifficulty] || BUB_DIFF.normal;
  bubLevelTimer += dt; if (bubLevelTimer >= 25000) { bubLevelTimer = 0; bubLevel++; }
  if (bubComboTimer > 0) { bubComboTimer -= dt; if (bubComboTimer <= 0) bubCombo = 0; }
  const interval = Math.max(400, d.spawnInterval - bubLevel * 60);
  bubSpawnTimer += dt;
  if (bubSpawnTimer >= interval && bubBubbles.filter(b=>!b.popped).length < d.maxBubs) {
    bubSpawnTimer = 0;
    const r = d.minR + Math.random() * (d.maxR - d.minR);
    const lifespan = Math.max(900, d.lifespan - bubLevel * 80 + (Math.random()-0.5)*400);
    bubBubbles.push({
      x: r*1.5 + Math.random()*(bubW - r*3), y: r*1.5 + Math.random()*(bubH - r*3 - 40),
      r, color: BUB_COLORS[Math.floor(Math.random()*BUB_COLORS.length)],
      age: 0, lifespan, popped: false, popTime: -1,
      vy: (Math.random()-0.5)*0.25, vx: (Math.random()-0.5)*0.18,
      spawnT: 0,  // 0‚Üí1 –ø–æ—è–≤–ª–µ–Ω–∏–µ
      wobble: Math.random() * Math.PI * 2, // —Ñ–∞–∑–∞ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏—è
      wobbleSpeed: 0.003 + Math.random() * 0.002,
    });
  }
  for (let i = bubBubbles.length-1; i >= 0; i--) {
    const b = bubBubbles[i];
    if (b.popped) { b.popTime += dt; if (b.popTime > 520) bubBubbles.splice(i,1); continue; }
    b.age += dt;
    b.spawnT = Math.min(1, (b.spawnT || 0) + dt * 0.006);
    b.wobble = (b.wobble || 0) + (b.wobbleSpeed || 0.003) * dt;
    b.x += b.vx * dt * 0.06; b.y += b.vy * dt * 0.06;
    if (b.x-b.r < 0) { b.x=b.r; b.vx=Math.abs(b.vx); }
    if (b.x+b.r > bubW) { b.x=bubW-b.r; b.vx=-Math.abs(b.vx); }
    if (b.y-b.r < 0) { b.y=b.r; b.vy=Math.abs(b.vy); }
    if (b.y+b.r > bubH-40) { b.y=bubH-40-b.r; b.vy=-Math.abs(b.vy); }
    if (b.age >= b.lifespan) {
      bubBubbles.splice(i,1); SFX.play('bubMiss'); bubLives--; bubCombo = 0; bubUpdateScore();
      if (bubLives <= 0) {
        bubStop(); bubRunning = false; bubDraw();
        const canvas = document.getElementById('bub-canvas'); if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillRect(0,bubH/2-35,bubW,70);
        ctx.fillStyle='#f0ede8'; ctx.font='bold 14px sans-serif'; ctx.textAlign='center';
        ctx.fillText('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞',bubW/2,bubH/2+6); ctx.textAlign='left';
        toast('ü´ß –°—á—ë—Ç: '+bubScore);
        canvas.ontouchstart = e => { e.preventDefault(); canvas.ontouchstart=null; canvas.onclick=null; bubRestart(); };
        canvas.onclick = () => { canvas.ontouchstart=null; canvas.onclick=null; bubRestart(); };
        return;
      }
    }
  }
}

function bubDraw() {
  const canvas = document.getElementById('bub-canvas'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const accent = getAccent();
  ctx.fillStyle='#0d0d0d'; ctx.fillRect(0,0,bubW,bubH);

  for (const b of bubBubbles) {
    // ‚îÄ‚îÄ –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–ø–∞–Ω—å—è ‚îÄ‚îÄ
    if (b.popped) {
      const t = Math.min(b.popTime / 520, 1);
      const ease = 1 - Math.pow(1 - t, 2);
      // –†–∞—Å—Ö–æ–¥—è—â–µ–µ—Å—è –∫–æ–ª—å—Ü–æ
      const ringR = b.r * (1 + ease * 1.3);
      ctx.globalAlpha = (1 - ease) * 0.9;
      ctx.strokeStyle = b.color;
      ctx.lineWidth = 2.8 * (1 - ease) + 0.5;
      ctx.shadowColor = b.color; ctx.shadowBlur = 12 * (1 - ease);
      ctx.beginPath(); ctx.arc(b.x, b.y, ringR, 0, Math.PI * 2); ctx.stroke();
      ctx.shadowBlur = 0;
      // –ë—Ä—ã–∑–≥–∏
      for (let i = 0; i < 8; i++) {
        const ang = (i / 8) * Math.PI * 2 + (b.wobble || 0);
        const dist = b.r * (0.3 + ease * 1.6);
        const dropR = Math.max(0.5, (1 - ease) * b.r * 0.26 + 1);
        ctx.globalAlpha = Math.max(0, (1 - ease) * 0.9);
        ctx.fillStyle = b.color;
        ctx.shadowColor = b.color; ctx.shadowBlur = 4;
        ctx.beginPath(); ctx.arc(b.x + Math.cos(ang)*dist, b.y + Math.sin(ang)*dist, dropR, 0, Math.PI*2); ctx.fill();
      }
      ctx.shadowBlur = 0; ctx.globalAlpha = 1;
      continue;
    }

    // ‚îÄ‚îÄ –ü–æ—è–≤–ª–µ–Ω–∏–µ —Å —É–ø—Ä—É–≥–∏–º –æ—Ç—Å–∫–æ–∫–æ–º ‚îÄ‚îÄ
    const spawnT = Math.min(b.spawnT || 0, 1);
    let spawnScale;
    if (spawnT < 1) {
      const c2 = (2 * Math.PI) / 3;
      spawnScale = spawnT === 0 ? 0 : Math.pow(2, -8 * spawnT) * Math.sin((spawnT * 8 - 0.75) * c2) + 1;
    } else { spawnScale = 1; }

    // ‚îÄ‚îÄ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è/–∏—Å—á–µ–∑–∞–Ω–∏—è ‚îÄ‚îÄ
    const ageFrac = b.age / b.lifespan;
    const fadeIn = Math.min(1, b.age / 180);
    const fadeOut = ageFrac > 0.78 ? 1 - Math.pow((ageFrac - 0.78) / 0.22, 2) * 0.3 : 1;
    const alpha = fadeIn * fadeOut;

    // ‚îÄ‚îÄ –ü–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ ‚îÄ‚îÄ
    const wob = Math.sin(b.wobble || 0) * 0.035;
    const drawR = b.r * spawnScale;

    ctx.save();
    ctx.translate(b.x, b.y);
    ctx.scale(1 + wob, 1 - wob);
    ctx.globalAlpha = Math.max(0.04, alpha);

    // –¢–µ–ª–æ
    ctx.shadowColor = b.color; ctx.shadowBlur = drawR * 0.5;
    ctx.beginPath(); ctx.arc(0, 0, drawR, 0, Math.PI*2);
    const grad = ctx.createRadialGradient(-drawR*0.28, -drawR*0.3, drawR*0.04, 0, 0, drawR);
    grad.addColorStop(0, b.color + '55');
    grad.addColorStop(0.55, b.color + '18');
    grad.addColorStop(1, b.color + '88');
    ctx.fillStyle = grad; ctx.fill(); ctx.shadowBlur = 0;
    // –û–±–≤–æ–¥–∫–∞
    ctx.strokeStyle = b.color + 'cc'; ctx.lineWidth = 1.8; ctx.stroke();
    // –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–∏–∫
    ctx.fillStyle = 'rgba(255,255,255,0.40)';
    ctx.beginPath(); ctx.ellipse(-drawR*0.25, -drawR*0.28, drawR*0.26, drawR*0.13, -Math.PI/4, 0, Math.PI*2); ctx.fill();
    // –í—Ç–æ—Ä–∏—á–Ω—ã–π –±–ª–∏–∫
    ctx.fillStyle = 'rgba(255,255,255,0.14)';
    ctx.beginPath(); ctx.ellipse(drawR*0.2, drawR*0.25, drawR*0.1, drawR*0.055, Math.PI/5, 0, Math.PI*2); ctx.fill();

    ctx.restore();

    // –ü—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if (ageFrac > 0.65) {
      const warn = (ageFrac - 0.65) / 0.35;
      const pulse = 0.5 + 0.5 * Math.sin(b.age * 0.018);
      ctx.globalAlpha = warn * pulse * 0.8;
      ctx.strokeStyle = `rgba(255,80,80,1)`;
      ctx.lineWidth = 1.5 + warn * 2;
      ctx.shadowColor = 'rgba(255,60,60,0.8)'; ctx.shadowBlur = 8 * warn;
      ctx.beginPath(); ctx.arc(b.x, b.y, drawR + 4 + warn * 3, 0, Math.PI*2); ctx.stroke();
      ctx.shadowBlur = 0;
    }
    ctx.globalAlpha = 1;
  }

  // HUD
  ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(0,bubH-38,bubW,38);
  ctx.font=`700 12px "JetBrains Mono",monospace`;
  ctx.fillStyle=accent; ctx.textAlign='left'; ctx.fillText('Lv'+bubLevel,8,bubH-12);
  if (bubCombo>1) {
    ctx.fillStyle='#f5c518'; ctx.textAlign='center';
    ctx.fillText('x'+bubCombo+' –ö–û–ú–ë–û!',bubW/2,bubH-12);
  }
  const hearts='‚ù§Ô∏è'.repeat(Math.max(0,bubLives))+'üñ§'.repeat(Math.max(0,3-bubLives));
  ctx.fillStyle='rgba(255,255,255,0.75)'; ctx.textAlign='right';
  ctx.fillText(hearts,bubW-6,bubH-12); ctx.textAlign='left';
}

function bubUpdateScore() {
  const el=document.getElementById('bub-score-label'); if(!el) return;
  const hearts='‚ù§Ô∏è'.repeat(Math.max(0,bubLives))+'üñ§'.repeat(Math.max(0,3-bubLives));
  el.textContent='–°—á—ë—Ç: '+bubScore+' ‚Ä¢ –†–µ–∫–æ—Ä–¥: '+bubHi+' ‚Ä¢ '+hearts;
}

// ‚ïê‚ïê –°–ï–ö–†–ï–¢–ù–´–ï –≠–§–§–ï–ö–¢–´ ‚ïê‚ïê

// ‚îÄ‚îÄ üü© –ú–ê–¢–†–ò–¶–ê ‚îÄ‚îÄ
let _matrixRaf=null,_matrixRunning=false;
function matrixStart(){
  const c=document.getElementById('matrix-canvas');
  if(!c)return;
  _matrixRunning=true;
  c.width=window.innerWidth;c.height=window.innerHeight;
  c.classList.add('active');
  const ctx=c.getContext('2d');
  const cols=Math.ceil(c.width/18); // —á—É—Ç—å —Ä–µ–∂–µ —Å—Ç–æ–ª–±—Ü–æ–≤
  const drops=Array(cols).fill(1);
  const chars='„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥01„Ç¢BCabc„Çµ„Ç∑„Çπ„Çª„ÇΩ9EF„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä';
  const accent=getAccent();
  let _lastMatT=0;
  function draw(t){
    if(!_matrixRunning)return;
    if(t-_lastMatT<38){_matrixRaf=requestAnimationFrame(draw);return;} // ~26fps
    _lastMatT=t;
    ctx.fillStyle='rgba(0,0,0,.1)';ctx.fillRect(0,0,c.width,c.height);
    ctx.font='13px monospace';
    drops.forEach((y,i)=>{
      const ch=chars[Math.floor(Math.random()*chars.length)];
      ctx.fillStyle=i%8===0?'#fff':accent;
      ctx.fillText(ch,i*18,y*16);
      if(y*16>c.height&&Math.random()>.97)drops[i]=0;
      drops[i]++;
    });
    _matrixRaf=requestAnimationFrame(draw);
  }
  cancelAnimationFrame(_matrixRaf);
  requestAnimationFrame(draw);
}
function matrixStop(){
  _matrixRunning=false;cancelAnimationFrame(_matrixRaf);
  const c=document.getElementById('matrix-canvas');
  if(c){c.classList.remove('active');setTimeout(()=>{const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);},500);}
}

// ‚îÄ‚îÄ ‚ùÑÔ∏è –°–ù–ï–ì ‚îÄ‚îÄ
let _snowRaf=null,_snowRunning=false,_snowFlakes=[];
function snowStart(){
  const c=document.getElementById('snow-canvas');
  if(!c)return;
  _snowRunning=true;c.style.display='';
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º
  const sec=loadSecret();sec.snow=true;saveSecret(sec);
  c.width=window.innerWidth;c.height=window.innerHeight;
  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: 50 —Å–Ω–µ–∂–∏–Ω–æ–∫ –≤–º–µ—Å—Ç–æ 80, —Å throttle –Ω–∞ 30fps
  const flakeCount=Math.min(50,Math.round(window.innerWidth/8));
  _snowFlakes=Array.from({length:flakeCount},()=>({
    x:Math.random()*c.width,y:Math.random()*c.height,
    r:.8+Math.random()*2.5,vy:.3+Math.random()*.9,vx:(Math.random()-.5)*.4,
    op:.35+Math.random()*.5
  }));
  const ctx=c.getContext('2d');
  let _lastSnowT=0;
  function draw(t){
    if(!_snowRunning)return;
    // Throttle: ~30fps –º–∞–∫—Å–∏–º—É–º
    if(t-_lastSnowT<28){_snowRaf=requestAnimationFrame(draw);return;}
    _lastSnowT=t;
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle='rgba(255,255,255,0.7)';
    ctx.beginPath();
    _snowFlakes.forEach(f=>{
      ctx.moveTo(f.x+f.r,f.y);
      ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      f.y+=f.vy;f.x+=f.vx;
      if(f.y>c.height){f.y=-5;f.x=Math.random()*c.width;}
      if(f.x<0)f.x=c.width;if(f.x>c.width)f.x=0;
    });
    ctx.fill();
    _snowRaf=requestAnimationFrame(draw);
  }
  cancelAnimationFrame(_snowRaf);requestAnimationFrame(draw);
}
function snowStop(){
  _snowRunning=false;cancelAnimationFrame(_snowRaf);
  const c=document.getElementById('snow-canvas');
  if(c)c.style.display='none';
  const sec=loadSecret();delete sec.snow;saveSecret(sec);
}

// ‚îÄ‚îÄ üï∫ –î–ò–°–ö–û ‚Äî —á–∏—Å—Ç—ã–π RGB –±–µ–∑ —Å–º–µ–Ω—ã —Ç–µ–º ‚îÄ‚îÄ
// _discoActive –æ–±—ä—è–≤–ª–µ–Ω –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
function discoStart(){
  _discoActive=true;
  document.body.classList.add('disco-mode');
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const sec=loadSecret();sec.disco=true;saveSecret(sec);
}
function discoStop(){
  _discoActive=false;
  document.body.classList.remove('disco-mode');
  const sec=loadSecret();delete sec.disco;saveSecret(sec);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üê¶ –§–õ–ê–ü–ü–ò –ü–¢–ò–¶–ê (v2.6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let flappyRaf=null,flappyRunning=false,flappyStarted=false;
let flappyW=0,flappyH=0,flappyScore=0,flappyHi=0;
let flappyBird={x:0,y:0,vy:0,r:14};
const FLAPPY_GRAVITY=0.38,FLAPPY_JUMP=-7.2,FLAPPY_PIPE_W=52,FLAPPY_GAP=140,FLAPPY_SPEED=2.4;
let flappyPipes=[];
let flappyFrames=0;

function flappyInit(){
  flappyHi=getHi('flappy');
  const canvas=document.getElementById('flappy-canvas');
  flappyW=Math.min(window.innerWidth-36,360);
  flappyH=Math.round(flappyW*1.45);
  canvas.width=flappyW; canvas.height=flappyH;
  canvas.ontouchstart=e=>{e.preventDefault();flappyFlap();};
  canvas.onclick=flappyFlap;
  document.addEventListener('keydown',flappyKeyDown);
  flappyRestart();
}
function flappyKeyDown(e){if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault();flappyFlap();}}
function flappyStop(){
  flappyRunning=false;cancelAnimationFrame(flappyRaf);
  document.removeEventListener('keydown',flappyKeyDown);
}
function flappyFlap(){
  if(!flappyStarted){flappyStarted=true;}
  flappyBird.vy=FLAPPY_JUMP;
  SFX.play('pongHit');
}
function flappyRestart(){
  flappyScore=0; flappyStarted=false;
  flappyBird={x:flappyW*0.28,y:flappyH*0.45,vy:0,r:14};
  flappyPipes=[]; flappyFrames=0;
  flappyRunning=true;
  cancelAnimationFrame(flappyRaf);
  flappyRaf=requestAnimationFrame(flappyLoop);
  flappyUpdateScore();
}
function flappySpawnPipe(){
  const minY=80,maxY=flappyH-FLAPPY_GAP-80;
  const topH=minY+Math.random()*(maxY-minY);
  flappyPipes.push({x:flappyW,topH,passed:false});
}
function flappyLoop(){
  if(!flappyRunning)return;
  const canvas=document.getElementById('flappy-canvas');
  if(!canvas){flappyRunning=false;return;}
  if(flappyStarted){
    flappyBird.vy+=FLAPPY_GRAVITY;
    flappyBird.y+=flappyBird.vy;
    flappyFrames++;
    if(flappyFrames%90===0)flappySpawnPipe();
    for(let p of flappyPipes){p.x-=FLAPPY_SPEED;}
    flappyPipes=flappyPipes.filter(p=>p.x>-FLAPPY_PIPE_W-10);
    // Score
    for(let p of flappyPipes){
      if(!p.passed&&p.x+FLAPPY_PIPE_W<flappyBird.x){p.passed=true;flappyScore++;flappyUpdateScore();SFX.play('pongScore');}
    }
    // Collision
    const b=flappyBird;
    if(b.y+b.r>flappyH||b.y-b.r<0){flappyDie();return;}
    for(let p of flappyPipes){
      const inX=b.x+b.r>p.x&&b.x-b.r<p.x+FLAPPY_PIPE_W;
      if(inX&&(b.y-b.r<p.topH||b.y+b.r>p.topH+FLAPPY_GAP)){flappyDie();return;}
    }
  }
  flappyDraw(canvas);
  flappyRaf=requestAnimationFrame(flappyLoop);
}
function flappyDie(){
  flappyRunning=false;
  if(flappyScore>flappyHi)flappyHi=saveHi('flappy',flappyScore);
  flappyUpdateScore();
  const canvas=document.getElementById('flappy-canvas');
  flappyDraw(canvas);
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(0,flappyH/2-44,flappyW,88);
  ctx.fillStyle='#f0ede8';ctx.font='bold 16px sans-serif';ctx.textAlign='center';
  ctx.fillText('üí• –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!',flappyW/2,flappyH/2-12);
  ctx.fillText('–¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞',flappyW/2,flappyH/2+16);
  canvas.onclick=()=>{canvas.onclick=null;canvas.ontouchstart=e=>{e.preventDefault();flappyFlap();};canvas.onclick=flappyFlap;flappyRestart();};
  canvas.ontouchstart=e=>{e.preventDefault();canvas.ontouchstart=null;canvas.onclick=null;canvas.onclick=flappyFlap;canvas.ontouchstart=e2=>{e2.preventDefault();flappyFlap();};flappyRestart();};
}
function flappyDraw(canvas){
  const ctx=canvas.getContext('2d');
  const accent=getAccent();
  // Sky
  const skyGrad=ctx.createLinearGradient(0,0,0,flappyH);
  skyGrad.addColorStop(0,'#0d1b2a');skyGrad.addColorStop(1,'#162032');
  ctx.fillStyle=skyGrad;ctx.fillRect(0,0,flappyW,flappyH);
  // Ground
  ctx.fillStyle='#2a1f0e';ctx.fillRect(0,flappyH-24,flappyW,24);
  ctx.fillStyle='#3d2e14';ctx.fillRect(0,flappyH-24,flappyW,4);
  // Pipes
  for(const p of flappyPipes){
    const grad=ctx.createLinearGradient(p.x,0,p.x+FLAPPY_PIPE_W,0);
    grad.addColorStop(0,'#2d6a2d');grad.addColorStop(0.5,'#3e9e3e');grad.addColorStop(1,'#2d6a2d');
    ctx.fillStyle=grad;
    ctx.fillRect(p.x,0,FLAPPY_PIPE_W,p.topH);
    ctx.fillRect(p.x,p.topH+FLAPPY_GAP,FLAPPY_PIPE_W,flappyH-p.topH-FLAPPY_GAP);
    // Pipe caps
    ctx.fillStyle='#4ab84a';
    ctx.fillRect(p.x-4,p.topH-18,FLAPPY_PIPE_W+8,18);
    ctx.fillRect(p.x-4,p.topH+FLAPPY_GAP,FLAPPY_PIPE_W+8,18);
  }
  // Bird
  const b=flappyBird;
  const angle=Math.min(Math.PI/4,Math.max(-Math.PI/5,b.vy*0.05));
  ctx.save();ctx.translate(b.x,b.y);ctx.rotate(angle);
  // Body
  ctx.shadowColor=accent;ctx.shadowBlur=12;
  ctx.fillStyle=accent;ctx.beginPath();ctx.ellipse(0,0,b.r,b.r*0.85,0,0,Math.PI*2);ctx.fill();
  // Eye
  ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(b.r*0.4,-b.r*0.2,b.r*0.32,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#222';ctx.beginPath();ctx.arc(b.r*0.5,-b.r*0.15,b.r*0.15,0,Math.PI*2);ctx.fill();
  // Wing
  ctx.fillStyle=accent+'bb';ctx.beginPath();ctx.ellipse(-b.r*0.2,b.r*0.1,b.r*0.55,b.r*0.3,flappyStarted?Math.sin(flappyFrames*0.3)*0.4:0,0,Math.PI*2);ctx.fill();
  // Beak
  ctx.fillStyle='#f5a623';ctx.beginPath();ctx.moveTo(b.r*0.7,0);ctx.lineTo(b.r*1.3,b.r*0.15);ctx.lineTo(b.r*0.7,b.r*0.3);ctx.closePath();ctx.fill();
  ctx.restore();
  // Score HUD
  ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(0,0,flappyW,38);
  ctx.fillStyle='#f0ede8';ctx.font='bold 20px sans-serif';ctx.textAlign='center';
  ctx.fillText(flappyScore,flappyW/2,26);
  if(!flappyStarted){
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(0,flappyH/2-30,flappyW,60);
    ctx.fillStyle='#f0ede8';ctx.font='bold 15px sans-serif';ctx.textAlign='center';
    ctx.fillText('üê¶ –¢–∞–ø–Ω–∏ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!',flappyW/2,flappyH/2+7);
  }
}
function flappyUpdateScore(){
  const el=document.getElementById('flappy-score-label');if(!el)return;
  el.textContent='–°—á—ë—Ç: '+flappyScore+' ‚Ä¢ –†–µ–∫–æ—Ä–¥: '+flappyHi;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ üî¢ 2048 (v2.6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const G2048_COLORS={0:'#1f1f1f',2:'#3a3a3a',4:'#4a3820',8:'#7c4010',16:'#a04a10',32:'#c45a0a',
  64:'#e07020',128:'#d4a020',256:'#c8b030',512:'#b0c040',1024:'#60b060',2048:'#30a030'};
const G2048_TC={0:'#555',2:'#ccc',4:'#ddb',8:'#fff',16:'#fff',32:'#fff',64:'#fff',
  128:'#fff',256:'#fff',512:'#fff',1024:'#fff',2048:'#fff'};
let g2048Grid=[],g2048Score=0,g2048Hi=0,g2048Over=false;
let g2048SwX=0,g2048SwY=0;

function g2048Init(){
  g2048Hi=getHi('2048');
  g2048Restart();
  const board=document.getElementById('g2048-board');
  board.ontouchstart=e=>{e.preventDefault();g2048SwX=e.touches[0].clientX;g2048SwY=e.touches[0].clientY;};
  board.ontouchend=e=>{
    e.preventDefault();
    const dx=e.changedTouches[0].clientX-g2048SwX,dy=e.changedTouches[0].clientY-g2048SwY;
    if(Math.abs(dx)<20&&Math.abs(dy)<20)return;
    if(Math.abs(dx)>Math.abs(dy))g2048Move(dx>0?'right':'left');
    else g2048Move(dy>0?'down':'up');
  };
  document.addEventListener('keydown',g2048Key);
}
function g2048Key(e){
  const map={'ArrowLeft':'left','ArrowRight':'right','ArrowUp':'up','ArrowDown':'down'};
  if(map[e.key]){e.preventDefault();g2048Move(map[e.key]);}
}
function g2048Stop(){document.removeEventListener('keydown',g2048Key);}
function g2048Restart(){
  g2048Grid=Array(4).fill(null).map(()=>Array(4).fill(0));
  g2048Score=0;g2048Over=false;
  g2048Spawn();g2048Spawn();
  g2048Render();g2048UpdateScore();
}
function g2048Spawn(){
  const empty=[];
  for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(g2048Grid[r][c]===0)empty.push([r,c]);
  if(!empty.length)return;
  const [r,c]=empty[Math.floor(Math.random()*empty.length)];
  g2048Grid[r][c]=Math.random()<0.9?2:4;
}
function g2048Slide(row){
  let a=row.filter(v=>v);
  for(let i=0;i<a.length-1;i++){if(a[i]===a[i+1]){a[i]*=2;g2048Score+=a[i];a.splice(i+1,1);i++;}}
  while(a.length<4)a.push(0);
  return a;
}
function g2048Move(dir){
  if(g2048Over)return;
  let changed=false;
  const prev=g2048Grid.map(r=>[...r]);
  if(dir==='left'){for(let r=0;r<4;r++){const n=g2048Slide(g2048Grid[r]);if(n.join()!==g2048Grid[r].join()){g2048Grid[r]=n;changed=true;}}}
  else if(dir==='right'){for(let r=0;r<4;r++){const n=g2048Slide([...g2048Grid[r]].reverse()).reverse();if(n.join()!==g2048Grid[r].join()){g2048Grid[r]=n;changed=true;}}}
  else if(dir==='up'){for(let c=0;c<4;c++){const col=[0,1,2,3].map(r=>g2048Grid[r][c]);const n=g2048Slide(col);n.forEach((v,r)=>{if(v!==g2048Grid[r][c]){g2048Grid[r][c]=v;changed=true;}});}}
  else if(dir==='down'){for(let c=0;c<4;c++){const col=[0,1,2,3].map(r=>g2048Grid[r][c]);const n=g2048Slide([...col].reverse()).reverse();n.forEach((v,r)=>{if(v!==g2048Grid[r][c]){g2048Grid[r][c]=v;changed=true;}});}}
  if(changed){
    if(g2048Score>g2048Hi)g2048Hi=saveHi('2048',g2048Score);
    g2048Spawn();g2048Render();g2048UpdateScore();SFX.play('pongHit');
    // Check game over
    const hasMoves=g2048Grid.some((row,r)=>row.some((v,c)=>{
      if(v===0)return true;
      if(c<3&&v===g2048Grid[r][c+1])return true;
      if(r<3&&v===g2048Grid[r+1][c])return true;
      return false;
    }));
    if(!hasMoves){g2048Over=true;toast('üî¢ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! '+g2048Score+' –æ—á–∫–æ–≤');}
  }
}
function g2048Render(){
  const board=document.getElementById('g2048-board');if(!board)return;
  board.innerHTML='';
  const cellSize=Math.floor((Math.min(300,window.innerWidth*0.85)-3*8)/4);
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const v=g2048Grid[r][c];
    const cell=document.createElement('div');
    const bg=G2048_COLORS[Math.min(v,2048)]||'#208020';
    const tc=G2048_TC[Math.min(v,2048)]||'#fff';
    const fs=v<100?22:v<1000?17:13;
    cell.style.cssText=`width:${cellSize}px;height:${cellSize}px;border-radius:8px;background:${bg};
      display:flex;align-items:center;justify-content:center;
      font-family:'JetBrains Mono',monospace;font-size:${fs}px;font-weight:800;color:${tc};
      transition:background .12s;box-shadow:0 2px 8px rgba(0,0,0,.3);`;
    cell.textContent=v||'';
    board.appendChild(cell);
  }
}
function g2048UpdateScore(){
  const el=document.getElementById('g2048-score-label');if(!el)return;
  el.textContent='–°—á—ë—Ç: '+g2048Score+' ‚Ä¢ –†–µ–∫–æ—Ä–¥: '+g2048Hi;
}
</script>